<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjTraceManager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjTraceManager.cpp</h1><a href="_dbj_trace_manager_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2004                                                              *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="_dbj_trace_manager_8hpp.html">DbjTraceManager.hpp</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="_dbj_string_8hpp.html">DbjString.hpp</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="_dbj_error_8hpp.html">DbjError.hpp</a>"</span>
00014 
00015 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>     <span class="comment">// getenv()</span>
00016 <span class="preprocessor">#include &lt;ctype.h&gt;</span>      <span class="comment">// isprint()</span>
00017 
00018 
00019 <span class="comment">// Instanz-Variable des Trace Managers</span>
<a name="l00020"></a><a class="code" href="class_dbj_trace_manager.html#v0">00020</a> <a class="code" href="class_dbj_trace_manager.html">DbjTraceManager</a> *<a class="code" href="class_dbj_trace_manager.html#v0">DbjTraceManager::instance</a> = NULL;
00021 <span class="comment">// Definition der Einruecktiefe</span>
<a name="l00022"></a><a class="code" href="class_dbj_trace_manager.html#s0">00022</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> <a class="code" href="class_dbj_trace_manager.html#s0">DbjTraceManager::TRACE_INDENT_STEP</a> = 4;
00023 
00024 
00025 <span class="comment">// Konstruktor</span>
<a name="l00026"></a><a class="code" href="class_dbj_trace_manager.html#d0">00026</a> <a class="code" href="class_dbj_trace_manager.html#d0">DbjTraceManager::DbjTraceManager</a>()
00027     : traceFile(NULL), performanceFile(NULL), indent(0),
00028       performanceInfo(), traceMask(0), traceFlush(false)
00029 {
00030     <span class="keywordtype">char</span> <span class="keyword">const</span> *file = getenv(<span class="stringliteral">"DBJ_TRACE_FILE"</span>);
00031     <span class="keywordflow">if</span> (file != NULL &amp;&amp; *file != <span class="charliteral">'\0'</span>) {
00032         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(file, <span class="stringliteral">"stdout"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00033             <a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> = stdout;
00034         }
00035         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(file, <span class="stringliteral">"stderr"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00036             <a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> = stderr;
00037         }
00038         <span class="keywordflow">else</span> {
00039             <a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> = fopen(file, <span class="stringliteral">"wb"</span>);
00040         }
00041         <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>) {
00042             <span class="keywordflow">return</span>;
00043         }
00044     }
00045 
00046     file = getenv(<span class="stringliteral">"DBJ_PERF_FILE"</span>);
00047     <span class="keywordflow">if</span> (file != NULL &amp;&amp; *file != <span class="charliteral">'\0'</span>) {
00048         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(file, <span class="stringliteral">"stdout"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00049             <a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> = stdout;
00050         }
00051         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(file, <span class="stringliteral">"stderr"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00052             <a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> = stderr;
00053         }
00054         <span class="keywordflow">else</span> {
00055             <a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> = fopen(file, <span class="stringliteral">"wb"</span>);
00056         }
00057         <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a>) {
00058             <span class="keywordflow">return</span>;
00059         }
00060     }
00061 
00062     <span class="keywordtype">char</span> <span class="keyword">const</span> *mask = getenv(<span class="stringliteral">"DBJ_TRACE_MASK"</span>);
00063     <span class="keywordflow">while</span> (mask != NULL &amp;&amp; *mask != <span class="charliteral">'\0'</span>) {
00064         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"CommandLine"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a> ||
00065                 <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"clp"</span>, 3) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00066             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 0);
00067         }
00068         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Compiler"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00069             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 1);
00070         }
00071         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Optimizer"</span>, 3) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00072             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 2);
00073         }
00074         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Catalog"</span>, 3) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00075             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 3);
00076         }
00077         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"RunTime"</span>, 3) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00078             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 4);
00079         }
00080         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Record"</span>, 3) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00081             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 5);
00082         }
00083         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Index"</span>, 3) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00084             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 6);
00085         }
00086         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Lock"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00087             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 7);
00088         }
00089         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Buffer"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00090             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 8);
00091         }
00092         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"File"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00093             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 9);
00094         }
00095         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(mask, <span class="stringliteral">"Support"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00096             <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> |= (1 &lt;&lt; 10);
00097         }
00098 
00099         <span class="comment">// suche nach weiterer Komponenten-Angabe</span>
00100         mask = strchr(mask, <span class="charliteral">','</span>);
00101         <span class="keywordflow">if</span> (mask) {
00102             mask++;
00103         }
00104     }
00105 
00106     <span class="keywordtype">char</span> <span class="keyword">const</span> *flush = getenv(<span class="stringliteral">"DBJ_TRACE_FLUSH"</span>);
00107     <span class="keywordflow">if</span> (flush &amp;&amp; *flush != <span class="charliteral">'\0'</span> &amp;&amp; *flush != <span class="charliteral">'0'</span>) {
00108         <a class="code" href="class_dbj_trace_manager.html#r5">traceFlush</a> = <span class="keyword">true</span>;
00109     }
00110 }
00111 
00112 
00113 <span class="comment">// Destruktor</span>
<a name="l00114"></a><a class="code" href="class_dbj_trace_manager.html#d1">00114</a> <a class="code" href="class_dbj_trace_manager.html#d1">DbjTraceManager::~DbjTraceManager</a>()
00115 {
00116     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> != NULL) {
00117         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> != stdout &amp;&amp; <a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> != stderr) {
00118             fclose(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>);
00119         }
00120         <a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> = NULL;
00121     }
00122     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> != NULL) {
00123         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> != stdout &amp;&amp; <a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> != stderr) {
00124             fclose(<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a>);
00125         }
00126         <a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> = NULL;
00127     }
00128     <a class="code" href="class_dbj_trace_manager.html#r3">performanceInfo</a>.clear();
00129 }
00130 
00131 
00132 <span class="comment">// Behandle Beginn einer Funktion/Methode</span>
<a name="l00133"></a><a class="code" href="class_dbj_trace_manager.html#a2">00133</a> <span class="keywordtype">void</span> <a class="code" href="class_dbj_trace_manager.html#a2">DbjTraceManager::writeStartOfFunction</a>(<span class="keywordtype">char</span> <span class="keyword">const</span> *functionName)
00134 {
00135     <span class="comment">// schreibe Trace Record Header</span>
00136     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> != NULL) {
00137         fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * <a class="code" href="class_dbj_trace_manager.html#r2">indent</a>, <span class="stringliteral">""</span>);
00138         fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"+ Function: %s\n"</span>, functionName);
00139         indent++;
00140     }
00141 
00142     <span class="comment">// sammle Performance-Trace Informationen pro Funktion</span>
00143     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> != NULL) {
00144         <a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html">PerFunctionTimings</a> &amp;timings = <a class="code" href="class_dbj_trace_manager.html#r3">performanceInfo</a>[functionName];
00145         timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o0">numCalled</a>++;
00146         timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o1">nestingLevel</a>++;
00147         <span class="keywordflow">if</span> (timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o1">nestingLevel</a> == 1) {
00148             <span class="keywordflow">if</span> (timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o0">numCalled</a> == 1) {
00149                 <span class="comment">// im allerersten Aufruf muessen wir die Zeitmessung</span>
00150                 <span class="comment">// fuer die Funktion auf 0 setzen</span>
00151                 timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o2">totalTime</a>.<a class="code" href="struct_dbj_trace_manager_1_1_time_value.html#a5">setZero</a>();
00152             }
00153             <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">TimeValue</a> currentTime;
00154             timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o3">entryTime</a> = currentTime;
00155         }
00156     }
00157     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r5">traceFlush</a>) {
00158         fflush(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>);
00159     }
00160 }
00161 
00162 
00163 <span class="comment">// Behandle Ende einer Funktion/Methode (weniger Einrueckung)</span>
<a name="l00164"></a><a class="code" href="class_dbj_trace_manager.html#a3">00164</a> <span class="keywordtype">void</span> <a class="code" href="class_dbj_trace_manager.html#a3">DbjTraceManager::writeEndOfFunction</a>(<span class="keywordtype">char</span> <span class="keyword">const</span> *functionName)
00165 {
00166     <span class="comment">// sammle Performance-Trace Informationen pro Funktion</span>
00167     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> != NULL) {
00168         <a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html">PerFunctionTimings</a> &amp;timings = <a class="code" href="class_dbj_trace_manager.html#r3">performanceInfo</a>[functionName];
00169         timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o1">nestingLevel</a>--;
00170         <span class="keywordflow">if</span> (timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o1">nestingLevel</a> == 0) {
00171             <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">TimeValue</a> currentTime;
00172             timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o2">totalTime</a> += currentTime - timings.<a class="code" href="struct_dbj_trace_manager_1_1_per_function_timings.html#o3">entryTime</a>;
00173 
00174             <span class="comment">// schreibe Performance Info am Ende der "main" Funktion</span>
00175             <span class="keywordflow">if</span> ((*functionName == <span class="charliteral">'i'</span> &amp;&amp; <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(functionName,
00176                          <span class="stringliteral">"int main"</span>, 8) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) ||
00177                     (*functionName == <span class="charliteral">'m'</span> &amp;&amp; <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(functionName,
00178                             <span class="stringliteral">"main"</span>, 4) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>)) {
00179                 <a class="code" href="class_dbj_trace_manager.html#d3">dumpPerformanceInfo</a>();
00180             }
00181         }
00182     }
00183 
00184     <span class="comment">// schreibe Trace Record Header</span>
00185     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> != NULL) {
00186         <a class="code" href="class_dbj_trace_manager.html#r2">indent</a>--;
00187         fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * <a class="code" href="class_dbj_trace_manager.html#r2">indent</a>, <span class="stringliteral">""</span>);
00188         fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"- Function: %s"</span>, functionName);
00189         <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00190             fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">" (Error code: %d)\n"</span>,
00191                     static_cast&lt;int&gt;(<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>()));
00192         }
00193         <span class="keywordflow">else</span> {
00194             fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"\n"</span>);
00195         }
00196     }
00197     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r5">traceFlush</a>) {
00198         fflush(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>);
00199     }
00200 }
00201 
00202 
00203 <span class="comment">// Schreibe Trace Record mit String-Daten</span>
<a name="l00204"></a><a class="code" href="class_dbj_trace_manager.html#a0">00204</a> <span class="keywordtype">void</span> <a class="code" href="class_dbj_trace_manager.html#a0">DbjTraceManager::writeTraceRecord</a>(
00205         <span class="keywordtype">char</span> <span class="keyword">const</span> *functionName, <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> <span class="keyword">const</span> tracePoint,
00206         <span class="keywordtype">char</span> <span class="keyword">const</span> *description, <span class="keywordtype">char</span> <span class="keyword">const</span> *traceData)
00207 {
00208     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> == NULL) {
00209         <span class="keywordflow">return</span>;
00210     }
00211 
00212     <span class="comment">// schreibe Trace Daten</span>
00213     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * <a class="code" href="class_dbj_trace_manager.html#r2">indent</a>, <span class="stringliteral">""</span>);
00214     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%s (Probe "</span> <a class="code" href="group__string__def.html#ga8">DBJ_FORMAT_UINT16</a> <span class="stringliteral">"): %s = %s\n"</span>,
00215             functionName, tracePoint, description, traceData);
00216     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r5">traceFlush</a>) {
00217         fflush(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>);
00218     }
00219 }
00220 
00221 
00222 <span class="comment">// Schreibe Trace Record mit Binaerdaten</span>
<a name="l00223"></a><a class="code" href="class_dbj_trace_manager.html#a1">00223</a> <span class="keywordtype">void</span> <a class="code" href="class_dbj_trace_manager.html#a0">DbjTraceManager::writeTraceRecord</a>(
00224         <span class="keywordtype">char</span> <span class="keyword">const</span> *functionName, <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> <span class="keyword">const</span> tracePoint,
00225         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> <span class="keyword">const</span> data1Length, <span class="keywordtype">void</span> <span class="keyword">const</span> *data1Ptr,
00226         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> <span class="keyword">const</span> data2Length, <span class="keywordtype">void</span> <span class="keyword">const</span> *data2Ptr,
00227         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> <span class="keyword">const</span> data3Length, <span class="keywordtype">void</span> <span class="keyword">const</span> *data3Ptr)
00228 {
00229     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> == NULL) {
00230         <span class="keywordflow">return</span>;
00231     }
00232 
00233     <span class="comment">// schreibe Trace Record Header</span>
00234     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * <a class="code" href="class_dbj_trace_manager.html#r2">indent</a>, <span class="stringliteral">""</span>);
00235     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"Data in Function: %s at Probe: "</span>
00236             <a class="code" href="group__string__def.html#ga8">DBJ_FORMAT_UINT16</a> <span class="stringliteral">"\n"</span>, functionName, tracePoint);
00237 
00238     <span class="comment">// schreibe erstes Datum</span>
00239     <a class="code" href="class_dbj_trace_manager.html#d2">writeBinaryData</a>(static_cast&lt;unsigned char const *&gt;(data1Ptr), data1Length);
00240     <a class="code" href="class_dbj_trace_manager.html#d2">writeBinaryData</a>(static_cast&lt;unsigned char const *&gt;(data2Ptr), data2Length);
00241     <a class="code" href="class_dbj_trace_manager.html#d2">writeBinaryData</a>(static_cast&lt;unsigned char const *&gt;(data3Ptr), data3Length);
00242     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r5">traceFlush</a>) {
00243         fflush(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>);
00244     }
00245 }
00246 
00247 
00248 <span class="comment">// Formatiere und schreibe Binaerdaten</span>
<a name="l00249"></a><a class="code" href="class_dbj_trace_manager.html#d2">00249</a> <span class="keywordtype">void</span> <a class="code" href="class_dbj_trace_manager.html#d2">DbjTraceManager::writeBinaryData</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <span class="keyword">const</span> *data,
00250         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> <span class="keyword">const</span> length)
00251 {
00252     <span class="comment">// nichts zu tracen</span>
00253     <span class="keywordflow">if</span> (data == NULL) {
00254         <span class="keywordflow">return</span>;
00255     }
00256 
00257     <span class="comment">// schreibe Laengenangabe</span>
00258     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * <a class="code" href="class_dbj_trace_manager.html#r2">indent</a>, <span class="stringliteral">""</span>);
00259     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"Length: "</span> <a class="code" href="group__string__def.html#ga12">DBJ_FORMAT_UINT32</a> <span class="stringliteral">" Byte(s)\n"</span>, length);
00260 
00261     <span class="comment">// konvertiere Daten Byte-fuer-Byte in Hex-Darstellung</span>
00262     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * indent, <span class="stringliteral">""</span>);
00263     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"Hexadecimal representation"</span>);
00264     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; length; i++) {
00265         <span class="comment">// schreibe immer 16 Bytes in eine Zeile</span>
00266         <span class="keywordflow">if</span> (i % 16 == 0) {
00267             fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"\n%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * indent, <span class="stringliteral">""</span>);
00268         }
00269         fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%02X "</span>, data[i]);
00270     }
00271     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"\n\n"</span>);
00272 
00273     <span class="comment">// konvertiere Daten in druckbare Characters</span>
00274     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * indent, <span class="stringliteral">""</span>);
00275     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"String representation"</span>);
00276     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; length; i++) {
00277         <span class="comment">// schreibe immer 50 Zeichen in eine Zeile</span>
00278         <span class="keywordflow">if</span> (i % 50 == 0) {
00279             fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"\n%*s"</span>, <a class="code" href="class_dbj_trace_manager.html#s0">TRACE_INDENT_STEP</a> * indent, <span class="stringliteral">""</span>);
00280         }
00281         fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"%c"</span>, isprint(data[i]) ? data[i] : <span class="charliteral">'.'</span>);
00282     }
00283     fprintf(<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a>, <span class="stringliteral">"\n\n"</span>);
00284 }
00285 
00286 
00287 <span class="comment">// Ueberpruefe ob Komponente getract werden soll</span>
<a name="l00288"></a><a class="code" href="class_dbj_trace_manager.html#a4">00288</a> <span class="keywordtype">bool</span> <a class="code" href="class_dbj_trace_manager.html#a4">DbjTraceManager::isComponentActive</a>(DbjComponent <span class="keyword">const</span> component)<span class="keyword"> const</span>
00289 <span class="keyword"></span>{
00290     <span class="comment">// ohne Trace File geht nix</span>
00291     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r0">traceFile</a> == NULL &amp;&amp; <a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a> == NULL) {
00292         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00293     }
00294 
00295     <span class="comment">// keine Maske gesetzt - trace alles</span>
00296     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> == 0) {
00297         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00298     }
00299 
00300     <span class="keywordflow">switch</span> (component) {
00301       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a1">CommandLine</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 0);
00302       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a2">Compiler</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 1);
00303       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a3">Optimizer</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 2);
00304       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a4">CatalogManager</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 3);
00305       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a5">RunTime</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 4);
00306       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a6">RecordManager</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 5);
00307       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a7">IndexManager</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 6);
00308       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a8">LockManager</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 7);
00309       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a9">BufferManager</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 8);
00310       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a10">FileManager</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 9);
00311       <span class="keywordflow">case</span> <a class="code" href="_dbj_components_8hpp.html#a12a11">Support</a>: <span class="keywordflow">return</span> <a class="code" href="class_dbj_trace_manager.html#r4">traceMask</a> &amp; (1 &lt;&lt; 10);
00312     }
00313 
00314     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00315 }
00316 
00317 
00318 <span class="comment">// Schreibe Performance Trace</span>
<a name="l00319"></a><a class="code" href="class_dbj_trace_manager.html#d3">00319</a> <span class="keywordtype">void</span> <a class="code" href="class_dbj_trace_manager.html#d3">DbjTraceManager::dumpPerformanceInfo</a>()
00320 {
00321     TraceMapType::iterator iter = <a class="code" href="class_dbj_trace_manager.html#r3">performanceInfo</a>.begin();
00322 
00323     fprintf(<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a>, <span class="stringliteral">"Function timings:\n"</span>);
00324     fprintf(<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a>, <span class="stringliteral">"=================\n"</span>);
00325     <span class="keywordflow">while</span> (iter != <a class="code" href="class_dbj_trace_manager.html#r3">performanceInfo</a>.end()) {
00326         fprintf(<a class="code" href="class_dbj_trace_manager.html#r1">performanceFile</a>, <a class="code" href="group__string__def.html#ga13">DBJ_FORMAT_UINT32_WIDTH</a> <span class="stringliteral">" calls "</span>
00327                 <span class="stringliteral">"in %ld.%06ld sec to function \"%s\"\n"</span>,
00328                 10, iter-&gt;second.numCalled, iter-&gt;second.totalTime.tv_sec,
00329                 iter-&gt;second.totalTime.tv_usec, iter-&gt;first);
00330         iter++;
00331     }
00332 }
00333 
00334 
00335 <span class="comment">// Addiere zwei Zeitwerte</span>
<a name="l00336"></a><a class="code" href="struct_dbj_trace_manager_1_1_time_value.html#a1">00336</a> <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">DbjTraceManager::TimeValue</a> <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html#a1">DbjTraceManager::TimeValue::operator+</a>(
00337         <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">DbjTraceManager::TimeValue</a> <span class="keyword">const</span> &amp;addTime)<span class="keyword"> const</span>
00338 <span class="keyword"></span>{
00339     <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">DbjTraceManager::TimeValue</a> result = *<span class="keyword">this</span>;
00340     result.tv_sec += addTime.tv_sec;
00341     result.tv_usec += addTime.tv_usec;
00342     <span class="keywordflow">if</span> (result.tv_usec &gt;= 1000000) {
00343         result.tv_sec += 1;
00344         result.tv_usec -= 1000000;
00345     }
00346     <span class="keywordflow">return</span> result;
00347 }
00348 
00349 
00350 <span class="comment">// Subtrahiere zwei Zeitwerte</span>
<a name="l00351"></a><a class="code" href="struct_dbj_trace_manager_1_1_time_value.html#a2">00351</a> <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">DbjTraceManager::TimeValue</a> <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html#a2">DbjTraceManager::TimeValue::operator-</a>(
00352         <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">DbjTraceManager::TimeValue</a> <span class="keyword">const</span> &amp;subTime)<span class="keyword"> const</span>
00353 <span class="keyword"></span>{
00354     <a class="code" href="struct_dbj_trace_manager_1_1_time_value.html">DbjTraceManager::TimeValue</a> result = *<span class="keyword">this</span>;
00355     result.tv_sec -= subTime.tv_sec;
00356     result.tv_usec -= subTime.tv_usec;
00357     <span class="keywordflow">if</span> (result.tv_usec &lt; 0) {
00358         result.tv_usec += 1000000;
00359         result.tv_sec -= 1;
00360     }
00361     <span class="keywordflow">if</span> (result.tv_sec &lt; 0) {
00362         result.tv_sec = 0;
00363         result.tv_usec = 0;
00364     }
00365     <span class="keywordflow">return</span> result;
00366 }
00367 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:30 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
