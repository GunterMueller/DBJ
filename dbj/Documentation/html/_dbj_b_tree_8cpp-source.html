<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjBTree.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjBTree.cpp</h1><a href="_dbj_b_tree_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2004-2005                                                         *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="_dbj_b_tree_8hpp.html">DbjBTree.hpp</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="_dbj_buffer_manager_8hpp.html">DbjBufferManager.hpp</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="_dbj_lock_manager_8hpp.html">DbjLockManager.hpp</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="_dbj_b_tree_iterator_8hpp.html">DbjBTreeIterator.hpp</a>"</span>
00015 
<a name="l00016"></a><a class="code" href="_dbj_b_tree_8cpp.html#a0">00016</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="_dbj_b_tree_8cpp.html#a0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a7">IndexManager</a>;
<a name="l00017"></a><a class="code" href="class_dbj_b_tree.html#s0">00017</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> <a class="code" href="class_dbj_b_tree.html#s0">DbjBTree::NUM_FSI_ENTRIES</a>;
<a name="l00018"></a><a class="code" href="class_dbj_b_tree.html#v0">00018</a> <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> <a class="code" href="class_dbj_b_tree.html#v0">DbjBTree::ROOT_PAGE_ID</a>;
00019 
00020 <span class="comment">// Konstruktor</span>
<a name="l00021"></a><a class="code" href="class_dbj_b_tree.html#a0">00021</a> <a class="code" href="class_dbj_b_tree.html#a0">DbjBTree::DbjBTree</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> idxId, <span class="keyword">const</span> <span class="keywordtype">bool</span> uniqueFlag,
00022         <span class="keyword">const</span> DbjDataType type)
00023     : indexId(idxId), segmentId(0), unique(uniqueFlag), dataType(type),
00024       leaf(NULL), intLeaf(), vcLeaf(),
00025       innerNode(NULL), intInnerNode(), vcInnerNode(),
00026       bufferMgr(NULL), lockMgr(NULL)
00027 {
00028     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00029 
00030     <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a> = <a class="code" href="class_dbj_lock_manager.html#e0">DbjLockManager::getInstance</a>();
00031     <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a> = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00032     <span class="keywordflow">if</span> ((!<a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a> || !<a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>) &amp;&amp; <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00033         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00034     }
00035 
00036     <a class="code" href="class_dbj_b_tree.html#r1">segmentId</a> = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a10">convertIndexIdToSegmentId</a>(<a class="code" href="class_dbj_b_tree.html#r0">indexId</a>);
00037     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a> == 0) {
00038         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00039         <span class="keywordflow">return</span>;
00040     }
00041 
00042     <span class="comment">// Setze Zeiger auf die konkreten INTEGER bzw. VARCHAR-Instanzen</span>
00043     <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>) {
00044       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
00045           <a class="code" href="class_dbj_b_tree.html#r4">leaf</a> = &amp;<a class="code" href="class_dbj_b_tree.html#r5">intLeaf</a>;
00046           <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a> = &amp;<a class="code" href="class_dbj_b_tree.html#r8">intInnerNode</a>;
00047           <span class="keywordflow">break</span>;
00048       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
00049           <a class="code" href="class_dbj_b_tree.html#r4">leaf</a> = &amp;<a class="code" href="class_dbj_b_tree.html#r6">vcLeaf</a>;
00050           <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a> = &amp;<a class="code" href="class_dbj_b_tree.html#r9">vcInnerNode</a>;
00051           <span class="keywordflow">break</span>;
00052       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>:
00053           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00054           <span class="keywordflow">break</span>;
00055     }
00056 }
00057 
00058 
00059 <span class="comment">// Erzeuge neuen Index</span>
<a name="l00060"></a><a class="code" href="class_dbj_b_tree.html#a2">00060</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a2">DbjBTree::create</a>()
00061 {
00062     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00063     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00064     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00065     <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *initInventory = NULL;
00066     <a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html">LeafNodeHeader</a>* initLeafNodeHeader = NULL;
00067 
00068     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00069 
00070     <span class="comment">// Segment erzeugen und oeffnen</span>
00071     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a0">createSegment</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>);
00072     <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a81">DBJ_FM_FILE_ALREADY_EXISTS</a>) {
00073         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a61">DBJ_IM_INDEX_ALREADY_EXISTS</a>, <a class="code" href="class_dbj_b_tree.html#r0">indexId</a>);
00074         <span class="keywordflow">goto</span> cleanup;
00075     }
00076     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00077         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00078         <span class="keywordflow">goto</span> cleanup;
00079     }   
00080     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a2">openSegment</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>);
00081     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00082         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00083         <span class="keywordflow">goto</span> cleanup;
00084     }
00085 
00086     <span class="comment">// Seite 0 (Inventory) anlegen</span>
00087     rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, 0, DbjLockManager::ExclusiveLock);
00088     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00089         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00090         <span class="keywordflow">goto</span> cleanup;
00091     }
00092     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getNewPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, 0, DbjPage::FreeSpaceInventoryPage,
00093             page);
00094     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00095         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00096         <span class="keywordflow">goto</span> cleanup;
00097     }
00098 
00099     initInventory = reinterpret_cast&lt;Inventory *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00100     initInventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00101     initInventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a> = 0;
00102     initInventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a> = 0; <span class="comment">// zeigt auf sich selbst</span>
00103     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#s0">NUM_FSI_ENTRIES</a>; i++) {
00104         initInventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o4">entries</a>[i] = 0;
00105     }
00106 
00107     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00108     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00109         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00110         <span class="keywordflow">goto</span> cleanup;
00111     }
00112 
00113     <span class="comment">// Wurzel des Baumes anlegen (als Blatt)</span>
00114     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getNewPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>,
00115             DbjPage::BTreeIndexPage, page);
00116     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00117         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00118         <span class="keywordflow">goto</span> cleanup;
00119     }
00120 
00121     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00122     header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>;
00123     initLeafNodeHeader = reinterpret_cast&lt;LeafNodeHeader *&gt;(header + 1);
00124     initLeafNodeHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> = 0;
00125     initLeafNodeHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00126     initLeafNodeHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00127     initLeafNodeHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00128 
00129     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00130     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00131         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00132         <span class="keywordflow">goto</span> cleanup;
00133     }
00134         
00135  cleanup:
00136     <span class="keywordflow">if</span> (page != NULL) {
00137         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00138     }
00139     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00140 }
00141 
00142 
00143 <span class="comment">// Index loeschen</span>
<a name="l00144"></a><a class="code" href="class_dbj_b_tree.html#e0">00144</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#e0">DbjBTree::drop</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> indexId)
00145 {
00146     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00147     <a class="code" href="class_dbj_buffer_manager.html">DbjBufferManager</a> *<a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a> = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00148     <a class="code" href="group__tableid.html#ga0">SegmentId</a> <a class="code" href="class_dbj_b_tree.html#r1">segmentId</a> = bufferMgr-&gt;<a class="code" href="class_dbj_buffer_manager.html#a10">convertIndexIdToSegmentId</a>(indexId);
00149 
00150     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00151     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Index ID"</span>, indexId);
00152 
00153     <span class="comment">// Segment loeschen</span>
00154     rc = bufferMgr-&gt;<a class="code" href="class_dbj_buffer_manager.html#a1">dropSegment</a>(segmentId);
00155     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00156         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00157         <span class="keywordflow">goto</span> cleanup;
00158     }
00159 
00160  cleanup:
00161     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00162 }
00163 
00164 
00165 <span class="comment">// Index oeffnen</span>
<a name="l00166"></a><a class="code" href="class_dbj_b_tree.html#a3">00166</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a3">DbjBTree::open</a>()
00167 {
00168     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00169 
00170     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00171 
00172     <span class="comment">// Segment vom BufferManager oeffnen lassen</span>
00173     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a2">openSegment</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>);
00174     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00175         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00176         <span class="keywordflow">goto</span> cleanup;
00177     }
00178 
00179  cleanup:
00180     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00181 }
00182 
00183 
00184 <span class="comment">// Tupel-ID im Index finden</span>
<a name="l00185"></a><a class="code" href="class_dbj_b_tree.html#a4">00185</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a4">DbjBTree::find</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00186 {
00187     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00188     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00189     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00190     <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00191 
00192     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00193 
00194     <span class="keywordflow">if</span> (key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> == <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>) {
00195         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00196         <span class="keywordflow">goto</span> cleanup;
00197     }
00198 
00199     <span class="comment">// falls nicht unique, dann Anfrage nicht unterstuetzt</span>
00200     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree.html#r2">unique</a>) {
00201         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00202         <span class="keywordflow">goto</span> cleanup;
00203     }
00204 
00205     <span class="comment">// page ist dann der Zeiger auf die geoeffnete Seite, die den key enthaelt</span>
00206     rc = <a class="code" href="class_dbj_b_tree.html#d0">findLeaf</a>(key, page);
00207     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00208         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00209         <span class="keywordflow">goto</span> cleanup;
00210     }
00211 
00212     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00213     <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
00214         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00215         <span class="keywordflow">goto</span> cleanup;
00216     }
00217     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00218 
00219     <span class="comment">// sollte nicht passiereren, da wir keine leeren Blaetter und Seiten haben</span>
00220     <span class="comment">// (ausser wenn die Wurzel leer ist)</span>
00221     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> == 0) {
00222         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00223         <span class="keywordflow">goto</span> cleanup;
00224     }
00225     <span class="comment">// suche nach dem key und setzen der tid auf den gefundenen wert</span>
00226     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &amp;&amp;
00227              <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i) &lt;= key; i++) {
00228         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i) == key) {
00229             tid = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i);
00230             found = <span class="keyword">true</span>;
00231             <span class="keywordflow">break</span>;
00232         }
00233     }
00234     <span class="keywordflow">if</span> (!found) {
00235         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00236         <span class="keywordflow">goto</span> cleanup;
00237     }
00238 
00239  cleanup:
00240     <span class="keywordflow">if</span> (page != NULL) {
00241         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00242     }
00243     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00244 }
00245 
00246 
00247 <span class="comment">// Finde ersten Schluessel im Index</span>
00248 <span class="comment">// (gehe immer nach links bis im Blatt, dann gib ersten Eintrag)</span>
<a name="l00249"></a><a class="code" href="class_dbj_b_tree.html#a5">00249</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a5">DbjBTree::findFirstKey</a>(<a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00250 {
00251     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00252     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00253     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00254     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> tempPageId = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00255     <span class="keywordtype">bool</span> leafFound = <span class="keyword">false</span>;
00256 
00257     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00258 
00259     <span class="comment">//noch herausfinden ob leaf oder inner node</span>
00260     leafFound = <span class="keyword">false</span>;
00261     <span class="keywordflow">do</span> {
00262         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, tempPageId, DbjLockManager::SharedLock);
00263         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00264             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00265             <span class="keywordflow">goto</span> cleanup;
00266         }
00267         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, tempPageId, DbjPage::BTreeIndexPage,
00268                 page);
00269         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00270             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00271             <span class="keywordflow">goto</span> cleanup;
00272         }
00273 
00274         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00275         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> == <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>) {        
00276             <a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html">InnerNodeHeader</a> *innerNodeHeader =
00277                 reinterpret_cast&lt;InnerNodeHeader *&gt;(header + 1);
00278             tempPageId = innerNodeHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a>;
00279 
00280             rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00281             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00282                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00283                 <span class="keywordflow">goto</span> cleanup;
00284             }
00285         }
00286         <span class="comment">// falls Blatt gefunden</span>
00287         <span class="keywordflow">else</span> {
00288             leafFound = <span class="keyword">true</span>;
00289         }
00290     }
00291     <span class="keywordflow">while</span> (!leafFound);
00292 
00293     <span class="comment">// interpretiere Blatt</span>
00294     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00295     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &gt; 0) {
00296         key = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(0);
00297         tid = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(0);
00298     }
00299     <span class="keywordflow">else</span> {
00300         <span class="comment">// leeres Blatt (= Wurzel)</span>
00301         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00302         <span class="keywordflow">goto</span> cleanup;
00303     }
00304 
00305  cleanup:
00306     <span class="keywordflow">if</span> (page != NULL) {
00307         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00308     }
00309     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00310 }
00311 
00312 
00313 <span class="comment">// Finde ersten Schluessel im Index</span>
00314 <span class="comment">// (gehe immer nach rechts bis im Blatt, dann gib letzten Eintrag)</span>
<a name="l00315"></a><a class="code" href="class_dbj_b_tree.html#a6">00315</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a6">DbjBTree::findLastKey</a>(<a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00316 {
00317     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00318     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00319     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00320     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> tempPageId = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00321     <span class="keywordtype">bool</span> leafFound = <span class="keyword">false</span>;
00322 
00323     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00324 
00325     <span class="comment">// steige im Baum ab</span>
00326     leafFound = <span class="keyword">false</span>;
00327     <span class="keywordflow">do</span> {
00328         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, tempPageId, DbjLockManager::SharedLock);
00329         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00330             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00331             <span class="keywordflow">goto</span> cleanup;
00332         }
00333         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, tempPageId, DbjPage::BTreeIndexPage,
00334                 page);
00335         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00336             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00337             <span class="keywordflow">goto</span> cleanup;
00338         }
00339 
00340         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00341         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> == <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>) {
00342             <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00343             tempPageId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(
00344                     <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> - 1);
00345 
00346             rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00347             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00348                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00349                 <span class="keywordflow">goto</span> cleanup;
00350             }
00351         }
00352         <span class="comment">// falls Blatt gefunden</span>
00353         <span class="keywordflow">else</span> {
00354             leafFound = <span class="keyword">true</span>;
00355         }
00356     }
00357     <span class="keywordflow">while</span> (!leafFound);
00358 
00359     <span class="comment">// interpretiere Blatt</span>
00360     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00361     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &gt; 0) {
00362         key = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> - 1);
00363         tid = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> - 1);
00364     }
00365     <span class="keywordflow">else</span> {
00366         <span class="comment">// leeres Blatt (= Wurzel)</span>
00367         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00368         <span class="keywordflow">goto</span> cleanup;
00369     }
00370 
00371  cleanup:
00372     <span class="keywordflow">if</span> (page != NULL) {
00373         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00374     }
00375     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00376 }
00377 
00378 <span class="comment">// Gib Index-Iterator</span>
<a name="l00379"></a><a class="code" href="class_dbj_b_tree.html#a7">00379</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a7">DbjBTree::findRange</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> *startKey,
00380         <span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> *stopKey, <a class="code" href="class_dbj_index_iterator.html">DbjIndexIterator</a> *&amp;iter)
00381 {
00382     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00383 
00384     <span class="keywordflow">if</span> (iter != NULL) {
00385         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00386         <span class="keywordflow">goto</span> cleanup;
00387     }
00388 
00389     iter = <span class="keyword">new</span> <a class="code" href="class_dbj_b_tree_iterator.html">DbjBTreeIterator</a>(<span class="keyword">this</span>, startKey, stopKey);
00390     <span class="keywordflow">if</span> (!iter || <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00391         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00392         <span class="keyword">delete</span> iter;
00393         iter = NULL;
00394         <span class="keywordflow">goto</span> cleanup;
00395     }
00396 
00397  cleanup:
00398     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00399 }
00400 
00401 <span class="comment">// Fuege Schluessel/Tupel-ID in Index ein</span>
<a name="l00402"></a><a class="code" href="class_dbj_b_tree.html#a8">00402</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a8">DbjBTree::insert</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00403 {
00404     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00405     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00406 
00407     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00408     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Index ID"</span>, <a class="code" href="class_dbj_b_tree.html#r0">indexId</a>);
00409     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"INTEGER-Schluessel"</span>, key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a>);
00410     <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(3, key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>);
00411     <a class="code" href="group__trace__def.html#ga3">DBJ_TRACE_DATA1</a>(4, <span class="keyword">sizeof</span> tid, &amp;tid);
00412 
00413     rc = <a class="code" href="class_dbj_b_tree.html#d0">findLeaf</a>(key, page);
00414     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00415         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00416         <span class="keywordflow">goto</span> cleanup;   
00417     }
00418     rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>(),
00419             DbjLockManager::ExclusiveLock);
00420     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00421         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00422         <span class="keywordflow">goto</span> cleanup;
00423     }
00424 
00425     <span class="comment">// einfuegen (splittet, wenn noetig)</span>
00426     <span class="comment">// gibt Seite auch wieder frei</span>
00427     rc = <a class="code" href="class_dbj_b_tree.html#d1">insertIntoLeaf</a>(key, tid, page);
00428     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00429         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00430         <span class="keywordflow">goto</span> cleanup;
00431     }
00432 
00433  cleanup:
00434     <span class="comment">// Seite wurde von "findLeaf" angefordert und von "insertIntoLeaf" wieder</span>
00435     <span class="comment">// freigegeben</span>
00436     <span class="keywordflow">if</span> (page != NULL) {
00437         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00438     }
00439     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00440 }
00441 
00442 
00443 <span class="comment">// Entferne Schluessel/Tupel-ID aus Index</span>
<a name="l00444"></a><a class="code" href="class_dbj_b_tree.html#a9">00444</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#a9">DbjBTree::remove</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> *tid)
00445 {
00446     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00447     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00448     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00449     <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00450     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> brotherPageId = 0;
00451     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId = 0;
00452 
00453     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00454 
00455     <span class="comment">// falls nicht unique, dann muss noch tid angegeben sein</span>
00456     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree.html#r2">unique</a> &amp;&amp; tid == NULL) {
00457         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00458         <span class="keywordflow">goto</span> cleanup;
00459     }
00460 
00461     <span class="comment">// hole Seite in der der Schluessel hinterlegt ist</span>
00462     rc = <a class="code" href="class_dbj_b_tree.html#d0">findLeaf</a>(key, page);
00463     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00464         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00465         <span class="keywordflow">goto</span> cleanup;
00466     }
00467 
00468     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00469     <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
00470         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00471         <span class="keywordflow">goto</span> cleanup;
00472     }
00473     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00474 
00475     <span class="keywordflow">while</span> (!found) {
00476         <span class="comment">// finde Eintrag in Seite</span>
00477         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a>; i++) {
00478             <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i) == key) {
00479                 <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r2">unique</a> || <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i) == *tid) {
00480                     rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>(),
00481                             DbjLockManager::ExclusiveLock);
00482                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00483                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00484                         <span class="keywordflow">goto</span> cleanup;
00485                     }
00486                     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00487                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00488                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00489                         <span class="keywordflow">goto</span> cleanup;
00490                     }
00491                     rc = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a5">deleteEntry</a>(i);
00492                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00493                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00494                         <span class="keywordflow">goto</span> cleanup;
00495                     }
00496                     found = <span class="keyword">true</span>;
00497 
00498                     <span class="comment">// propagiere Aenderungen zum Vater wenn Blatt jetzt leer</span>
00499                     <span class="comment">// ist (und wir nicht in der Wurzel sind)!!</span>
00500                     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> == 0 &amp;&amp;
00501                             page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() != <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>) {
00502                         rc = <a class="code" href="class_dbj_b_tree.html#d6">deleteEmptyLeaf</a>(page);
00503                         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00504                             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00505                             <span class="keywordflow">goto</span> cleanup;
00506                         }
00507                     }
00508 
00509                     <span class="keywordflow">break</span>; <span class="comment">// verlasse for-Schleife</span>
00510                 }
00511             }
00512             <span class="comment">// groesserer key gefunden -&gt; keine weitere suche noetig</span>
00513             <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i) &gt; key) {
00514                 found = <span class="keyword">false</span>;
00515                 <span class="keywordflow">break</span>; <span class="comment">// verlasse while-Schleife</span>
00516             }
00517         }
00518 
00519         <span class="comment">// Eintrag wurde nicht im aktuellen Blatte gefunden - hole Bruder und</span>
00520         <span class="comment">// suche dort weiter</span>
00521         brotherPageId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a>;
00522         <span class="keywordflow">if</span> (brotherPageId == page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>()) {
00523             <span class="keywordflow">break</span>;
00524         }
00525 
00526         <span class="comment">// gib alte Seite frei</span>
00527         pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
00528         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00529         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00530             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00531             <span class="keywordflow">goto</span> cleanup;
00532         }
00533 
00534         <span class="comment">// hole Bruder</span>
00535         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
00536                 DbjLockManager::SharedLock);
00537         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00538             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00539             <span class="keywordflow">goto</span> cleanup;
00540         }
00541         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
00542                 DbjPage::BTreeIndexPage, page);
00543         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00544             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00545             <span class="keywordflow">goto</span> cleanup;
00546         }
00547         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00548         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
00549             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00550             <span class="keywordflow">goto</span> cleanup;
00551         }
00552         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00553     }
00554 
00555     <span class="comment">// Eintrag wurde nicht gefunden</span>
00556     <span class="keywordflow">if</span> (!found) {
00557         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00558         <span class="keywordflow">goto</span> cleanup;
00559     }
00560 
00561  cleanup:
00562     <span class="keywordflow">if</span> (page != NULL) {
00563         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00564     }
00565     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00566 }
00567 
00568 <span class="comment">// Finde Blatt fuer Schluessel</span>
<a name="l00569"></a><a class="code" href="class_dbj_b_tree.html#d0">00569</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d0">DbjBTree::findLeaf</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <a class="code" href="class_dbj_page.html">DbjPage</a>* &amp;page)
00570 {
00571     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00572     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00573     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> tempPageId = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00574     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> oldPageId = ROOT_PAGE_ID;
00575     <span class="keywordtype">bool</span> leafFound = <span class="keyword">false</span>;
00576 
00577     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00578 
00579     <span class="keywordflow">do</span> {
00580         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, tempPageId, DbjLockManager::SharedLock);
00581         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00582             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00583             <span class="keywordflow">goto</span> cleanup;
00584         }
00585         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, tempPageId, DbjPage::BTreeIndexPage,
00586                 page);
00587         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00588             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00589             <span class="keywordflow">goto</span> cleanup;
00590         }
00591 
00592         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00593         oldPageId = tempPageId;
00594         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> == <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>) {        
00595             <span class="comment">// interpretiere Inneren Knoten</span>
00596             <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00597             tempPageId = 0;
00598             <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> == 0) {
00599                 tempPageId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a>;
00600             }
00601             <span class="comment">// Vergleich mit allen Schluesseln</span>
00602             <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>; i++) {
00603                 <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i) &gt; key) {
00604                     <span class="keywordflow">if</span> (i == 0) {
00605                         tempPageId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a>;
00606                     }
00607                     <span class="keywordflow">else</span> {
00608                         tempPageId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i-1);
00609                     }
00610                     <span class="keywordflow">break</span>;
00611                 }
00612             }
00613             <span class="keywordflow">if</span> (tempPageId == 0) {
00614                 <span class="comment">// falls Ende des Knoten oder Ende der Eintraege erreicht</span>
00615                 tempPageId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(
00616                         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> - 1);
00617             }
00618 
00619             <span class="comment">// geoeffnete Seiten werden wieder geschlossen (nur die innerNodes)</span>
00620             rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00621             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00622                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00623                 <span class="keywordflow">goto</span> cleanup;
00624             }
00625         }
00626         <span class="comment">// falls jetzt Blatt gefunden</span>
00627         <span class="keywordflow">else</span> {
00628             leafFound = <span class="keyword">true</span>;
00629         }
00630         <span class="comment">// Leaf noch geoeffnet und shared gesperrt</span>
00631     }
00632     <span class="keywordflow">while</span> (!leafFound);
00633 
00634  cleanup:
00635     <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; page != NULL) {
00636         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00637     }
00638     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00639 }
00640 
00641 
00642 <span class="comment">// Fuege Schluessel in Blatt ein</span>
<a name="l00643"></a><a class="code" href="class_dbj_b_tree.html#d1">00643</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d1">DbjBTree::insertIntoLeaf</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key,
00644         <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tupleId, <a class="code" href="class_dbj_page.html">DbjPage</a> *&amp;page)
00645 {
00646     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00647     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00648     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> offset = 0;
00649     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId = 0;
00650     <a class="code" href="class_dbj_page.html">DbjPage</a> *brotherPage = NULL;
00651     <a class="code" href="class_dbj_b_tree_1_1_node.html">Leaf</a> *brotherLeaf = NULL;
00652     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">LeafSint32</a> brotherIntLeaf;
00653     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">LeafVarchar</a> brotherVcLeaf;
00654 
00655     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00656 
00657     <span class="keywordflow">if</span> (!page) {
00658         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00659         <span class="keywordflow">goto</span> cleanup;
00660     }
00661 
00662     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00663     <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
00664         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00665         <span class="keywordflow">goto</span> cleanup;
00666     }
00667     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00668 
00669     <span class="comment">// fuege ersten Eintrag in leere Wurzel ein</span>
00670     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &lt;= 0) {
00671         <span class="keywordflow">if</span> (page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() != <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>) {
00672             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00673             <span class="keywordflow">goto</span> cleanup;
00674         }
00675         rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00676         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00677             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00678             <span class="keywordflow">goto</span> cleanup;
00679         }
00680         <span class="comment">// fuege Schluessel als ersten im Blatt ein</span>
00681         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(0, key, tupleId);
00682         <span class="keywordflow">goto</span> cleanup;
00683     }
00684 
00685     pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
00686 
00687     <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>) {
00688       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
00689           brotherLeaf = &amp;brotherIntLeaf;
00690           <span class="keywordflow">break</span>;
00691       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
00692           brotherLeaf = &amp;brotherVcLeaf;
00693           <span class="keywordflow">break</span>;
00694       <span class="keywordflow">default</span>:
00695           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00696           <span class="keywordflow">goto</span> cleanup;
00697     }
00698 
00699     <span class="comment">// suche solange, bis wir der Stelle in den Blaettern angekommen, wo</span>
00700     <span class="comment">// der Eintrag eingefuegt werden muss</span>
00701     <span class="keywordflow">while</span> (offset &lt; <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &amp;&amp;
00702             <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(offset) &lt;= key) {
00703 
00704         <span class="comment">// falls Schluesselwerte gleich sind, pruefen ob Tuple-ID eindeutig</span>
00705         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(offset) == key) {
00706             <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r2">unique</a>) {
00707                 <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a62">DBJ_IM_DUPLICATE_KEY_IN_UNIQUE_INDEX</a>,
00708                     page-&gt;<a class="code" href="class_dbj_page.html#a0">getSegmentId</a>());
00709                 <span class="keywordflow">goto</span> cleanup;
00710             }
00711             <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(offset) == tupleId) {
00712                 <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a64">DBJ_IM_DUPLICATE_ENTRY_IN_NON_UNIQUE_INDEX</a>,
00713                         page-&gt;<a class="code" href="class_dbj_page.html#a0">getSegmentId</a>());
00714                 <span class="keywordflow">goto</span> cleanup;
00715             }
00716 <span class="preprocessor">#if defined(DBJ_OPTIMIZE)</span>
00717 <span class="preprocessor"></span>            <span class="comment">// Wenn wir keine Prfungen der Schluessel durchfuehren, dann</span>
00718             <span class="comment">// koennen wir hier einfach die aktuelle Position verwenden und</span>
00719             <span class="comment">// die Schleife verlassen.</span>
00720             offset++;
00721             <span class="keywordflow">break</span>;
00722 <span class="preprocessor">#endif </span><span class="comment">/* DBJ_OPTIMIZE */</span>
00723         }
00724 
00725         offset++;
00726 
00727 <span class="preprocessor">#if !defined(DBJ_OPTIMIZE)</span>
00728 <span class="preprocessor"></span>        <span class="comment">// Wenn wir am Ende des Blattes angekommen sind, pruefe ob der</span>
00729         <span class="comment">// naechste Schlussel im rechten Bruder groesser als der gesuchte</span>
00730         <span class="comment">// Schluessel ist, um zu entscheiden, ob wir im Bruder weitersuchen</span>
00731         <span class="comment">// muessen</span>
00732         <span class="keywordflow">if</span> (offset &gt;= <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a>) {
00733             <a class="code" href="group__id__datatypes.html#ga0">PageId</a> brotherPageId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a>;
00734             <span class="comment">// hole den bruder falls es ihn gibt</span>
00735             <span class="keywordflow">if</span> (pageId == brotherPageId) {
00736                 <span class="keywordflow">break</span>;
00737             }
00738 
00739             rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
00740                     DbjLockManager::SharedLock);
00741             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00742                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00743                 <span class="keywordflow">goto</span> cleanup;
00744             }
00745             rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
00746                     DbjPage::BTreeIndexPage, brotherPage);
00747             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00748                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00749                 <span class="keywordflow">goto</span> cleanup;
00750             }
00751 
00752             header = reinterpret_cast&lt;Header *&gt;(brotherPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00753             <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
00754                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00755                 <span class="keywordflow">goto</span> cleanup;
00756             }
00757             brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00758             <span class="keywordflow">if</span> (brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(0) &lt; <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(
00759                         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> - 1)) {
00760                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00761                 <span class="keywordflow">goto</span> cleanup;
00762             }
00763             <span class="keywordflow">if</span> (brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(0) &gt; key) {
00764                 <span class="comment">/*</span>
00765 <span class="comment">                 * Schluessel muss an der letzten im vorherigen Blatt</span>
00766 <span class="comment">                 * eingefuegt werden, also brauchen wir den Bruder nicht mehr</span>
00767 <span class="comment">                 */</span>
00768                 rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
00769                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00770                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00771                     <span class="keywordflow">goto</span> cleanup;
00772                 }
00773                 <span class="keywordflow">break</span>;
00774             }
00775             <span class="keywordflow">else</span> {
00776                 <span class="comment">/*</span>
00777 <span class="comment">                 * jetzt suchen wir im Bruder weiter</span>
00778 <span class="comment">                 */</span>
00779 
00780                 <span class="comment">// vorheriges Blatt schliessen ...</span>
00781                 rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00782                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00783                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00784                     <span class="keywordflow">goto</span> cleanup;
00785                 }
00786 
00787                 <span class="comment">// ... und im Bruder weitermachen</span>
00788                 page = brotherPage;
00789                 pageId = brotherPageId;
00790                 header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00791                 <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00792                 brotherPage = NULL;
00793                 offset = 0;
00794             }
00795         }
00796 <span class="preprocessor">#endif </span><span class="comment">/* DBJ_OPTIMIZE */</span>
00797     }
00798 
00799     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a8">keyWillFit</a>(key)) {
00800         <span class="comment">// aktuelles Blatt ist zu voll und muss geteilt werden</span>
00801         rc = <a class="code" href="class_dbj_b_tree.html#d3">splitLeafAndInsertInto</a>(key, tupleId, page);
00802         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00803             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00804             <span class="keywordflow">goto</span> cleanup;
00805         }
00806         <span class="comment">// Split gibt "page" gleich frei</span>
00807     }
00808     <span class="keywordflow">else</span> {
00809         <span class="comment">// fuege Schluessel in aktuelles Blatt ein </span>
00810         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, pageId, DbjLockManager::ExclusiveLock);
00811         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00812             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00813             <span class="keywordflow">goto</span> cleanup;
00814         }
00815         rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00816         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00817             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00818             <span class="keywordflow">goto</span> cleanup;
00819         }
00820         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(offset, key, tupleId);
00821     }
00822 
00823  cleanup:
00824     <span class="keywordflow">if</span> (brotherPage != NULL) {
00825         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
00826     }
00827     <span class="keywordflow">if</span> (page != NULL) {
00828         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00829     }
00830     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00831 }
00832 
00833 
00834 <span class="comment">// Fuege Schluessel/Seiten-ID in inneren Knoten ein</span>
<a name="l00835"></a><a class="code" href="class_dbj_b_tree.html#d2">00835</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d2">DbjBTree::insertIntoInnerNode</a>(<span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId,
00836         <span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key, <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> sonPageId,
00837         <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> splittedChildId)
00838 {
00839     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00840     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00841     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00842 
00843     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00844     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Page ID (inner Node)"</span>, pageId);
00845     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page ID (child that was split)"</span>, splittedChildId);
00846 
00847     <span class="comment">// fordere Seite/Knoten an</span>
00848     rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, pageId, DbjLockManager::ExclusiveLock);
00849     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00850         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00851         <span class="keywordflow">goto</span> cleanup;
00852     }
00853     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, pageId, DbjPage::BTreeIndexPage,
00854             page);
00855     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00856         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00857         <span class="keywordflow">goto</span> cleanup;
00858     }
00859 
00860     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00861     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00862         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00863         <span class="keywordflow">goto</span> cleanup;
00864     }
00865 
00866     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00867     <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>) {
00868         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00869         <span class="keywordflow">goto</span> cleanup;
00870     }
00871     <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00872 
00873     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a8">keyWillFit</a>(key)) {
00874         rc = <a class="code" href="class_dbj_b_tree.html#d4">splitInnerNodeAndInsertInto</a>(key, sonPageId, page);
00875         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00876             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00877             <span class="keywordflow">goto</span> cleanup;
00878         }
00879         <span class="comment">// split gibt Seite auch gleich frei</span>
00880     }
00881     <span class="keywordflow">else</span> {
00882         <span class="comment">// finde die Stelle im Knoten, wo der urpspruengliche Knoten haengt,</span>
00883         <span class="comment">// der geteilt wurde</span>
00884         <span class="comment">// (direkt dahinter muss ein neuer Eintrag rein fuer den neuen Sohn)</span>
00885         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> offset = 0;
00886         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a> != splittedChildId) {
00887             <span class="keywordflow">while</span> (offset &lt; <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>) {
00888                 <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(offset) == splittedChildId) {
00889                     <span class="keywordflow">break</span>;
00890                 }
00891                 offset++;
00892             }
00893             <span class="keywordflow">if</span> (offset &gt;= <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>) {
00894                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00895                 <span class="keywordflow">goto</span> cleanup;
00896             }
00897 
00898             <span class="comment">// gehe zum naechsten Slot</span>
00899             offset++;
00900         }
00901         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(offset, key, sonPageId);
00902     }
00903 
00904  cleanup:
00905     <span class="keywordflow">if</span> (page != NULL) {
00906         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00907     }
00908     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00909 }
00910 
00911 <span class="comment">// Teile Blatt</span>
<a name="l00912"></a><a class="code" href="class_dbj_b_tree.html#d3">00912</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d3">DbjBTree::splitLeafAndInsertInto</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key,
00913         <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid, <a class="code" href="class_dbj_page.html">DbjPage</a> *&amp;page)
00914 {
00915     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00916     <a class="code" href="class_dbj_page.html">DbjPage</a> *inventoryPage = NULL;
00917     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
00918     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId = 0;
00919     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newPageId = 0;
00920     <a class="code" href="class_dbj_page.html">DbjPage</a> *newPage = NULL;
00921     <a class="code" href="class_dbj_page.html">DbjPage</a> *brotherPage = NULL;
00922     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> median = 0;
00923     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> medianKey;
00924     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> medianPageId = 0;
00925     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fatherId = 0;
00926     <a class="code" href="class_dbj_b_tree_1_1_node.html">Leaf</a> *newLeaf = NULL;
00927     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">LeafSint32</a> newIntLeaf;
00928     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">LeafVarchar</a> newVcLeaf;
00929     <a class="code" href="class_dbj_b_tree_1_1_node.html">Leaf</a> *brotherLeaf = NULL;
00930     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">LeafSint32</a> brotherIntLeaf;
00931     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">LeafVarchar</a> brotherVcLeaf;
00932     <a class="code" href="class_dbj_b_tree_1_1_node.html">Inner</a> *newRoot = NULL;
00933     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">InnerSint32</a> newIntRoot;
00934     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">InnerVarchar</a> newVcRoot;
00935 
00936     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00937 
00938     <span class="keywordflow">if</span> (!page) {
00939         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00940         <span class="keywordflow">goto</span> cleanup;
00941     }
00942 
00943     pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
00944     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a> == 0) {
00945         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00946         <span class="keywordflow">goto</span> cleanup;
00947     }
00948     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00949     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00950         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00951         <span class="keywordflow">goto</span> cleanup;
00952     }
00953 
00954     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00955     <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>) {
00956       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
00957           newLeaf = &amp;newIntLeaf;
00958           brotherLeaf = &amp;brotherIntLeaf;
00959           newRoot = &amp;newIntRoot;
00960           <span class="keywordflow">break</span>;
00961       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
00962           newLeaf = &amp;newVcLeaf;
00963           brotherLeaf = &amp;brotherVcLeaf;
00964           newRoot = &amp;newVcRoot;
00965           <span class="keywordflow">break</span>;
00966       <span class="keywordflow">default</span>:
00967           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00968           <span class="keywordflow">goto</span> cleanup;
00969     }
00970     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00971 
00972     <span class="comment">// splitten wir die Wurzel??</span>
00973     <span class="keywordflow">if</span> (pageId == <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>) {
00974         <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newFirstLeafId = newPageId - 1;
00975         <a class="code" href="class_dbj_page.html">DbjPage</a> *newFirstLeaf = NULL;
00976 
00977         rc = <a class="code" href="class_dbj_b_tree.html#d8">getFreePage</a>(newFirstLeaf);
00978         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00979             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00980             <span class="keywordflow">goto</span> cleanup;
00981         }
00982         newFirstLeafId = newFirstLeaf-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
00983 
00984         <span class="comment">// Initialisiere Seite "newFirstLeafId" mit den Daten der alten Wurzel</span>
00985         <span class="comment">// (Blatt)</span>
00986         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(newFirstLeaf-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a>),
00987                 page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a>),
00988                 DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a>));
00989         header = reinterpret_cast&lt;Header *&gt;(newFirstLeaf-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00990         header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>;
00991         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
00992         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
00993         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> = newFirstLeafId;
00994         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = newFirstLeafId;
00995 
00996         <span class="comment">// Setze die alte Seite 1 (Wurzel) als Inneren Knoten</span>
00997         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00998         header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>;
00999         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01000         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a> = newFirstLeafId;
01001         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> = 0;
01002         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
01003 
01004         <span class="comment">// Wurzel freigeben, wird nicht mehr gebraucht</span>
01005         <span class="comment">// (bzw. "insertIntoInnerNode" fordert die Seite wieder an, wenn der</span>
01006         <span class="comment">// Median dort eingefuegt wird)</span>
01007         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01008         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01009             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01010             <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newFirstLeaf);
01011             <span class="keywordflow">goto</span> cleanup;
01012         }
01013 
01014         <span class="comment">// jetzt schalte auf Kopie der Wurzel um</span>
01015         page = newFirstLeaf;
01016         pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01017         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01018         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01019     }
01020 
01021     <span class="comment">// hole neue Seite</span>
01022     rc = <a class="code" href="class_dbj_b_tree.html#d8">getFreePage</a>(newPage);
01023     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01024         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01025         <span class="keywordflow">goto</span> cleanup;
01026     }
01027     newPageId = newPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01028 
01029     <span class="comment">// initialisieren der neuen Seite</span>
01030     header = reinterpret_cast&lt;Header *&gt;(newPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01031     newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01032     header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>;
01033     newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> = 0;
01034 
01035     <span class="comment">// geteiltes Blatt war rechtestes Blatt im Baum</span>
01036     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> == pageId) {
01037         newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = newPageId;
01038     }
01039     <span class="keywordflow">else</span> {
01040         <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *brotherPageHeader = NULL;
01041         <a class="code" href="group__id__datatypes.html#ga0">PageId</a> brotherPageId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a>;
01042         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
01043                 DbjLockManager::ExclusiveLock);
01044         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01045             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01046             <span class="keywordflow">goto</span> cleanup;
01047         }
01048         
01049         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
01050                 DbjPage::BTreeIndexPage, brotherPage);
01051         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01052             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01053             <span class="keywordflow">goto</span> cleanup;
01054         }
01055 
01056         rc = brotherPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01057         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01058             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01059             <span class="keywordflow">goto</span> cleanup;
01060         }
01061 
01062         <span class="comment">// Verlinkung zwischen altem rechten Bruder und neuer Seite setzen</span>
01063         brotherPageHeader = reinterpret_cast&lt;Header *&gt;(
01064                 brotherPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01065         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
01066             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01067             <span class="keywordflow">goto</span> cleanup;
01068         }
01069         brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(brotherPageHeader + 1);
01070         brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> = newPageId;
01071         newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = brotherPageId;
01072 
01073         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
01074         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01075             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01076             <span class="keywordflow">goto</span> cleanup;
01077         }
01078     }
01079 
01080     <span class="comment">// Verkettung zwischen geteilter Seite und neuer Seite setzen</span>
01081     newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> = pageId;
01082     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = newPageId;
01083 
01084     <span class="comment">// neue Seite hat den gleichen Vater wie die alte</span>
01085     newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a> = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a>;
01086 
01087     median = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> / 2;
01088 
01089     <span class="comment">// Wenn Werte aufsteigend eingefuegt werden, so hat das zur Folge, dass</span>
01090     <span class="comment">// alle Indexseiten nur halb voll sind.  Um dies zu vermeiden, teilen wir</span>
01091     <span class="comment">// die Seite etwas anders, so dass die Mehrzahl der Eintrage in "leaf"</span>
01092     <span class="comment">// bleibt und nur ein kleiner Teil in "newLeaf" kopiert wird.  Per default</span>
01093     <span class="comment">// kopieren wir nur 10 Eintraege, mindestens jedoch 2.</span>
01094     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> - 1) &lt; key) {
01095         median = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> * 9 / 10;
01096         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> - median &lt; 2) {
01097             median = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> - 2;
01098         }
01099     }
01100 
01101     <span class="comment">// kopieren der Eintraege ab Median in die neue Seite</span>
01102     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = median, j = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a>; i++, j++) {
01103         newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a3">setKey</a>(j, <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i));
01104         newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a2">setReference</a>(j, <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i));
01105         newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a>++;
01106     }
01107     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> = median;
01108 
01109     <span class="comment">// einfuegen des eigentlich einzufuegenden Elements (in der jeweiligen</span>
01110     <span class="comment">// Seite ist nun auf jeden Fall genug Platz)</span>
01111     <span class="keywordflow">if</span> (key &gt;= newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(0)) {
01112         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> idx = 0;
01113         <span class="keywordflow">while</span> (idx &lt; newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &amp;&amp;
01114                 newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(idx) &lt; key) {
01115             idx++;
01116         }
01117         newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(idx, key, tid);
01118     }
01119     <span class="keywordflow">else</span> {
01120         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> idx = 0;
01121         <span class="keywordflow">while</span> (idx &lt; <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> &amp;&amp;
01122                 <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(idx) &lt; key) {
01123             idx++;
01124         }
01125         <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(idx, key, tid);
01126     }
01127     medianKey = newLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(0);
01128     medianPageId = newPageId;
01129     fatherId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a>;
01130 
01131     <span class="comment">// gib alle Seiten frei, wir sind fertig hier</span>
01132     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newPage);
01133     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01134         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01135         <span class="keywordflow">goto</span> cleanup;
01136     }
01137     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01138     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01139         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01140         <span class="keywordflow">goto</span> cleanup;
01141     }
01142 
01143     <span class="comment">// Median in Vater einfuegen</span>
01144     rc = <a class="code" href="class_dbj_b_tree.html#d2">insertIntoInnerNode</a>(fatherId, medianKey, medianPageId, pageId);
01145     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01146         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01147         <span class="keywordflow">goto</span> cleanup;
01148     }
01149 
01150  cleanup:
01151     <span class="keywordflow">if</span> (page != NULL) {
01152         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01153     }
01154     <span class="keywordflow">if</span> (newPage != NULL) {
01155         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newPage);
01156     }
01157     <span class="keywordflow">if</span> (brotherPage != NULL) {
01158         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
01159     }
01160     <span class="keywordflow">if</span> (inventoryPage != NULL) {
01161         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(inventoryPage);
01162     }
01163     medianKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01164     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01165 }
01166 
01167 
01168 <span class="comment">// Teile inneren Knoten</span>
<a name="l01169"></a><a class="code" href="class_dbj_b_tree.html#d4">01169</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d4">DbjBTree::splitInnerNodeAndInsertInto</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> &amp;key,
01170         <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> &amp;keyPageId, <a class="code" href="class_dbj_page.html">DbjPage</a> *&amp;page)
01171 {
01172     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01173     <a class="code" href="class_dbj_page.html">DbjPage</a> *inventoryPage = NULL;
01174     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
01175     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId = 0;
01176     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newPageId = 0;
01177     <a class="code" href="class_dbj_page.html">DbjPage</a> *newPage = NULL;
01178     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> median = 0;
01179     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> medianKey;
01180     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fatherId = 0;
01181     <a class="code" href="class_dbj_b_tree_1_1_node.html">Inner</a> *newInnerNode = NULL;
01182     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">InnerSint32</a> newIntInnerNode;
01183     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">InnerVarchar</a> newVcInnerNode;
01184     <a class="code" href="class_dbj_b_tree_1_1_node.html">Inner</a> *newRoot = NULL;
01185     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">InnerSint32</a> newIntRoot;
01186     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">InnerVarchar</a> newVcRoot;
01187 
01188     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01189 
01190     <span class="keywordflow">if</span> (!page) {
01191         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01192         <span class="keywordflow">goto</span> cleanup;
01193     }
01194 
01195     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01196     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01197         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01198         <span class="keywordflow">goto</span> cleanup;
01199     }
01200 
01201     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01202     <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>) {
01203       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
01204           newInnerNode = &amp;newIntInnerNode;
01205           newRoot = &amp;newIntRoot;
01206           <span class="keywordflow">break</span>;
01207       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
01208           newInnerNode = &amp;newVcInnerNode;
01209           newRoot = &amp;newVcRoot;
01210           <span class="keywordflow">break</span>;
01211       <span class="keywordflow">default</span>:
01212           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01213           <span class="keywordflow">goto</span> cleanup;
01214     }
01215     <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01216 
01217     median = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> / 2;
01218     pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01219 
01220     <span class="comment">// splitten wir die Wurzel??</span>
01221     <span class="keywordflow">if</span> (page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() == <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>) {
01222         <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newFirstLeftId = 0;
01223         <a class="code" href="class_dbj_page.html">DbjPage</a> *newFirstLeft = NULL;
01224 
01225         <span class="comment">// fordere neuen Sohn an</span>
01226         rc = <a class="code" href="class_dbj_b_tree.html#d8">getFreePage</a>(newFirstLeft);
01227         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01228             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01229             <span class="keywordflow">goto</span> cleanup;
01230         }
01231         newFirstLeftId = newFirstLeft-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01232 
01233         <span class="comment">// Initialisiere Seite "newFirstLeftId" mit den Daten der alten</span>
01234         <span class="comment">// Wurzel</span>
01235         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(newFirstLeft-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a>),
01236                 page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a>),
01237                 DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a>));
01238         header = reinterpret_cast&lt;Header *&gt;(newFirstLeft-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01239         header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>;
01240         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01241         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
01242 
01243         <span class="comment">// Initialisiere die Wurzel als leeren Knoten (nur mit "firstLeft")</span>
01244         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01245         header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>;
01246         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01247         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a> = newFirstLeftId;
01248         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> = 0;
01249         newRoot-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
01250 
01251         <span class="comment">// Wurzel freigeben, wird nicht mehr gebraucht</span>
01252         <span class="comment">// (bzw. "insertIntoInnerNode" fordert die Seite wieder an, wenn der</span>
01253         <span class="comment">// Median dort eingefuegt wird)</span>
01254         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01255         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01256             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01257             <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newFirstLeft);
01258             <span class="keywordflow">goto</span> cleanup;
01259         }
01260 
01261         <span class="comment">// jetzt schalte um</span>
01262         page = newFirstLeft;
01263         pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01264         header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01265         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01266 
01267         <span class="comment">// setze Soehne bis Median auf neuen Knoten</span>
01268         rc = <a class="code" href="class_dbj_b_tree.html#d5">setFather</a>(<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a>, pageId);
01269         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01270             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01271             <span class="keywordflow">goto</span> cleanup;
01272         }
01273         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; median; i++) {
01274             rc = <a class="code" href="class_dbj_b_tree.html#d5">setFather</a>(<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i), pageId);
01275             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01276                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01277                 <span class="keywordflow">goto</span> cleanup;
01278             }
01279         }
01280 
01281         <span class="comment">// die neue Seite muss nun noch auf den neuen Vater zeigen</span>
01282         rc = <a class="code" href="class_dbj_b_tree.html#d5">setFather</a>(keyPageId, pageId);
01283         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01284             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01285             <span class="keywordflow">goto</span> cleanup;
01286         }
01287     }
01288 
01289     <span class="comment">// hole neue Seite</span>
01290     rc = <a class="code" href="class_dbj_b_tree.html#d8">getFreePage</a>(newPage);
01291     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01292         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01293         <span class="keywordflow">goto</span> cleanup;
01294     }
01295     newPageId = newPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01296 
01297     <span class="comment">// initialisiere neuen Seite</span>
01298     header = reinterpret_cast&lt;Header *&gt;(newPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01299     header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>;
01300     newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01301     newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> = 0;
01302 
01303     <span class="comment">// neue Seite hat den gleichen Vater wie die alte</span>
01304     newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a> = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a>;
01305 
01306     medianKey = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(median);
01307     fatherId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a>;
01308 
01309     <span class="comment">// kopieren der Eintraege ab Median in die neue Seite</span>
01310     newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a> = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(median);
01311     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = median + 1, j = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>;
01312          i++, j++) {
01313         newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a3">setKey</a>(j, <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i));
01314         newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a2">setReference</a>(j, <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i));
01315         newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>++;
01316     }
01317     <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> = median;
01318 
01319     <span class="comment">// die Vater-Verweise aller Soehne des neuen Knotens korrigieren</span>
01320     rc = <a class="code" href="class_dbj_b_tree.html#d5">setFather</a>(newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a>, newPageId);
01321     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01322         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01323         <span class="keywordflow">goto</span> cleanup;
01324     }
01325     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>; i++) {
01326         rc = <a class="code" href="class_dbj_b_tree.html#d5">setFather</a>(newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i), newPageId);
01327         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01328             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01329             <span class="keywordflow">goto</span> cleanup;
01330         }
01331     }
01332 
01333     <span class="comment">// einfuegen des eigentlich einzufuegenden Elements (in der jeweiligen</span>
01334     <span class="comment">// Seite ist nun auf jeden Fall genug Platz)</span>
01335     <span class="keywordflow">if</span> (key &gt;= newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(0)) {
01336         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> idx = 0;
01337         <span class="keywordflow">while</span> (idx &lt; newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> &amp;&amp;
01338                 newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(idx) &lt; key) {
01339             idx++;
01340         }
01341         newInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(idx, key, keyPageId);
01342 
01343         <span class="comment">// die neue Seite muss nun noch auf den richtigen Vater zeigen</span>
01344         rc = <a class="code" href="class_dbj_b_tree.html#d5">setFather</a>(keyPageId, newPageId);
01345         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01346             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01347             <span class="keywordflow">goto</span> cleanup;
01348         }
01349     }
01350     <span class="keywordflow">else</span> {
01351         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> idx = 0;
01352         <span class="keywordflow">while</span> (idx &lt; <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> &amp;&amp;
01353                 <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(idx) &lt; key) {
01354             idx++;
01355         }
01356         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a4">insertEntry</a>(idx, key, keyPageId);
01357     }
01358 
01359     <span class="comment">// gib neu angeforderte Seite und die urspruengliche Seite frei</span>
01360     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newPage);
01361     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01362         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01363         <span class="keywordflow">goto</span> cleanup;
01364     }
01365     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01366     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01367         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01368         <span class="keywordflow">goto</span> cleanup;
01369     }
01370 
01371     <span class="comment">// Median in den Vater einfuegen</span>
01372     rc = <a class="code" href="class_dbj_b_tree.html#d2">insertIntoInnerNode</a>(fatherId, medianKey, newPageId, pageId);
01373     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01374         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01375         <span class="keywordflow">goto</span> cleanup;
01376     }
01377 
01378  cleanup:
01379     <span class="keywordflow">if</span> (page != NULL) {
01380         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01381     }
01382     <span class="keywordflow">if</span> (newPage != NULL) {
01383         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newPage);
01384     }
01385     <span class="keywordflow">if</span> (inventoryPage != NULL) {
01386         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(inventoryPage);
01387     }
01388     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01389 }
01390 
01391 
01392 <span class="comment">// Setze Vater-Verweis</span>
<a name="l01393"></a><a class="code" href="class_dbj_b_tree.html#d5">01393</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d5">DbjBTree::setFather</a>(<span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId, <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newFather)
01394 {
01395     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01396     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
01397     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
01398     <a class="code" href="class_dbj_b_tree_1_1_node.html">Leaf</a> *sonLeaf = NULL;
01399     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">LeafSint32</a> sonIntLeaf;
01400     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">LeafVarchar</a> sonVcLeaf;
01401     <a class="code" href="class_dbj_b_tree_1_1_node.html">Inner</a> *sonInnerNode = NULL;
01402     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">InnerSint32</a> sonIntInnerNode;
01403     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">InnerVarchar</a> sonVcInnerNode;
01404 
01405     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01406 
01407     <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>) {
01408       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
01409           sonLeaf = &amp;sonIntLeaf;
01410           sonInnerNode = &amp;sonIntInnerNode;
01411           <span class="keywordflow">break</span>;
01412       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
01413           sonLeaf = &amp;sonVcLeaf;
01414           sonInnerNode = &amp;sonVcInnerNode;
01415           <span class="keywordflow">break</span>;
01416       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>:
01417           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01418           <span class="keywordflow">break</span>;
01419     }
01420 
01421     <span class="comment">// hole Seite</span>
01422     rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, pageId, DbjLockManager::ExclusiveLock);
01423     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01424         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01425         <span class="keywordflow">goto</span> cleanup;
01426     }
01427     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, pageId, DbjPage::BTreeIndexPage, page);
01428     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01429         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01430         <span class="keywordflow">goto</span> cleanup;
01431     }
01432 
01433     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01434     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01435         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01436         <span class="keywordflow">goto</span> cleanup;
01437     }
01438 
01439     <span class="comment">// setze neuen Vater-Verweis</span>
01440     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01441     <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> == <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>) {
01442         sonInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01443         sonInnerNode-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a> = newFather;
01444     }
01445     <span class="keywordflow">else</span> {
01446         sonLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01447         sonLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a> = newFather;
01448     }
01449 
01450  cleanup:
01451     <span class="keywordflow">if</span> (page != NULL) {
01452         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01453     }
01454     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01455 }
01456 
<a name="l01457"></a><a class="code" href="class_dbj_b_tree.html#d6">01457</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d6">DbjBTree::deleteEmptyLeaf</a>(<a class="code" href="class_dbj_page.html">DbjPage</a> *page)
01458 {
01459     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01460     <a class="code" href="struct_dbj_b_tree_1_1_header.html">Header</a> *header = NULL;
01461     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId = 0;
01462     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fatherPageId = 0;
01463     <a class="code" href="class_dbj_page.html">DbjPage</a> *fatherPage = NULL;
01464     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> brotherPageId = 0;
01465     <a class="code" href="class_dbj_page.html">DbjPage</a> *brotherPage = NULL;
01466     <a class="code" href="class_dbj_b_tree_1_1_node.html">Leaf</a> *brotherLeaf = NULL;
01467     <a class="code" href="class_dbj_b_tree_1_1_node_sint32.html">LeafSint32</a> brotherIntLeaf;
01468     <a class="code" href="class_dbj_b_tree_1_1_node_varchar.html">LeafVarchar</a> brotherVcLeaf;
01469 
01470     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01471 
01472     <span class="comment">// darf nie auf Inventory oder Wurzel aufgerufen werden</span>
01473     <span class="keywordflow">if</span> (!page || page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() == 0 || page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() == <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>) {
01474         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01475         <span class="keywordflow">goto</span> cleanup;
01476     }
01477 
01478     pageId = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01479     <span class="comment">// fuege seite dem freespaceinventory zu</span>
01480     rc = <a class="code" href="class_dbj_b_tree.html#d9">addToFsi</a>(pageId);
01481     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01482         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01483         <span class="keywordflow">goto</span> cleanup;
01484     }
01485 
01486     <span class="comment">// jetzt korrigiere die Verkettungen im Baum</span>
01487     fatherPageId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a>;
01488     header = reinterpret_cast&lt;Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01489     <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>) {
01490       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
01491           brotherLeaf = &amp;brotherIntLeaf;
01492           <span class="keywordflow">break</span>;
01493       <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
01494           brotherLeaf = &amp;brotherVcLeaf;
01495           <span class="keywordflow">break</span>;
01496       <span class="keywordflow">default</span>:
01497           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01498           <span class="keywordflow">goto</span> cleanup;
01499     }
01500     <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01501 
01502     <span class="comment">// korrigiere Verkettung des linken Bruders</span>
01503     brotherPageId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a>;
01504     <span class="keywordflow">if</span> (brotherPageId != pageId){
01505         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
01506                 DbjLockManager::ExclusiveLock);
01507         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01508             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01509             <span class="keywordflow">goto</span> cleanup;
01510         }
01511         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
01512                 DbjPage::BTreeIndexPage, brotherPage);
01513         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01514             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01515             <span class="keywordflow">goto</span> cleanup;
01516         }
01517 
01518         header = reinterpret_cast&lt;Header *&gt;(brotherPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01519         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
01520             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01521             <span class="keywordflow">goto</span> cleanup;
01522         }
01523         brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01524 
01525         rc = brotherPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01526         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01527             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01528             <span class="keywordflow">goto</span> cleanup;
01529         }
01530 
01531         <span class="comment">// zu loeschendes Blatt hat keinen rechten Bruder, also muss der linke</span>
01532         <span class="comment">// Bruder nun auf sich selber zeigen</span>
01533         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> == pageId) {
01534             brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = brotherPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01535         }
01536         <span class="keywordflow">else</span> {
01537             brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> =
01538                 <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a>;
01539         }
01540 
01541         <span class="comment">// linken Bruder freigeben</span>
01542         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
01543         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01544             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01545             <span class="keywordflow">goto</span> cleanup;
01546         }
01547     }
01548 
01549     <span class="comment">// korrigiere Verkettung des rechten Bruders</span>
01550     brotherPageId = <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a>;
01551     <span class="keywordflow">if</span> (brotherPageId != pageId){
01552         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
01553                 DbjLockManager::ExclusiveLock);
01554         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01555             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01556             <span class="keywordflow">goto</span> cleanup;
01557         }
01558         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, brotherPageId,
01559                 DbjPage::BTreeIndexPage, brotherPage);
01560         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01561             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01562             <span class="keywordflow">goto</span> cleanup;
01563         }
01564 
01565         header = reinterpret_cast&lt;Header *&gt;(brotherPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01566         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>) {
01567             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01568             <span class="keywordflow">goto</span> cleanup;
01569         }
01570         brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01571 
01572         rc = brotherPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01573         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01574             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01575             <span class="keywordflow">goto</span> cleanup;
01576         }
01577 
01578         <span class="comment">// zu loeschendes Blatt hat keinen linken Bruder, also muss der rechte</span>
01579         <span class="comment">// Bruder nun auf sich selber zeigen</span>
01580         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> == pageId) {
01581             brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> = brotherPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01582         }
01583         <span class="keywordflow">else</span> {
01584             brotherLeaf-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> =
01585                 <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a>;
01586         }
01587 
01588         <span class="comment">// rechten Bruder freigeben</span>
01589         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
01590         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01591             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01592             <span class="keywordflow">goto</span> cleanup;
01593         }
01594     }
01595 
01596     <span class="comment">// propagiere Aenderung zu den Vaetern (wenn welche da sind)</span>
01597     <span class="keywordflow">while</span> (fatherPageId != 0) {
01598         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, fatherPageId,
01599                 DbjLockManager::ExclusiveLock);
01600         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01601             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01602             <span class="keywordflow">goto</span> cleanup;
01603         }
01604         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, fatherPageId,
01605                 DbjPage::BTreeIndexPage, fatherPage);
01606         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01607             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01608             <span class="keywordflow">goto</span> cleanup;
01609         }
01610         fatherPageId = 0;
01611 
01612         header = reinterpret_cast&lt;Header *&gt;(fatherPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01613         <span class="keywordflow">if</span> (header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != <a class="code" href="class_dbj_b_tree.html#w8w6">InnerNode</a>) {
01614             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01615             <span class="keywordflow">goto</span> cleanup;
01616         }
01617         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01618 
01619         rc = fatherPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01620         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01621             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01622             <span class="keywordflow">goto</span> cleanup;
01623         }
01624 
01625         <span class="comment">// innere Knoten sind nie leer (ausser der Wurzel, die ein Blatt wird)</span>
01626         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> == 0) {
01627             <span class="keywordflow">if</span> (fatherPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() != <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>) {
01628                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01629                 <span class="keywordflow">goto</span> cleanup;
01630             }
01631 
01632             <span class="comment">// Wurzel ist leer - aendere Typ zu Blatt und initialisiere neu</span>
01633             header-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> = <a class="code" href="class_dbj_b_tree.html#w8w7">LeafNode</a>;
01634             <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(header + 1);
01635             <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o0">countEntry</a> = 0;
01636             <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o1">father</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
01637             <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o2">leftBrother</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
01638             <a class="code" href="class_dbj_b_tree.html#r4">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_leaf_node_header.html#o3">rightBrother</a> = <a class="code" href="class_dbj_b_tree.html#v0">ROOT_PAGE_ID</a>;
01639         }
01640         <span class="keywordflow">else</span> {
01641             <span class="keywordflow">if</span> (page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>() == <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a>) {
01642                 <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o0">firstLeft</a> = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(0);
01643                 <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a5">deleteEntry</a>(0);
01644             }
01645             <span class="keywordflow">else</span> {
01646                 <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a>; i++) {
01647                     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(i) == page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>()) {
01648                         <span class="comment">// Jetzt sind wir an der Stelle wo der Verweis im</span>
01649                         <span class="comment">// Vater zum geloeschten Sohn steht.</span>
01650                         <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a5">deleteEntry</a>(i);
01651 
01652                         <span class="comment">// und weiter aufwaerts im Baum...</span>
01653                         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o1">countEntry</a> == 0) {
01654                             pageId = fatherPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
01655                             fatherPageId = <a class="code" href="class_dbj_b_tree.html#r7">innerNode</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inner_node_header.html#o2">father</a>;
01656                         }
01657                         <span class="keywordflow">break</span>;
01658                     }
01659                 }
01660             }
01661         }
01662 
01663         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(fatherPage);
01664         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01665             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01666             <span class="keywordflow">goto</span> cleanup;
01667         }
01668     }
01669 
01670  cleanup:
01671     <span class="keywordflow">if</span> (brotherPage != NULL) {
01672         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(brotherPage);
01673     }
01674     <span class="keywordflow">if</span> (fatherPage != NULL) {
01675         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(fatherPage);
01676     }
01677     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01678 }
01679 
01680 
01681 <span class="comment">// Gib neue freie Seite zurueck</span>
<a name="l01682"></a><a class="code" href="class_dbj_b_tree.html#d8">01682</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d8">DbjBTree::getFreePage</a>(<a class="code" href="class_dbj_page.html">DbjPage</a> *&amp;newPage)
01683 {
01684     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01685     <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *inventory = NULL;
01686     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newPageId = 0;
01687     <a class="code" href="class_dbj_page.html">DbjPage</a> *inventoryPage = NULL;
01688     <a class="code" href="class_dbj_page.html">DbjPage</a> *prevInvPage = NULL;
01689     <a class="code" href="class_dbj_page.html">DbjPage</a> *nextInvPage = NULL;
01690 
01691     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01692 
01693     <span class="comment">// FSI-Seite sperren</span>
01694     rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, 0, DbjLockManager::ExclusiveLock);
01695     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01696         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01697         <span class="keywordflow">goto</span> cleanup;
01698     }
01699     rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, 0, DbjPage::FreeSpaceInventoryPage,
01700             inventoryPage);
01701     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01702         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01703         <span class="keywordflow">goto</span> cleanup;
01704     }
01705     inventory = reinterpret_cast&lt;Inventory *&gt;(inventoryPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01706 
01707     rc = inventoryPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01708     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01709         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01710         <span class="keywordflow">goto</span> cleanup;
01711     }
01712 
01713     <span class="comment">// falls keine Eintraege fuer bereits geloeschte Seiten vorhanden sind,</span>
01714     <span class="comment">// komplett neue Seite anfordern</span>
01715     <span class="keywordflow">if</span> (inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a> == 0) {
01716         newPageId = inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a>;
01717         <span class="keywordflow">if</span> (newPageId == DBJ_MAX_PAGE_ID) {
01718             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a65">DBJ_IM_NO_MORE_PAGES</a>, <a class="code" href="class_dbj_b_tree.html#r0">indexId</a>);
01719             <span class="keywordflow">goto</span> cleanup;
01720         }
01721 
01722         <span class="comment">// fordere neue Seite an (Sperre vorher)</span>
01723         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, newPageId,
01724                 DbjLockManager::ExclusiveLock);
01725         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01726             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01727             <span class="keywordflow">goto</span> cleanup;
01728         }
01729         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getNewPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, newPageId,
01730                 DbjPage::BTreeIndexPage, newPage);
01731         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01732             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01733             <span class="keywordflow">goto</span> cleanup;
01734         }
01735 
01736         <span class="comment">// zaehle Seite</span>
01737         inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a>++;
01738     }
01739     <span class="keywordflow">else</span> {
01740         <span class="comment">// wir koennen eine vorher freigegebene Seite wiederverwenden (wir</span>
01741         <span class="comment">// nehmen die zuletzt freigegebene Seite, die auf FSI 0 vermerkt ist)</span>
01742         newPageId = inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o4">entries</a>[inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a> - 1];
01743         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, newPageId,
01744                 DbjLockManager::ExclusiveLock);
01745         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01746             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01747             <span class="keywordflow">goto</span> cleanup;
01748         }
01749         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, newPageId,
01750                 DbjPage::BTreeIndexPage, newPage);
01751         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01752             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01753             <span class="keywordflow">goto</span> cleanup;
01754         }
01755         inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a>--;
01756 
01757         <span class="comment">// reorganisiere FSI wenn Seite 0 keine weiteren leeren Seiten</span>
01758         <span class="comment">// vermerkt hat, es aber eine weitere FSI-Seite gibt</span>
01759         <span class="keywordflow">if</span> (inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a> == 0 &amp;&amp;
01760                 inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a> != inventoryPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>()) {
01761             <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *prevInv = NULL;
01762             <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *nextInv = NULL;
01763 
01764             <span class="comment">// kopiere Daten der Seite von der nachfolgenden FSI-Seite auf die</span>
01765             <span class="comment">// vorhergehende</span>
01766             nextInv = inventory;
01767             nextInvPage = inventoryPage;
01768             inventoryPage = NULL;
01769 
01770             <span class="keywordflow">while</span> (nextInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a> != nextInvPage-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>()) {
01771                 prevInvPage = nextInvPage;
01772                 nextInvPage = NULL;
01773                 prevInv = nextInv;
01774                 nextInv = NULL;
01775 
01776                 <span class="comment">// hole naechste FSI Seite</span>
01777                 rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, prevInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a>, 
01778                         DbjLockManager::ExclusiveLock);
01779                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01780                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01781                     <span class="keywordflow">goto</span> cleanup;
01782                 }
01783                 rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, prevInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a>,
01784                         DbjPage::BTreeIndexPage, nextInvPage);
01785                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01786                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01787                     <span class="keywordflow">goto</span> cleanup;
01788                 }
01789                 nextInv = reinterpret_cast&lt;Inventory *&gt;(
01790                         nextInvPage-&gt;getPageData());
01791 
01792                 <span class="keywordflow">if</span> (nextInv-&gt;deletedPages &gt; 0) {
01793                     <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(prevInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o4">entries</a>, nextInv-&gt;entries,
01794                             nextInv-&gt;deletedPages * <span class="keyword">sizeof</span>(<a class="code" href="group__id__datatypes.html#ga0">PageId</a>));
01795                     rc = nextInvPage-&gt;markAsModified();
01796                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01797                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01798                         <span class="keywordflow">goto</span> cleanup;
01799                     }
01800                     nextInv-&gt;deletedPages = 0;
01801                 }
01802                 <span class="keywordflow">else</span> {
01803                     <span class="keywordflow">break</span>;
01804                 }
01805 
01806                 <span class="comment">// gebe alte Seite frei</span>
01807                 rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(prevInvPage);
01808                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01809                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01810                     <span class="keywordflow">goto</span> cleanup;
01811                 }
01812             }
01813         } <span class="comment">// Ende Schleife ueber FSI-Seiten</span>
01814     }
01815 
01816  cleanup:
01817     <span class="keywordflow">if</span> (prevInvPage != NULL) {
01818         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(prevInvPage);
01819     }
01820     <span class="keywordflow">if</span> (nextInvPage != NULL) {
01821         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(nextInvPage);
01822     }
01823     <span class="keywordflow">if</span> (inventoryPage != NULL) {
01824         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(inventoryPage);
01825     }
01826     <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; newPage != NULL) {
01827         <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newPage);
01828     }
01829     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01830 }
01831 
01832 
01833 <span class="comment">// Fuege Seite zum FSI hinzu</span>
<a name="l01834"></a><a class="code" href="class_dbj_b_tree.html#d9">01834</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree.html#d9">DbjBTree::addToFsi</a>(<span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId)
01835 {
01836     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01837     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fsiPageId = 0;
01838     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> numPages = 0;
01839     <a class="code" href="class_dbj_page.html">DbjPage</a> *fsiPage = NULL;
01840     <a class="code" href="class_dbj_page.html">DbjPage</a> *newFsiPage = NULL;
01841     <a class="code" href="class_dbj_page.html">DbjPage</a> *rootFsiPage = NULL;
01842 
01843     <span class="keywordflow">if</span> (pageId == 0) {
01844         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01845         <span class="keywordflow">goto</span> cleanup;
01846     }
01847 
01848     <span class="keywordflow">for</span> (;;) {
01849         <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *inventory = NULL;
01850 
01851         <span class="comment">// Inventory-Seite holen</span>
01852         rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, fsiPageId,
01853                 DbjLockManager::ExclusiveLock);
01854         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01855             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01856             <span class="keywordflow">goto</span> cleanup;
01857         }
01858         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, fsiPageId,
01859                 DbjPage::FreeSpaceInventoryPage, fsiPage);
01860         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01861             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01862             <span class="keywordflow">goto</span> cleanup;
01863         }
01864         inventory = reinterpret_cast&lt;Inventory *&gt;(fsiPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01865 
01866         <span class="comment">// ist diese FSI-Seite noch nicht voll, dann tragen wir die gegebene</span>
01867         <span class="comment">// Seiten-ID hier gleich ein</span>
01868         <span class="keywordflow">if</span> (inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a> &lt; <a class="code" href="class_dbj_b_tree.html#s0">NUM_FSI_ENTRIES</a>) {
01869             <span class="comment">// Seiten-ID eintragen</span>
01870             rc = fsiPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01871             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01872                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01873                 <span class="keywordflow">goto</span> cleanup;
01874             }
01875             inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o4">entries</a>[inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a>] = pageId;
01876             inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a>++;
01877             <span class="keywordflow">goto</span> cleanup;
01878         }
01879 
01880         <span class="comment">// falls wir das FSI erweitern muessen, brauchen wir die Anzahl der</span>
01881         <span class="comment">// Seiten im Segment, und die steht nur auf Seite 0</span>
01882         <span class="keywordflow">if</span> (fsiPageId == 0) {
01883             numPages = inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a>;
01884         }
01885 
01886         <span class="keywordflow">if</span> (fsiPageId == inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a>) {
01887             <a class="code" href="group__id__datatypes.html#ga0">PageId</a> newFsiPageId = numPages;
01888             <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *newInv = NULL;
01889 
01890             <span class="comment">// neue FSI-Seite anlegen</span>
01891             rc = <a class="code" href="class_dbj_b_tree.html#r11">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, newFsiPageId,
01892                     DbjLockManager::ExclusiveLock);
01893             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01894                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01895                 <span class="keywordflow">goto</span> cleanup;
01896             }
01897             rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getNewPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, newFsiPageId,
01898                     DbjPage::FreeSpaceInventoryPage, newFsiPage);
01899             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01900                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01901                 <span class="keywordflow">goto</span> cleanup;
01902             }
01903             newInv = reinterpret_cast&lt;Inventory *&gt;(
01904                     newFsiPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01905             newInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a> = 0; <span class="comment">// wird nicht genutzt</span>
01906             newInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o2">deletedPages</a> = 0;
01907             newInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a> = newFsiPageId; <span class="comment">// zeigt auf sich selbst</span>
01908             <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree.html#s0">NUM_FSI_ENTRIES</a>; i++) {
01909                 newInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o4">entries</a>[i] = 0;
01910             }
01911 
01912             <span class="comment">// gegebene Seite gleich in neue FSI-Seite eintragen</span>
01913             newInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o4">entries</a>[0] = pageId;
01914             rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newFsiPage);
01915             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01916                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01917                 <span class="keywordflow">goto</span> cleanup;
01918             }
01919 
01920             <span class="comment">// Verkettung zur vorherigen FSI-Seite anlegen</span>
01921             rc = fsiPage-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
01922             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01923                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01924                 <span class="keywordflow">goto</span> cleanup;
01925             }
01926             inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a> = newFsiPageId;
01927 
01928             <span class="comment">// neue FSI-Seite auf FSI-Seite 0 zaehlen</span>
01929             <span class="keywordflow">if</span> (fsiPageId == 0) {
01930                 inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a>++;
01931             }
01932             <span class="keywordflow">else</span> {
01933                 <a class="code" href="struct_dbj_b_tree_1_1_inventory.html">Inventory</a> *rootInv = NULL;
01934                 rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>, 0,
01935                         DbjPage::FreeSpaceInventoryPage, rootFsiPage);
01936                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01937                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01938                     <span class="keywordflow">goto</span> cleanup;
01939                 }
01940                 rootInv = reinterpret_cast&lt;Inventory *&gt;(
01941                         rootFsiPage-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01942                 rootInv-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o1">pages</a>++;
01943                 rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(rootFsiPage);
01944                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01945                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01946                     <span class="keywordflow">goto</span> cleanup;
01947                 }
01948             }
01949         }
01950 
01951         <span class="comment">// naechste FSI-Seite bearbeiten</span>
01952         fsiPageId = inventory-&gt;<a class="code" href="struct_dbj_b_tree_1_1_inventory.html#o3">nextFsiPage</a>;
01953 
01954         <span class="comment">// aktuelle FSI-Seite freigeben</span>
01955         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(fsiPage);
01956         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01957             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01958             <span class="keywordflow">goto</span> cleanup;
01959         }
01960     }
01961 
01962  cleanup:
01963     <span class="keywordflow">if</span> (newFsiPage != NULL) {
01964         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(newFsiPage);
01965     }
01966     <span class="keywordflow">if</span> (fsiPage != NULL) {
01967         rc = <a class="code" href="class_dbj_b_tree.html#r10">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(fsiPage);
01968     }
01969     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01970 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:28 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
