<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjBTreeIterator.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjBTreeIterator.cpp</h1><a href="_dbj_b_tree_iterator_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2005                                                              *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="_dbj_b_tree_iterator_8hpp.html">DbjBTreeIterator.hpp</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="_dbj_buffer_manager_8hpp.html">DbjBufferManager.hpp</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="_dbj_lock_manager_8hpp.html">DbjLockManager.hpp</a>"</span>
00014 
<a name="l00015"></a><a class="code" href="_dbj_b_tree_iterator_8cpp.html#a0">00015</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="_dbj_b_tree_iterator_8cpp.html#a0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a7">IndexManager</a>;
00016 
<a name="l00017"></a><a class="code" href="class_dbj_b_tree_iterator.html#v0">00017</a> <span class="keywordtype">char</span> <a class="code" href="class_dbj_b_tree_iterator.html#v0">DbjBTreeIterator::EMPTY_STRING</a>[1] = { <span class="charliteral">'\0'</span> };
00018 
00019 
00020 <span class="comment">// Konstruktor</span>
<a name="l00021"></a><a class="code" href="class_dbj_b_tree_iterator.html#a0">00021</a> <a class="code" href="class_dbj_b_tree_iterator.html#a0">DbjBTreeIterator::DbjBTreeIterator</a>(<a class="code" href="class_dbj_b_tree.html">DbjBTree</a> *bt,
00022         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> *start, <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> *stop)
00023     : segmentId(0), dataType(<a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>), startPage(0), startSlot(0),
00024       currentPage(0), currentSlot(0), startKey(), stopKey(),
00025       leaf(NULL), intLeaf(), vcLeaf(), btree(bt), bufferMgr(NULL)
00026                                    
00027 {
00028     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00029     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00030 
00031     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00032 
00033     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree_iterator.html#r11">btree</a>) {
00034         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00035         <span class="keywordflow">return</span>;
00036     }
00037     <a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a> = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00038     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a>) {
00039         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00040         <span class="keywordflow">return</span>;
00041     }
00042 
00043     <a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a> = bt-&gt;<a class="code" href="class_dbj_b_tree.html#r1">segmentId</a>;
00044     <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a> = bt-&gt;<a class="code" href="class_dbj_b_tree.html#r3">dataType</a>;
00045 
00046     <span class="comment">// setze Start-Schluesselwert</span>
00047     <span class="keywordflow">if</span> (!start) {
00048         <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>;
00049         <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00050           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>: <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = DBJ_MIN_SINT32; <span class="keywordflow">break</span>;
00051           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>: <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = <a class="code" href="class_dbj_b_tree_iterator.html#v0">EMPTY_STRING</a>; <span class="keywordflow">break</span>;
00052           <span class="keywordflow">default</span>: <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>); <span class="keywordflow">return</span>;
00053         }
00054     }
00055     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (start-&gt;<a class="code" href="class_dbj_index_key.html#o0">dataType</a> != <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00056         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00057         <span class="keywordflow">return</span>;
00058     }
00059     <span class="keywordflow">else</span> {
00060         <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>;
00061         <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00062           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>: <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = start-&gt;<a class="code" href="class_dbj_index_key.html#o1">intKey</a>; <span class="keywordflow">break</span>;
00063           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
00064               {
00065                   <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> keyLen = strlen(start-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>) + 1;
00066                   <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[keyLen];
00067                   <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>) {
00068                       <span class="keywordflow">return</span>;
00069                   }
00070                   <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>, start-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>, keyLen);
00071               }
00072               <span class="keywordflow">break</span>;
00073           <span class="keywordflow">default</span>: <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>); <span class="keywordflow">return</span>;
00074         }
00075     }
00076     <span class="comment">// setze Stop-Schluesselwert</span>
00077     <span class="keywordflow">if</span> (!stop) {
00078         <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>;
00079         <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00080           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>: <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = DBJ_MAX_SINT32; <span class="keywordflow">break</span>;
00081           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>: <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL; <span class="keywordflow">break</span>;
00082           <span class="keywordflow">default</span>: <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>); <span class="keywordflow">return</span>;
00083         }
00084     }
00085     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stop-&gt;<a class="code" href="class_dbj_index_key.html#o0">dataType</a> != <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00086         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00087         <span class="keywordflow">return</span>;
00088     }
00089     <span class="keywordflow">else</span> {
00090         <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>;
00091         <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00092           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>: <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = stop-&gt;<a class="code" href="class_dbj_index_key.html#o1">intKey</a>; <span class="keywordflow">break</span>;
00093           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
00094               {
00095                   <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> keyLen = strlen(stop-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>) + 1;
00096                   <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[keyLen];
00097                   <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>) {
00098                       <span class="keywordflow">return</span>;
00099                   }
00100                   <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>, stop-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>, keyLen);
00101               }
00102               <span class="keywordflow">break</span>;
00103           <span class="keywordflow">default</span>: <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>); <span class="keywordflow">return</span>;
00104         }
00105     }
00106     <span class="comment">// kann eigentlich nie passieren!</span>
00107     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> != <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o0">dataType</a>) {
00108         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00109         <span class="keywordflow">return</span>;
00110     }
00111     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a> &gt; <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>) {
00112         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00113         <span class="keywordflow">return</span>;
00114     }
00115 
00116     <span class="comment">// finde Start-Seite und Start-Slot</span>
00117     {
00118         <span class="keywordtype">bool</span> foundStart = <span class="keyword">false</span>;
00119 
00120         <span class="comment">// bestimme Startseite des Index-Scans</span>
00121         rc = <a class="code" href="class_dbj_b_tree_iterator.html#r11">btree</a>-&gt;<a class="code" href="class_dbj_b_tree.html#d0">findLeaf</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>, page);
00122         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00123             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00124             <span class="keywordflow">return</span>;
00125         }
00126         <a class="code" href="class_dbj_b_tree_iterator.html#r2">startPage</a> = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
00127 
00128         <span class="comment">// pruefe, ob wir wirklich auf einem Blatt gelandet sind</span>
00129         <a class="code" href="struct_dbj_b_tree_1_1_header.html">DbjBTree::Header</a> *pageHeader =
00130             reinterpret_cast&lt;DbjBTree::Header *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00131         <span class="keywordflow">if</span> (pageHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != DbjBTree::LeafNode) {
00132             <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a63">DBJ_IM_NO_LEAF_PAGE</a>, <a class="code" href="class_dbj_b_tree_iterator.html#r2">startPage</a>, <a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a>,
00133                     pageHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a>);
00134             <span class="keywordflow">goto</span> cleanup;
00135         }
00136 
00137         <span class="comment">// finde ersten Slot auf der Startseite, fuer den gilt, dass der</span>
00138         <span class="comment">// Schluesselwert &gt;= "startKey" ist</span>
00139         <span class="keywordflow">switch</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a>) {
00140           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>:
00141               <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a> = &amp;<a class="code" href="class_dbj_b_tree_iterator.html#r9">intLeaf</a>;
00142               <span class="keywordflow">break</span>;
00143           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>:
00144               <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a> = &amp;<a class="code" href="class_dbj_b_tree_iterator.html#r10">vcLeaf</a>;
00145               <span class="keywordflow">break</span>;
00146           <span class="keywordflow">default</span>:
00147               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00148               <span class="keywordflow">goto</span> cleanup;
00149         }
00150         <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(pageHeader + 1);
00151         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;countEntry; i++) {
00152             <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(i) &gt;= <a class="code" href="class_dbj_b_tree_iterator.html#r6">startKey</a>) {
00153                 <a class="code" href="class_dbj_b_tree_iterator.html#r3">startSlot</a> = i;
00154                 foundStart = <span class="keyword">true</span>;
00155                 <span class="keywordflow">break</span>;
00156             }
00157         }
00158         <span class="keywordflow">if</span> (!foundStart || <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r3">startSlot</a>) &gt; <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>) {
00159             <a class="code" href="class_dbj_b_tree_iterator.html#r2">startPage</a> = 0;
00160         }
00161     }
00162 
00163     rc = <a class="code" href="class_dbj_b_tree_iterator.html#a4">reset</a>();
00164     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00165         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00166         <span class="keywordflow">goto</span> cleanup;
00167     }
00168 
00169  cleanup:
00170     <span class="keywordflow">if</span> (page != NULL) {
00171         <a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00172     }
00173     <span class="keywordflow">return</span>;
00174 }
00175 
00176 
00177 <span class="comment">// Gib naechste Tupel-ID</span>
<a name="l00178"></a><a class="code" href="class_dbj_b_tree_iterator.html#a3">00178</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree_iterator.html#a3">DbjBTreeIterator::getNextTupleId</a>(<a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00179 {
00180     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00181     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00182     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> oldPage = 0;
00183     <a class="code" href="struct_dbj_b_tree_1_1_header.html">DbjBTree::Header</a> *pageHeader = NULL;
00184 
00185     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00186 
00187     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r4">currentPage</a> == 0) {
00188         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00189         <span class="keywordflow">goto</span> cleanup;
00190     }
00191 
00192     rc = <a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a>, <a class="code" href="class_dbj_b_tree_iterator.html#r4">currentPage</a>,
00193             DbjPage::BTreeIndexPage, page);
00194     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00195         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00196         <span class="keywordflow">goto</span> cleanup;
00197     }
00198     oldPage = <a class="code" href="class_dbj_b_tree_iterator.html#r4">currentPage</a>;
00199 
00200     <span class="comment">// pruefe ob wir ein Blatt haben und interpretiere es entsprechend des</span>
00201     <span class="comment">// Datentyps der Schluessel</span>
00202     pageHeader = reinterpret_cast&lt;DbjBTree::Header *&gt;(
00203             page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00204     <span class="keywordflow">if</span> (pageHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != DbjBTree::LeafNode) {
00205         <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a63">DBJ_IM_NO_LEAF_PAGE</a>, currentPage, <a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a>,
00206                 pageHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a>);
00207         <span class="keywordflow">goto</span> cleanup;
00208     }
00209     <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(pageHeader + 1);
00210     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a> &gt;= <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;countEntry) {
00211         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00212         <span class="keywordflow">goto</span> cleanup;
00213     }
00214 
00215     <span class="comment">// setze Ergebnis fuer diesen Aufruf</span>
00216     tid = <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a6">getReference</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a>);
00217 
00218     <span class="comment">// setze auf naechsten Eintrag in der aktuellen Seite</span>
00219     <a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a>++;
00220 
00221     <span class="comment">// gehe zur naechsten Seite wenn wir alle Eintraege auf der aktuellen</span>
00222     <span class="comment">// Seite bereits verarbeitet haben</span>
00223     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a> &gt;= <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;countEntry) {
00224         <a class="code" href="class_dbj_lock_manager.html">DbjLockManager</a> *lockMgr = <a class="code" href="class_dbj_lock_manager.html#e0">DbjLockManager::getInstance</a>();
00225         <span class="keywordflow">if</span> (!lockMgr) {
00226             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00227             <span class="keywordflow">goto</span> cleanup;
00228         }
00229 
00230         <span class="comment">// Ende des Index erreicht</span>
00231         <span class="keywordflow">if</span> (currentPage == <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;rightBrother) {
00232             currentPage = 0;
00233             <span class="keywordflow">goto</span> cleanup;
00234         }
00235 
00236         <span class="comment">// gehe zur naechsten Seite, erster Eintrag</span>
00237         currentPage = <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;rightBrother;
00238         <a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a> = 0;
00239 
00240         <span class="comment">// gib alte Seite frei</span>
00241         rc = <a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00242         oldPage = 0;
00243         page = NULL;
00244         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00245             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00246             <span class="keywordflow">goto</span> cleanup;
00247         }
00248 
00249         <span class="comment">// sperre neue Seite</span>
00250         rc = lockMgr-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a>, currentPage,
00251                 DbjLockManager::SharedLock);
00252         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00253             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00254             <span class="keywordflow">goto</span> cleanup;
00255         }
00256 
00257         rc = <a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a>, currentPage,
00258                 DbjPage::BTreeIndexPage, page);
00259         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00260             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00261             <span class="keywordflow">goto</span> cleanup;
00262         }
00263         oldPage = currentPage;
00264 
00265         <span class="comment">// pruefe ob wir ein Blatt haben und interpretiere es entsprechend des</span>
00266         <span class="comment">// Datentyps der Schluessel</span>
00267         pageHeader = reinterpret_cast&lt;DbjBTree::Header *&gt;(
00268                 page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00269         <span class="keywordflow">if</span> (pageHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a> != DbjBTree::LeafNode) {
00270             <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a63">DBJ_IM_NO_LEAF_PAGE</a>, currentPage, <a class="code" href="class_dbj_b_tree_iterator.html#r0">segmentId</a>,
00271                     pageHeader-&gt;<a class="code" href="struct_dbj_b_tree_1_1_header.html#o1">type</a>);
00272             <span class="keywordflow">goto</span> cleanup;
00273         }
00274         <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a0">setData</a>(pageHeader + 1);
00275         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a> &gt;= <a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a1">getHeader</a>()-&gt;countEntry) {
00276             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00277             <span class="keywordflow">goto</span> cleanup;
00278         }
00279     }
00280 
00281     <span class="comment">// Ende des Suchbereichs erreicht</span>
00282     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r1">dataType</a> != <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a> || <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> != NULL) {
00283         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_b_tree_iterator.html#r8">leaf</a>-&gt;<a class="code" href="class_dbj_b_tree_1_1_node.html#a7">getKey</a>(<a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a>) &gt; <a class="code" href="class_dbj_b_tree_iterator.html#r7">stopKey</a>) {
00284             currentPage = 0;
00285         }
00286     }
00287 
00288  cleanup:
00289     <span class="keywordflow">if</span> (page != NULL) {
00290         <a class="code" href="class_dbj_b_tree_iterator.html#r12">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00291     }
00292     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00293 }
00294 
00295 
00296 <span class="comment">// Setze Iterator zurueck</span>
<a name="l00297"></a><a class="code" href="class_dbj_b_tree_iterator.html#a4">00297</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_b_tree_iterator.html#a4">DbjBTreeIterator::reset</a>()
00298 {
00299     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00300 
00301     <a class="code" href="class_dbj_b_tree_iterator.html#r4">currentPage</a> = <a class="code" href="class_dbj_b_tree_iterator.html#r2">startPage</a>;
00302     <a class="code" href="class_dbj_b_tree_iterator.html#r5">currentSlot</a> = <a class="code" href="class_dbj_b_tree_iterator.html#r3">startSlot</a>;
00303 
00304     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00305 }
00306 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:28 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
