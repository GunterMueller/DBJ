<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjOptimizer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjOptimizer.cpp</h1><a href="_dbj_optimizer_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2004-2005                                                         *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="_dbj_optimizer_8hpp.html">DbjOptimizer.hpp</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="_dbj_access_plan_8hpp.html">DbjAccessPlan.hpp</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="_dbj_table_8hpp.html">DbjTable.hpp</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="_dbj_index_8hpp.html">DbjIndex.hpp</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="_dbj_index_key_8hpp.html">DbjIndexKey.hpp</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="_dbj_catalog_manager_8hpp.html">DbjCatalogManager.hpp</a>"</span>
00017 
00018 
<a name="l00019"></a><a class="code" href="_dbj_optimizer_8cpp.html#a0">00019</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="_dbj_optimizer_8cpp.html#a0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a3">Optimizer</a>;
00020 
00021 
<a name="l00022"></a><a class="code" href="class_dbj_optimizer.html#v0">00022</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> <a class="code" href="class_dbj_optimizer.html#v0">DbjOptimizer::AND</a>;
<a name="l00023"></a><a class="code" href="class_dbj_optimizer.html#v1">00023</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> <a class="code" href="class_dbj_optimizer.html#v1">DbjOptimizer::OR</a>;
00024 
00025 
00026 <span class="comment">// optimiere Plan</span>
<a name="l00027"></a><a class="code" href="class_dbj_optimizer.html#a0">00027</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#a0">DbjOptimizer::optimize</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *&amp;accessPlan)
00028 {
00029     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00030     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tableList = NULL;
00031     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *whereClause = NULL;
00032     <span class="keywordtype">bool</span> pushedDownPredicates = <span class="keyword">false</span>;
00033 
00034     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00035 
00036     <span class="keywordflow">if</span> (!accessPlan) {
00037         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00038         <span class="keywordflow">goto</span> cleanup;
00039     }
00040 
00041     <span class="comment">// annotiere Plan</span>
00042     rc = <a class="code" href="class_dbj_optimizer.html#d0">annotate</a>(accessPlan);
00043     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00044         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00045         <span class="keywordflow">goto</span> cleanup;
00046     }
00047 
00048     <span class="keywordflow">switch</span> (accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>()) {
00049       <span class="keywordflow">case</span> DbjAccessPlan::SelectStmt:
00050           tableList = accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00051           whereClause = tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00052           <span class="keywordflow">break</span>;
00053       <span class="keywordflow">case</span> DbjAccessPlan::UpdateStmt:
00054           tableList = accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00055           whereClause = tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00056           <span class="keywordflow">break</span>;
00057       <span class="keywordflow">case</span> DbjAccessPlan::DeleteStmt:
00058           tableList = accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00059           whereClause = tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00060           <span class="keywordflow">break</span>;
00061       <span class="keywordflow">default</span>:
00062           <span class="comment">// wir optimieren nur SELECT-, UPDATE- und DELETE-Anweisungen</span>
00063           <span class="keywordflow">goto</span> cleanup;
00064     }
00065 
00066     <span class="keywordflow">if</span> (!tableList || tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Sources) {
00067         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00068         <span class="keywordflow">goto</span> cleanup;
00069     }
00070     <span class="keywordflow">if</span> (whereClause &amp;&amp; whereClause-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::WhereClause) {
00071         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00072         <span class="keywordflow">goto</span> cleanup;
00073     }
00074 
00075     <span class="comment">/*</span>
00076 <span class="comment">     * 1. Optimierung: Eliminiere ueberfluessige Schachtelungen in der</span>
00077 <span class="comment">     *                 WHERE-Klausel</span>
00078 <span class="comment">     */</span>
00079     <span class="keywordflow">if</span> (whereClause != NULL) {
00080         <a class="code" href="class_dbj_optimizer.html#y3">TruthValue</a> truthValue = <a class="code" href="class_dbj_optimizer.html#y3y2">Undetermined</a>;
00081 
00082         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *firstPred = whereClause-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00083         <span class="keywordflow">if</span> (firstPred-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Negation) {
00084             firstPred = firstPred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00085         }
00086 
00087         rc = <a class="code" href="class_dbj_optimizer.html#d2">nestAndOrCombinations</a>(firstPred);
00088         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00089             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00090             <span class="keywordflow">goto</span> cleanup;
00091         }
00092 
00093         rc = <a class="code" href="class_dbj_optimizer.html#d4">removeAllNegations</a>(whereClause);
00094         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00095             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00096             <span class="keywordflow">goto</span> cleanup;
00097         }
00098 
00099         rc = <a class="code" href="class_dbj_optimizer.html#d8">eliminateConstantPredicates</a>(whereClause-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>(), truthValue);
00100         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00101             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00102             <span class="keywordflow">goto</span> cleanup;
00103         }
00104         <span class="keywordflow">if</span> (truthValue == <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>) {
00105             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a31">DBJ_OPT_EMPTY_RESULT_SET_WARN</a>);
00106             <span class="keywordflow">goto</span> cleanup;
00107         }
00108         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (truthValue == <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a>) {
00109             whereClause-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(NULL);
00110             <span class="keyword">delete</span> whereClause;
00111             whereClause = NULL;
00112         }
00113         <span class="keywordflow">else</span> {
00114             rc = <a class="code" href="class_dbj_optimizer.html#d3">eliminateExcessiveNesting</a>(whereClause-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
00115             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00116                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00117                 <span class="keywordflow">goto</span> cleanup;
00118             }
00119         }
00120     }
00121 
00122     <span class="comment">/*</span>
00123 <span class="comment">     * 2. Optimierung: Haenge Praedikate von der WHERE-Klausel an die</span>
00124 <span class="comment">     *                 jeweiligen Tabellen (predicate push down)</span>
00125 <span class="comment">     */</span>
00126     <span class="keywordflow">if</span> (whereClause != NULL) {
00127         <span class="comment">// Nach diesem Schritt kann "whereClause" nicht mehr gueltig sein wenn</span>
00128         <span class="comment">// z.B. alle Praedikate umsortiert wurden.</span>
00129         rc = <a class="code" href="class_dbj_optimizer.html#d6">sortPredicatesToTables</a>(whereClause-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
00130         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00131             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00132             <span class="keywordflow">goto</span> cleanup;
00133         }
00134 
00135         <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *table = tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>(); table != NULL;
00136              table = table-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00137             <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>()) {
00138                 pushedDownPredicates = <span class="keyword">true</span>;
00139                 <span class="keywordflow">break</span>;
00140             }
00141         }
00142     }
00143 
00144     <span class="comment">/*</span>
00145 <span class="comment">     * 3. Optimierung: Finde moegliche Index-Scans</span>
00146 <span class="comment">     *</span>
00147 <span class="comment">     * Dieser Schritt wird nur fuer SELECT-Anweisungen durchgefuehrt, und auch</span>
00148 <span class="comment">     * nur dann, wenn Praedikate in die Joins gepusht wurden.</span>
00149 <span class="comment">     */</span>
00150     <span class="keywordflow">if</span> (pushedDownPredicates) {
00151         rc = <a class="code" href="class_dbj_optimizer.html#d10">findIndexScans</a>(tableList);
00152         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00153             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00154             <span class="keywordflow">goto</span> cleanup;
00155         }
00156     }
00157 
00158     <span class="comment">/*</span>
00159 <span class="comment">     * 4. Optimierung: Sortiere Tabellen nach der Anzahl der Tupel</span>
00160 <span class="comment">     *</span>
00161 <span class="comment">     * Dieser Schritt ist nur relevant fuer SELECT-Anweisungen, und auch nur</span>
00162 <span class="comment">     * dann, wenn keine Praedikate in die Joins gepusht wurden.</span>
00163 <span class="comment">     */</span>
00164     <span class="keywordflow">if</span> (accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::SelectStmt &amp;&amp;
00165             tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>() != NULL &amp;&amp;
00166             !pushedDownPredicates) {
00167         rc = <a class="code" href="class_dbj_optimizer.html#d12">sortTableList</a>(tableList);
00168         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00169             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00170             <span class="keywordflow">goto</span> cleanup;
00171         }
00172     }
00173     
00174  cleanup:
00175     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00176 }
00177 
00178 
00179 <span class="comment">// annotiere Zugriffsplaene</span>
<a name="l00180"></a><a class="code" href="class_dbj_optimizer.html#d0">00180</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d0">DbjOptimizer::annotate</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *&amp;accessPlan)
00181 {
00182     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00183     <a class="code" href="class_dbj_access_plan_table.html">DbjAccessPlanTable</a> *table = NULL;
00184 
00185     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00186 
00187     <span class="keywordflow">if</span> (!accessPlan) {
00188         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00189         <span class="keywordflow">goto</span> cleanup;
00190     }
00191 
00192     <span class="keywordflow">switch</span> (accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>()) {
00193         <span class="comment">/* diese Anweisungen bleiben unveraendert */</span>
00194       <span class="keywordflow">case</span> DbjAccessPlan::CreateTableStmt:
00195       <span class="keywordflow">case</span> DbjAccessPlan::CreateIndexStmt:
00196       <span class="keywordflow">case</span> DbjAccessPlan::DropIndexStmt:
00197       <span class="keywordflow">case</span> DbjAccessPlan::SelectStmt:
00198       <span class="keywordflow">case</span> DbjAccessPlan::CommitStmt:
00199       <span class="keywordflow">case</span> DbjAccessPlan::RollbackStmt:
00200           <span class="keywordflow">break</span>;
00201       <span class="keywordflow">case</span> DbjAccessPlan::DropTableStmt:
00202           table = static_cast&lt;DbjAccessPlanTable *&gt;(accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>());
00203           rc = <a class="code" href="class_dbj_optimizer.html#d1">annotateTableNode</a>(table);
00204           <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00205               <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00206               <span class="keywordflow">goto</span> cleanup;
00207           }
00208           <span class="keywordflow">break</span>;
00209       <span class="keywordflow">case</span> DbjAccessPlan::InsertStmt:
00210       <span class="keywordflow">case</span> DbjAccessPlan::UpdateStmt:
00211       <span class="keywordflow">case</span> DbjAccessPlan::DeleteStmt:
00212           table = static_cast&lt;DbjAccessPlanTable *&gt;(
00213                   accessPlan-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
00214           rc = <a class="code" href="class_dbj_optimizer.html#d1">annotateTableNode</a>(table);
00215           <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00216               <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00217               <span class="keywordflow">goto</span> cleanup;
00218           }
00219           <span class="keywordflow">break</span>;
00220       <span class="keywordflow">default</span>:
00221           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00222           <span class="keywordflow">goto</span> cleanup;
00223     }
00224 
00225  cleanup:
00226     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00227 }
00228 
00229 
00230 <span class="comment">// annotiere "Table" Knoten im Plan mit Index-Informationen</span>
<a name="l00231"></a><a class="code" href="class_dbj_optimizer.html#d1">00231</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d1">DbjOptimizer::annotateTableNode</a>(<a class="code" href="class_dbj_access_plan_table.html">DbjAccessPlanTable</a> *table)
00232 {
00233     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00234 
00235     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00236 
00237     <span class="keywordflow">if</span> (!table) {
00238         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00239         <span class="keywordflow">goto</span> cleanup;
00240     }
00241 
00242     <span class="comment">// finde alle Indexe</span>
00243     {
00244         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> indexCount = 0;
00245         <a class="code" href="class_dbj_table.html">DbjTable</a> *tableDesc = table-&gt;<a class="code" href="class_dbj_access_plan_table.html#a2">getTableDescriptor</a>();
00246         <span class="keywordflow">if</span> (!tableDesc) {
00247             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00248             <span class="keywordflow">goto</span> cleanup;
00249         }
00250 
00251         <span class="comment">// haenge alle Index unter "Table"-Knoten</span>
00252         indexCount = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a15">getNumIndexes</a>();
00253         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; indexCount; i++) {
00254             <a class="code" href="class_dbj_index.html">DbjIndex</a> *indexDesc = NULL;
00255             <a class="code" href="group__tableid.html#ga5">IndexId</a> indexId = DBJ_UNKNOWN_INDEX_ID;
00256             <a class="code" href="class_dbj_access_plan_index.html">DbjAccessPlanIndex</a> *newNode = NULL;
00257 
00258             rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a16">getIndex</a>(i, indexDesc);
00259             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00260                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00261                 <span class="keywordflow">goto</span> cleanup;
00262             }
00263             rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a1">getIndexId</a>(indexId);
00264             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00265                 <span class="keyword">delete</span> indexDesc;
00266                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00267                 <span class="keywordflow">goto</span> cleanup;
00268             }
00269 
00270             <span class="comment">// initialisiere Knoten</span>
00271             newNode = <span class="keyword">new</span> <a class="code" href="class_dbj_access_plan_index.html">DbjAccessPlanIndex</a>();
00272             <span class="keywordflow">if</span> (!newNode) {
00273                 <span class="keyword">delete</span> indexDesc;
00274                 <span class="keywordflow">goto</span> cleanup;
00275             }
00276             rc = newNode-&gt;setIntData(indexId);
00277             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00278                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00279                 <span class="keyword">delete</span> indexDesc;
00280                 <span class="keyword">delete</span> newNode;
00281                 <span class="keywordflow">goto</span> cleanup;
00282             }
00283             rc = newNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#d0">setIndexDescriptor</a>(indexDesc);
00284             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00285                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00286                 <span class="keyword">delete</span> indexDesc;
00287                 <span class="keyword">delete</span> newNode;
00288                 <span class="keywordflow">goto</span> cleanup;
00289             }
00290 
00291             <span class="comment">// haenge Knoten an</span>
00292             table-&gt;addNext(newNode);
00293         }
00294     }
00295 
00296  cleanup:
00297     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00298 }
00299 
00300 
00301 <span class="comment">// Loese AND/OR-Kombinationen auf</span>
<a name="l00302"></a><a class="code" href="class_dbj_optimizer.html#d2">00302</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d2">DbjOptimizer::nestAndOrCombinations</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *predicate)
00303 {
00304     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00305 
00306     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00307 
00308     <span class="keywordflow">if</span> (predicate == NULL) {
00309         <span class="keywordflow">goto</span> cleanup;
00310     }
00311     <span class="keywordflow">if</span> (predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00312         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00313         <span class="keywordflow">goto</span> cleanup;
00314     }
00315 
00316     <span class="comment">// rekursiver Abstieg fuer alle Knoten auf dieser Ebene</span>
00317     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = predicate; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00318         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *son = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00319         <span class="keywordflow">if</span> (son != NULL &amp;&amp; son-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate) {
00320             rc = <a class="code" href="class_dbj_optimizer.html#d2">nestAndOrCombinations</a>(son);
00321             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00322                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00323                 <span class="keywordflow">goto</span> cleanup;
00324             }
00325         }
00326     }
00327 
00328     <span class="comment">// ermittle logische Verknuepfung auf dieser Ebene</span>
00329     <span class="keywordflow">if</span> (predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() == NULL ||
00330             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() ==
00331             DbjAccessPlan::Negation ||
00332             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() ==
00333             DbjAccessPlan::WhereClause) {
00334         <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> logicalOps = 0x00;
00335 
00336         <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = predicate; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00337             <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::LogicalOperation) {
00338                 <span class="keywordflow">if</span> (*tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'A'</span>) {
00339                     logicalOps |= <a class="code" href="class_dbj_optimizer.html#v0">AND</a>;
00340                 }
00341                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'O'</span>) {
00342                     logicalOps |= <a class="code" href="class_dbj_optimizer.html#v1">OR</a>;
00343                 }
00344                 <span class="keywordflow">else</span> {
00345                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00346                     <span class="keywordflow">goto</span> cleanup;
00347                 }
00348                 <span class="keywordflow">if</span> ((logicalOps &amp; <a class="code" href="class_dbj_optimizer.html#v0">AND</a>) &amp;&amp; (logicalOps &amp; <a class="code" href="class_dbj_optimizer.html#v1">OR</a>)) {
00349                     <span class="keywordflow">break</span>;
00350                 }
00351             }
00352         }
00353         <a class="code" href="group__trace__def.html#ga3">DBJ_TRACE_DATA1</a>(10, <span class="keyword">sizeof</span> logicalOps, &amp;logicalOps);
00354 
00355         <span class="comment">// keine AND _und_ OR-Verknuepfung auf dieser Ebene</span>
00356         <span class="keywordflow">if</span> ( ! ((logicalOps &amp; <a class="code" href="class_dbj_optimizer.html#v0">AND</a>) &amp;&amp; (logicalOps &amp; <a class="code" href="class_dbj_optimizer.html#v1">OR</a>))) {
00357             <span class="keywordflow">goto</span> cleanup;
00358         }
00359     }
00360     <span class="keywordflow">else</span> {
00361         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00362         <span class="keywordflow">goto</span> cleanup;
00363     }
00364 
00365     <span class="comment">// schiebe alle AND-Verknuepfungen eine ebene tiefer</span>
00366     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = predicate; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00367         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00368             <span class="keywordflow">continue</span>;
00369         }
00370 
00371         <span class="comment">// (1) ein neuer Predicate-Knoten "newSon" wird erzeugt, und dieser</span>
00372         <span class="comment">//     nimmt die "tmp"-Informationen auf</span>
00373         <span class="comment">// (2) Nachfolger von "next" wird hinter "tmp" gehaengt</span>
00374         <span class="comment">// (3) "newSon" wird neuer Sohn von "tmp"</span>
00375 
00376         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *op = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00377         <span class="keywordflow">if</span> (op == NULL || op-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::LogicalOperation ||
00378                 *op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() != <span class="charliteral">'A'</span>) {
00379             <span class="keywordflow">continue</span>;
00380         }
00381 
00382         <span class="comment">// finde alle zusammenhaengenden AND-Verknuepfungen</span>
00383         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *last = op-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00384         <span class="keywordflow">do</span> {
00385             <span class="keywordflow">if</span> (last == NULL) {
00386                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00387                 <span class="keywordflow">goto</span> cleanup;
00388             }
00389             <span class="keywordflow">if</span> (last-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Negation) {
00390                 <span class="comment">// ueberspringe Negation</span>
00391                 last = last-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00392                 <span class="keywordflow">if</span> (last == NULL) {
00393                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00394                     <span class="keywordflow">goto</span> cleanup;
00395                 }
00396             }
00397             op = last-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00398         } <span class="keywordflow">while</span> (op != NULL &amp;&amp;
00399                 op-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::LogicalOperation &amp;&amp;
00400                 *op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'A'</span>);
00401 
00402         {
00403             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *first = tmp;
00404             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *newPred = <span class="keyword">new</span> <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a>(DbjAccessPlan::Predicate);
00405             <span class="keywordflow">if</span> (!newPred) {
00406                 <span class="keywordflow">goto</span> cleanup;
00407             }
00408 
00409             <span class="comment">// nehme Negation fuer erstes Praedikat der Teilliste mit!!</span>
00410             <span class="keywordflow">if</span> (first-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() &amp;&amp; first-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() ==
00411                     DbjAccessPlan::Negation) {
00412                 first = first-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
00413             }
00414 
00415             <span class="comment">// haenge "newPred" anstatt der Teilliste in den Plan</span>
00416             <span class="keywordflow">if</span> (first-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL) {
00417                 first-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(newPred);
00418             }
00419             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (first-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>() != NULL &amp;&amp;
00420                     first-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>() == first) {
00421                 first-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(newPred);
00422             }
00423             <span class="keywordflow">else</span> {
00424                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00425             }
00426             newPred-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(last-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
00427 
00428             <span class="comment">// haenge Teilliste unter "newPred"</span>
00429             newPred-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(first);
00430             last-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00431             tmp = newPred;
00432         }
00433     }
00434 
00435  cleanup:
00436     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00437 }
00438 
00439 
00440 <span class="comment">// eliminiere Schachtelung in WHERE-Klausel</span>
<a name="l00441"></a><a class="code" href="class_dbj_optimizer.html#d3">00441</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d3">DbjOptimizer::eliminateExcessiveNesting</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *predicate)
00442 {
00443     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00444     <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> logicalOps = 0x00;
00445     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = NULL;
00446 
00447     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00448 
00449     <span class="keywordflow">if</span> (predicate == NULL) {
00450         <span class="keywordflow">goto</span> cleanup;
00451     }
00452     <span class="keywordflow">if</span> (predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00453         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00454         <span class="keywordflow">goto</span> cleanup;
00455     }
00456 
00457     <span class="comment">// rekursiver Abstieg</span>
00458     tmp = predicate;
00459     <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>() != NULL) {
00460         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *son = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00461         <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate) {
00462             rc = <a class="code" href="class_dbj_optimizer.html#d3">eliminateExcessiveNesting</a>(son);
00463             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00464                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00465                 <span class="keywordflow">goto</span> cleanup;
00466             }
00467         }
00468     }
00469 
00470     <span class="comment">// bestimme logischen Verknuepfung auf der aktuellen Ebene</span>
00471     <span class="keywordflow">if</span> (predicate-&gt;getPrevious() != NULL &amp;&amp;
00472             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() ==
00473             DbjAccessPlan::LogicalOperation) {
00474         logicalOps = (*predicate-&gt;getPrevious()-&gt;getStringData() == <span class="charliteral">'A'</span>) ?
00475             <a class="code" href="class_dbj_optimizer.html#v0">AND</a> : <a class="code" href="class_dbj_optimizer.html#v1">OR</a>;
00476     }
00477     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (predicate-&gt;getNext() != NULL &amp;&amp;
00478             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() ==
00479             DbjAccessPlan::LogicalOperation) {
00480         logicalOps = (*predicate-&gt;getNext()-&gt;getStringData() == <span class="charliteral">'A'</span>) ? <a class="code" href="class_dbj_optimizer.html#v0">AND</a> : <a class="code" href="class_dbj_optimizer.html#v1">OR</a>;
00481     }
00482     <a class="code" href="group__trace__def.html#ga3">DBJ_TRACE_DATA1</a>(10, <span class="keyword">sizeof</span> logicalOps, &amp;logicalOps);
00483 
00484     <span class="comment">// bearbeite alle Nachfolger in der gleichen Ebene zuerst</span>
00485     <span class="keywordflow">for</span> (tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>(); tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00486         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00487             <span class="keywordflow">continue</span>;
00488         }
00489         rc = <a class="code" href="class_dbj_optimizer.html#d3">eliminateExcessiveNesting</a>(tmp);
00490         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00491             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00492             <span class="keywordflow">goto</span> cleanup;
00493         }
00494     }
00495 
00496     <span class="comment">// keine weiteren geschachtelten Praedikate zu finden</span>
00497     <span class="keywordflow">if</span> (predicate-&gt;getSon()-&gt;getNodeType() != DbjAccessPlan::Predicate) {
00498         <span class="keywordflow">goto</span> cleanup;
00499     }
00500 
00501     <span class="comment">/*</span>
00502 <span class="comment">     * Teste, ob Praedikate wieder Praedikate enthalten, und wenn diese die</span>
00503 <span class="comment">     * gleiche logische Verknuepfung verwenden wie auf der aktuellen Ebene.</span>
00504 <span class="comment">     * Wenn ja, dann entferne die Schachtelungsebene.</span>
00505 <span class="comment">     */</span>
00506     <span class="keywordflow">for</span> (tmp = predicate; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00507         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00508             <span class="keywordflow">continue</span>;
00509         }
00510         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *son = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00511         <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00512             <span class="keywordflow">continue</span>;
00513         }
00514 
00515         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *lastSon = NULL;
00516         <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> sonOps = 0x00;
00517         <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>() != NULL) {
00518             sonOps = (*son-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'A'</span>) ?
00519                 <a class="code" href="class_dbj_optimizer.html#v0">AND</a> : <a class="code" href="class_dbj_optimizer.html#v1">OR</a>;
00520         }
00521         <a class="code" href="group__trace__def.html#ga4">DBJ_TRACE_DATA2</a>(20,
00522                 <span class="keyword">sizeof</span> logicalOps, &amp;logicalOps,
00523                 <span class="keyword">sizeof</span> sonOps, &amp;sonOps);
00524 
00525         <span class="comment">// Sohn hat andere Verknuepfung</span>
00526         <span class="keywordflow">if</span> (logicalOps != 0x00  &amp;&amp; sonOps != 0x00 &amp;&amp; logicalOps != sonOps) {
00527             <span class="keywordflow">continue</span>;
00528         }
00529 
00530         <span class="comment">// finde letzten Sohn</span>
00531         lastSon = son;
00532         <span class="keywordflow">while</span> (lastSon-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>() != NULL) {
00533             lastSon = lastSon-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00534         }
00535 
00536         <span class="comment">// nun haben wir die gleiche logische Verknuepfung beim Sohn, so dass</span>
00537         <span class="comment">// wir den gesamten Sohn anstatt "tmp" in die aktuelle Liste haengen</span>
00538         <span class="comment">// koennen</span>
00539         <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(30, <span class="stringliteral">"replace current node with son"</span>);
00540         {
00541             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *next = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00542             tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00543             tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(NULL);
00544             <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL) {
00545                 tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(son);
00546             }
00547             <span class="keywordflow">else</span> {
00548                 tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(son);
00549             }
00550             lastSon-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(next);
00551             <span class="keyword">delete</span> tmp;
00552             tmp = lastSon;
00553         }
00554     }
00555 
00556  cleanup:
00557     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00558 }
00559 
00560 
00561 <span class="comment">// entferne Negationen</span>
<a name="l00562"></a><a class="code" href="class_dbj_optimizer.html#d4">00562</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d4">DbjOptimizer::removeAllNegations</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *predicate)
00563 {
00564     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00565 
00566     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00567 
00568     <span class="keywordflow">if</span> (predicate == NULL ||
00569             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Negation) {
00570         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00571         <span class="keywordflow">goto</span> cleanup;
00572     }
00573 
00574     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = predicate; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00575         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *negation = NULL;
00576 
00577         <span class="comment">// finde "Negation"-Knoten</span>
00578         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Negation) {
00579             negation = tmp;
00580             tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
00581         }
00582         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate &amp;&amp;
00583                 tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Negation) {
00584             negation = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00585         }
00586 
00587         <span class="comment">// entferne Negation</span>
00588         <span class="keywordflow">if</span> (negation != NULL) {
00589             rc = <a class="code" href="class_dbj_optimizer.html#d5">resolveNegation</a>(negation);
00590             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00591                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00592                 <span class="keywordflow">goto</span> cleanup;
00593             }
00594 
00595             <span class="keywordflow">if</span> (negation-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL) {
00596                 negation-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(negation-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
00597             }
00598             <span class="keywordflow">else</span> {
00599                 negation-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(negation-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
00600             }
00601             negation-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00602             <span class="keyword">delete</span> negation;
00603             negation = NULL;
00604         }
00605 
00606         <span class="comment">// rekursiver Abstieg</span>
00607         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate) {
00608             rc = <a class="code" href="class_dbj_optimizer.html#d4">removeAllNegations</a>(tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>());
00609             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00610                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00611                 <span class="keywordflow">goto</span> cleanup;
00612             }
00613         }
00614     }
00615 
00616  cleanup:
00617     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00618 }
00619 
00620 
00621 <span class="comment">// loese einzelne Negationen auf</span>
<a name="l00622"></a><a class="code" href="class_dbj_optimizer.html#d5">00622</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d5">DbjOptimizer::resolveNegation</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *negation)
00623 {
00624     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00625 
00626     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00627 
00628     <span class="keywordflow">if</span> (negation == NULL ||
00629             negation-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Negation) {
00630         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00631         <span class="keywordflow">goto</span> cleanup;
00632     }
00633 
00634     <span class="comment">// negiere die einzelnen Praedikate in der Sohn-Liste</span>
00635     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = negation-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>(); tmp != NULL;
00636          tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00637         <span class="keywordflow">switch</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>()) {
00638           <span class="keywordflow">case</span> DbjAccessPlan::Negation: <span class="comment">// entferne Negationen</span>
00639               {
00640                   <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *neg = tmp;
00641                   <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *pred = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00642                   neg-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00643                   <span class="keywordflow">if</span> (neg-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL) {
00644                       neg-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(pred);
00645                   }
00646                   <span class="keywordflow">else</span> {
00647                       neg-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(pred);
00648                   }
00649                   <span class="keyword">delete</span> neg;
00650 
00651                   <span class="comment">// ueberspringe Praedikat</span>
00652                   tmp = pred;
00653               }
00654               <span class="keywordflow">break</span>;
00655 
00656           <span class="keywordflow">case</span> DbjAccessPlan::LogicalOperation: <span class="comment">// AND &lt;-&gt; OR</span>
00657               <span class="keywordflow">if</span> (*tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'A'</span>) {
00658                   rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"OR"</span>);
00659                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00660                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00661                       <span class="keywordflow">goto</span> cleanup;
00662                   }
00663               }
00664               <span class="keywordflow">else</span> {
00665                   rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"AND"</span>);
00666                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00667                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00668                       <span class="keywordflow">goto</span> cleanup;
00669                   }
00670               }
00671               <span class="keywordflow">break</span>;
00672 
00673           <span class="keywordflow">case</span> DbjAccessPlan::Predicate: <span class="comment">// Negation einfuegen</span>
00674               {
00675                   <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *neg = <span class="keyword">new</span> <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a>(
00676                           DbjAccessPlan::Negation);
00677                   <span class="keywordflow">if</span> (!neg) {
00678                       <span class="keywordflow">goto</span> cleanup;
00679                   }
00680                   <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL) {
00681                       tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(neg);
00682                   }
00683                   <span class="keywordflow">else</span> {
00684                       tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(neg);
00685                   }
00686                   neg-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(tmp);
00687               }
00688               <span class="keywordflow">break</span>;
00689 
00690           <span class="keywordflow">case</span> DbjAccessPlan::Comparison:
00691               {
00692                   <span class="keywordtype">char</span> <span class="keyword">const</span> *op = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>();
00693                   <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00694                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"&lt;&gt;"</span>);
00695                   }
00696                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"&lt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00697                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"&gt;="</span>);
00698                   }
00699                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"&lt;="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00700                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"&gt;"</span>);
00701                   }
00702                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"&gt;="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00703                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"&lt;"</span>);
00704                   }
00705                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00706                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"&lt;="</span>);
00707                   }
00708                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"&lt;&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00709                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"="</span>);
00710                   }
00711                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"LIKE"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00712                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"NOT LIKE"</span>);
00713                   }
00714                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op, <span class="stringliteral">"NOT LIKE"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00715                       rc = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"LIKE"</span>);
00716                   }
00717                   <span class="keywordflow">else</span> {
00718                       <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00719                       <span class="keywordflow">goto</span> cleanup;
00720                   }
00721                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00722                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00723                       <span class="keywordflow">goto</span> cleanup;
00724                   }
00725               }
00726               <span class="keywordflow">break</span>;
00727 
00728           <span class="keywordflow">default</span>:
00729               <span class="keywordflow">break</span>;
00730         }
00731     }
00732 
00733  cleanup:
00734     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00735 }
00736 
00737 
00738 <span class="comment">// sortiere Praedikate zu Tabellen</span>
<a name="l00739"></a><a class="code" href="class_dbj_optimizer.html#d6">00739</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d6">DbjOptimizer::sortPredicatesToTables</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *predicates)
00740 {
00741     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00742     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = NULL;
00743 
00744     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00745 
00746     <span class="keywordflow">if</span> (predicates == NULL) {
00747         <span class="keywordflow">goto</span> cleanup;
00748     }
00749 
00750     <span class="comment">// wir duerfen keine "OR"-Verknuepfungen auf der obersten Ebene haben</span>
00751     <span class="keywordflow">if</span> (predicates-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>() != NULL &amp;&amp;
00752             *predicates-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'O'</span>) {
00753         <span class="keywordflow">goto</span> cleanup;
00754     }
00755 
00756     tmp = predicates;
00757     <span class="keywordflow">while</span> (tmp != NULL) {
00758         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *table = NULL;
00759         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *prev = NULL;
00760         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *next = NULL;
00761 
00762         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00763             tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00764             <span class="keywordflow">continue</span>;
00765         }
00766 
00767         <span class="comment">// ermittle, welche Tabelle genutzt wird</span>
00768         rc = <a class="code" href="class_dbj_optimizer.html#d7">getAccessedTable</a>(tmp, table);
00769         <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a30">DBJ_OPT_PREDICATE_ON_MULTIPLE_TABLES_WARN</a>) {
00770             <span class="comment">// verschiedene Tabellen werden genutzt</span>
00771             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>);
00772             tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00773             <span class="keywordflow">continue</span>;
00774         }
00775         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00776             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00777             <span class="keywordflow">goto</span> cleanup;
00778         }
00779 
00780         <span class="comment">// Praedikat besteht nur aus dem Vergleich von Konstanten</span>
00781         <span class="keywordflow">if</span> (table == NULL) {
00782             tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00783             <span class="keywordflow">continue</span>;
00784         }
00785 
00786         <span class="comment">// haenge Praedikat an entsprechende Tabelle</span>
00787         <span class="comment">// (wir wissen, dass wir eine AND-Verknuepfung haben)</span>
00788         prev = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
00789         next = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00790         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::LogicalOperation) {
00791             <span class="comment">// haenge "prev" und "tmp" aus</span>
00792             tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00793             prev-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(next);
00794             <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>() == NULL) {
00795                 prev-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00796                 <span class="keyword">delete</span> prev;
00797                 table-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(tmp);
00798             }
00799             <span class="keywordflow">else</span> {
00800                 table-&gt;<a class="code" href="class_dbj_access_plan.html#d3">addSon</a>(prev);
00801             }
00802             tmp = next;
00803         }
00804         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::WhereClause) {
00805             tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00806             <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>() != NULL) {
00807                 <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *logicOp = <span class="keyword">new</span> <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a>(
00808                         DbjAccessPlan::LogicalOperation);
00809                 <span class="keywordflow">if</span> (!logicOp) {
00810                     <span class="keywordflow">goto</span> cleanup;
00811                 }
00812                 rc = logicOp-&gt;<a class="code" href="class_dbj_access_plan.html#d4">setStringData</a>(<span class="stringliteral">"AND"</span>);
00813                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00814                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00815                     <span class="keywordflow">goto</span> cleanup;
00816                 }
00817                 table-&gt;<a class="code" href="class_dbj_access_plan.html#d3">addSon</a>(logicOp);
00818                 table-&gt;<a class="code" href="class_dbj_access_plan.html#d3">addSon</a>(tmp);
00819             }
00820             <span class="keywordflow">else</span> {
00821                 table-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(tmp);
00822             }
00823             <span class="keywordflow">if</span> (next != NULL) {
00824                 tmp = next-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00825                 prev-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(tmp);
00826                 next-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00827                 <span class="keyword">delete</span> next;
00828                 next = NULL;
00829             }
00830             <span class="keywordflow">else</span> {
00831                 <span class="comment">// das war das einzige (verbliebene) Praedikat in der</span>
00832                 <span class="comment">// WHERE-Klausel</span>
00833                 prev-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(NULL);
00834                 prev-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
00835                 <span class="keyword">delete</span> prev;
00836                 tmp = NULL;
00837             }
00838         }
00839         <span class="keywordflow">else</span> {
00840             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00841             <span class="keywordflow">goto</span> cleanup;
00842         }
00843     }
00844 
00845  cleanup:
00846     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00847 }
00848 
00849 
00850 <span class="comment">// finde die vom Praedikat genutzte Tabelle</span>
<a name="l00851"></a><a class="code" href="class_dbj_optimizer.html#d7">00851</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d7">DbjOptimizer::getAccessedTable</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> <span class="keyword">const</span> *predicate,
00852         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *&amp;table)<span class="keyword"> const</span>
00853 <span class="keyword"></span>{
00854     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00855     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *son = NULL;
00856 
00857     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00858 
00859     <span class="keywordflow">if</span> (predicate == NULL ||
00860             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00861         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00862         <span class="keywordflow">goto</span> cleanup;
00863     }
00864 
00865     table = NULL;
00866     son = predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00867     <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate) {
00868         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tableNode = NULL;
00869 
00870         <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = son; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
00871             <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00872                 <span class="keywordflow">continue</span>;
00873             }
00874 
00875             rc = <a class="code" href="class_dbj_optimizer.html#d7">getAccessedTable</a>(son, tableNode);
00876             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) { <span class="comment">// kann auch multi-table Warnung sein</span>
00877                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00878                 <span class="keywordflow">goto</span> cleanup;
00879             }
00880             <span class="keywordflow">if</span> (table == NULL) {
00881                 table = tableNode;
00882             }
00883             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (table != tableNode) {
00884                 <span class="comment">// Unterpraedikate nutzen verschiedene Tabellen</span>
00885                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a30">DBJ_OPT_PREDICATE_ON_MULTIPLE_TABLES_WARN</a>);
00886                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00887             }
00888         }
00889     }
00890     <span class="keywordflow">else</span> {
00891         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *firstTable = NULL;
00892         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *secondTable = NULL;
00893         <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column) {
00894             firstTable = const_cast&lt;DbjAccessPlanTable *&gt;(
00895                     static_cast&lt;DbjAccessPlanColumn *&gt;(son)-&gt;getTableNode());
00896         }
00897         <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column) {
00898             secondTable = const_cast&lt;DbjAccessPlanTable *&gt;(
00899                     static_cast&lt;DbjAccessPlanColumn *&gt;(
00900                             son-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>())-&gt;getTableNode());
00901         }
00902         <span class="keywordflow">if</span> (firstTable == secondTable) {
00903             table = firstTable;
00904         }
00905         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (firstTable != NULL &amp;&amp; secondTable == NULL) {
00906             table = firstTable;
00907         }
00908         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (firstTable == NULL &amp;&amp; secondTable != NULL) {
00909             table = secondTable;
00910         }
00911         <span class="keywordflow">else</span> {
00912             <span class="comment">// Spalten von unterschiedlichen Tabellen</span>
00913             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a30">DBJ_OPT_PREDICATE_ON_MULTIPLE_TABLES_WARN</a>);
00914             <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00915         }
00916     }
00917 
00918  cleanup:
00919     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00920 }
00921 
00922 
00923 <span class="comment">// Eliminiere konstante Praedikate</span>
<a name="l00924"></a><a class="code" href="class_dbj_optimizer.html#d8">00924</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d8">DbjOptimizer::eliminateConstantPredicates</a>(
00925         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *predicate, TruthValue &amp;truthValue)
00926 {
00927     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00928     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *pred = NULL;
00929     <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> andOr = 0x00;
00930 
00931     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00932 
00933     truthValue = <a class="code" href="class_dbj_optimizer.html#y3y2">Undetermined</a>;
00934 
00935     <span class="keywordflow">if</span> (!predicate ||
00936             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00937         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00938         <span class="keywordflow">goto</span> cleanup;
00939     }
00940     <span class="keywordflow">if</span> (predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL &amp;&amp;
00941             predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() !=
00942             DbjAccessPlan::WhereClause) {
00943         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00944         <span class="keywordflow">goto</span> cleanup;
00945     }
00946 
00947     <span class="comment">// Ermittle AND/OR-Verknuepfung der aktuellen Ebene</span>
00948     {
00949         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *next = predicate-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00950         <span class="keywordflow">if</span> (next != NULL) {
00951             <span class="keywordflow">if</span> (next-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::LogicalOperation) {
00952                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00953                 <span class="keywordflow">goto</span> cleanup;
00954             }
00955             <span class="keywordflow">if</span> (*next-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'A'</span>) {
00956                 andOr = <a class="code" href="class_dbj_optimizer.html#v0">AND</a>;
00957             }
00958             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*next-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'O'</span>) {
00959                 andOr = <a class="code" href="class_dbj_optimizer.html#v1">OR</a>;
00960             }
00961             <span class="keywordflow">else</span> {
00962                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00963                 <span class="keywordflow">goto</span> cleanup;
00964             }
00965         }
00966     }
00967 
00968     <span class="comment">// Laufe durch alle Praedikate in der Liste und ermittle jeweils den</span>
00969     <span class="comment">// Wahrheitswert</span>
00970     pred = predicate;
00971     <span class="keywordflow">while</span> (pred != NULL) {
00972         <span class="keywordflow">if</span> (pred-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
00973             pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
00974             <span class="keywordflow">continue</span>;
00975         }
00976         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *son = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
00977         <span class="keywordflow">if</span> (!son) {
00978             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00979             <span class="keywordflow">goto</span> cleanup;
00980         }
00981         <span class="keywordflow">if</span> (son-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate) {
00982             rc = <a class="code" href="class_dbj_optimizer.html#d8">eliminateConstantPredicates</a>(son, truthValue);
00983             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00984                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00985                 <span class="keywordflow">goto</span> cleanup;
00986             }
00987         }
00988         <span class="keywordflow">else</span> {
00989             rc = <a class="code" href="class_dbj_optimizer.html#d9">getTruthValue</a>(son, truthValue);
00990             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00991                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00992                 <span class="keywordflow">goto</span> cleanup;
00993             }
00994         }
00995 
00996         <span class="comment">// Ermittle, ob wir Aussagen ueber die gesamte Liste der Praedikate</span>
00997         <span class="comment">// machen koennen.  Wenn ja, dann geben wir dies als Ergebnis zurueck.</span>
00998         <span class="keywordflow">if</span> (truthValue == <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a> &amp;&amp; andOr == <a class="code" href="class_dbj_optimizer.html#v0">AND</a>) {
00999             <span class="keywordflow">break</span>;
01000         }
01001         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (truthValue == <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> &amp;&amp; andOr == <a class="code" href="class_dbj_optimizer.html#v1">OR</a>) {
01002             <span class="keywordflow">break</span>;
01003         }
01004 
01005         <span class="keywordflow">if</span> (truthValue == Undetermined) {
01006             pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01007             <span class="keywordflow">continue</span>;
01008         }
01009 
01010         <span class="comment">/*</span>
01011 <span class="comment">         * Das aktuelle Praedikat ist konstant, macht aber nicht gleich die</span>
01012 <span class="comment">         * gesamte Ebene konstant - entferne nur das Praedikat aus der Ebene.</span>
01013 <span class="comment">         */</span>
01014 
01015         <span class="comment">// erster Knoten in der Liste</span>
01016         <span class="keywordflow">if</span> (pred-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() == NULL || pred-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() ==
01017                 DbjAccessPlan::WhereClause) {
01018             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = pred;
01019 
01020             pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01021             <span class="keywordflow">if</span> (pred == NULL) {
01022                 <span class="comment">// erster und einziger Knoten - der verbleibt in der Liste um</span>
01023                 <span class="comment">// einen konsistenten Baum zu garantieren</span>
01024                 <span class="keywordflow">break</span>;
01025             }
01026 
01027             <span class="comment">// haenge konstanten Knoten aus und loesche ihn</span>
01028             pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01029             <span class="keywordflow">if</span> (pred == NULL) {
01030                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01031                 <span class="keywordflow">goto</span> cleanup;
01032             }
01033             pred-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
01034             <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() != NULL) {
01035                 tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(pred);
01036             }
01037             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>() != NULL) {
01038                 tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a5">getParent</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(pred);
01039             }
01040             <span class="keywordflow">else</span> {
01041                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01042                 <span class="keywordflow">goto</span> cleanup;
01043             }
01044             <span class="keyword">delete</span> tmp;
01045         }
01046         <span class="keywordflow">else</span> {
01047             <span class="comment">// Knoten mitten in der Liste (oder am Ende)</span>
01048             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
01049             <span class="keywordflow">if</span> (tmp == NULL || tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>() == NULL) {
01050                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01051                 <span class="keywordflow">goto</span> cleanup;
01052             }
01053             tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
01054 
01055             <span class="comment">// haenge Knoten aus und loesche ihn</span>
01056             tmp-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
01057             pred-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
01058             <span class="keyword">delete</span> pred-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
01059             pred = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01060         }
01061         truthValue = Undetermined;
01062     }
01063 
01064  cleanup:
01065     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01066 }
01067 
01068 
01069 <span class="comment">// Bestimme Wahrheitswert eines simplen Praedikats</span>
<a name="l01070"></a><a class="code" href="class_dbj_optimizer.html#d9">01070</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d9">DbjOptimizer::getTruthValue</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> <span class="keyword">const</span> *predicate,
01071         TruthValue &amp;truthValue)
01072 {
01073     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> <span class="keyword">const</span> *expr1 = NULL;
01074     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> <span class="keyword">const</span> *op = NULL;
01075     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> <span class="keyword">const</span> *expr2 = NULL;
01076 
01077     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01078 
01079     truthValue = <a class="code" href="class_dbj_optimizer.html#y3y2">Undetermined</a>;
01080 
01081     <span class="keywordflow">if</span> (!predicate) {
01082         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01083         <span class="keywordflow">goto</span> cleanup;
01084     }
01085 
01086     expr1 = predicate;
01087     op = expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01088     <span class="keywordflow">if</span> (op == NULL || op-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>() == NULL || op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == NULL) {
01089         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01090         <span class="keywordflow">goto</span> cleanup;
01091     }
01092     expr2 = op-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01093 
01094     <span class="comment">// Vergleiche mit Spalten sind immer unbestimmt, es sei denn wie</span>
01095     <span class="comment">// vergleichen die gleichen Spalten auf Gleichheit</span>
01096     <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column ||
01097             expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column) {
01098         truthValue = Undetermined;
01099 
01100         <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column &amp;&amp;
01101                 expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column &amp;&amp;
01102                 <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01103             <a class="code" href="class_dbj_access_plan_column.html">DbjAccessPlanColumn</a> <span class="keyword">const</span> *col1 =
01104                 static_cast&lt;DbjAccessPlanColumn const *&gt;(expr1);
01105             <a class="code" href="class_dbj_access_plan_column.html">DbjAccessPlanColumn</a> <span class="keyword">const</span> *col2 =
01106                 static_cast&lt;DbjAccessPlanColumn const *&gt;(expr2);
01107             <span class="keywordflow">if</span> (col1-&gt;<a class="code" href="class_dbj_access_plan_column.html#a2">getTableNode</a>() == col2-&gt;<a class="code" href="class_dbj_access_plan_column.html#a2">getTableNode</a>() &amp;&amp;
01108                     <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(col1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(),
01109                             col2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>()) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01110                 truthValue = <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a>;
01111             }
01112         }
01113         <span class="keywordflow">goto</span> cleanup;
01114     }
01115 
01116     <span class="comment">// Behandle IS [NOT] NULL</span>
01117     <span class="keywordflow">if</span> (expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::NullValue) {
01118         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01119             truthValue = <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01120         }
01121         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01122             truthValue = <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a>;
01123         }
01124         <span class="keywordflow">else</span> {
01125             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01126             <span class="keywordflow">goto</span> cleanup;
01127         }
01128         <span class="keywordflow">goto</span> cleanup;
01129     }
01130 
01131     <span class="keywordflow">switch</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>()) {
01132       <span class="keywordflow">case</span> DbjAccessPlan::IntegerValue:
01133           <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() == NULL || expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() == NULL) {
01134               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01135               <span class="keywordflow">goto</span> cleanup;
01136           }
01137           <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01138               truthValue = *expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() &lt; *expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() ?
01139                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01140           }
01141           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01142               truthValue = *expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() &lt;= *expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() ?
01143                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01144           }
01145           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01146               truthValue = *expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() == *expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() ?
01147                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01148           }
01149           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&gt;="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01150               truthValue = *expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() &gt;= *expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() ?
01151                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01152           }
01153           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01154               truthValue = *expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() &gt; *expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() ?
01155                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01156           }
01157           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01158               truthValue = *expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() != *expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>() ?
01159                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01160           }
01161           <span class="keywordflow">else</span> {
01162               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01163               <span class="keywordflow">goto</span> cleanup;
01164           }
01165           <span class="keywordflow">break</span>;
01166 
01167       <span class="keywordflow">case</span> DbjAccessPlan::VarcharValue:
01168           <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == NULL || expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == NULL) {
01169               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01170               <span class="keywordflow">goto</span> cleanup;
01171           }
01172           <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01173               <a class="code" href="group__datatypes.html#ga2">DbjCompareResult</a> res = <a class="code" href="group__string__def.html#ga1">DbjStringCompareCase</a>(
01174                       expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01175               truthValue = (res == <a class="code" href="group__datatypes.html#gga2a40">DBJ_SMALLER_STRING</a>) ?
01176                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01177           }
01178           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01179               <a class="code" href="group__datatypes.html#ga2">DbjCompareResult</a> res = <a class="code" href="group__string__def.html#ga1">DbjStringCompareCase</a>(
01180                       expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01181               truthValue = (res == <a class="code" href="group__datatypes.html#gga2a40">DBJ_SMALLER_STRING</a> || res == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) ?
01182                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01183           }
01184           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01185               <a class="code" href="group__datatypes.html#ga2">DbjCompareResult</a> res = <a class="code" href="group__string__def.html#ga1">DbjStringCompareCase</a>(
01186                       expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01187               truthValue = (res == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) ?
01188                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01189           }
01190           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&gt;="</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01191               <a class="code" href="group__datatypes.html#ga2">DbjCompareResult</a> res = <a class="code" href="group__string__def.html#ga1">DbjStringCompareCase</a>(
01192                       expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01193               truthValue = (res == <a class="code" href="group__datatypes.html#gga2a41">DBJ_LARGER_STRING</a> || res == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) ?
01194                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01195           }
01196           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01197               <a class="code" href="group__datatypes.html#ga2">DbjCompareResult</a> res = <a class="code" href="group__string__def.html#ga1">DbjStringCompareCase</a>(
01198                       expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01199               truthValue = (res == <a class="code" href="group__datatypes.html#gga2a41">DBJ_LARGER_STRING</a>) ?
01200                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01201           }
01202           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01203               <a class="code" href="group__datatypes.html#ga2">DbjCompareResult</a> res = <a class="code" href="group__string__def.html#ga1">DbjStringCompareCase</a>(
01204                       expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01205               truthValue = (res != <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) ?
01206                   <a class="code" href="class_dbj_optimizer.html#y3y0">AlwaysTrue</a> : <a class="code" href="class_dbj_optimizer.html#y3y1">AlwaysFalse</a>;
01207           }
01208           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"LIKE"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01209               truthValue = Undetermined;
01210           }
01211           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"NOT LIKE"</span>) ==
01212                   <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01213               truthValue = Undetermined;
01214           }
01215           <span class="keywordflow">else</span> {
01216               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01217               <span class="keywordflow">goto</span> cleanup;
01218           }
01219           <span class="keywordflow">break</span>;
01220 
01221       <span class="keywordflow">default</span>:
01222           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01223           <span class="keywordflow">goto</span> cleanup;
01224     }
01225 
01226  cleanup:
01227     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01228 }
01229 
01230 
01231 <span class="comment">// finde Index-Scans</span>
<a name="l01232"></a><a class="code" href="class_dbj_optimizer.html#d10">01232</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d10">DbjOptimizer::findIndexScans</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tableList)
01233 {
01234     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01235 
01236     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01237 
01238     <span class="keywordflow">if</span> (!tableList || tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Sources) {
01239         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01240         <span class="keywordflow">goto</span> cleanup;
01241     }
01242 
01243     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *table = tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>(); table != NULL;
01244          table = table-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
01245         <a class="code" href="class_dbj_access_plan_index.html">DbjAccessPlanIndex</a> *indexNode = NULL;
01246 
01247         <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>() == NULL) {
01248             <span class="comment">// keine Praedikate zur Tabelle zugeordnet</span>
01249             <span class="keywordflow">continue</span>;
01250         }
01251 
01252         <span class="comment">// ueberpruefe alle Praedikate</span>
01253         <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *pred = table-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
01254         <span class="keywordflow">while</span> (pred != NULL) {
01255             <span class="keywordtype">bool</span> used = <span class="keyword">false</span>;
01256 
01257             <span class="keywordflow">if</span> (pred-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
01258                 <span class="comment">// logische Operatoren ignorieren</span>
01259                 pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01260                 <span class="keywordflow">continue</span>;
01261             }
01262             <span class="keywordflow">if</span> (pred-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Predicate) {
01263                 <span class="comment">// komplexere Praedikate werden ignoriert</span>
01264                 pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01265                 <span class="keywordflow">continue</span>;
01266             }
01267 
01268             <span class="comment">// teste, ob Praedikat von Index profitiert</span>
01269             rc = <a class="code" href="class_dbj_optimizer.html#d11">findIndexForPredicate</a>(pred, indexNode, used);
01270             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01271                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01272                 <span class="keyword">delete</span> indexNode;
01273                 <span class="keywordflow">goto</span> cleanup;
01274             }
01275 
01276             <span class="comment">// Praedikat floss in Index-Scan ein - entferne es aus der Liste,</span>
01277             <span class="comment">// wenn dies moeglich ist</span>
01278             <span class="keywordflow">if</span> (used) {
01279                 <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *prev = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
01280                 <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *op = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01281                 <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *nextPred = NULL;
01282 
01283                 <span class="comment">// finde naechstes Praedikat</span>
01284                 <span class="keywordflow">if</span> (op != NULL) {
01285                     nextPred = op-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01286                     op-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
01287                 }
01288 
01289                 <span class="comment">// "pred" ist der erster Knoten unter "Table"</span>
01290                 <span class="keywordflow">if</span> (prev == NULL) {
01291                     table-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(nextPred);
01292                     <span class="keyword">delete</span> pred;
01293                     pred = nextPred;
01294                 }
01295                 <span class="comment">// pred ist irgendwo in der Liste</span>
01296                 <span class="keywordflow">else</span> {
01297                     prev-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(nextPred);
01298                     <span class="keyword">delete</span> pred;
01299                     pred = prev-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01300                     <span class="comment">// entferne letzte logische Verknuepfung</span>
01301                     <span class="keywordflow">if</span> (pred == NULL) {
01302                         prev-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>()-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
01303                         <span class="keyword">delete</span> prev;
01304                     }
01305                 }
01306             }
01307             <span class="keywordflow">else</span> {
01308                 pred = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01309             }
01310         }
01311 
01312         <span class="comment">// fuege "indexNode" in Plan ein</span>
01313         <span class="keywordflow">if</span> (indexNode != NULL) {
01314             pred = table-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
01315             table-&gt;<a class="code" href="class_dbj_access_plan.html#d1">setSon</a>(indexNode);
01316             indexNode-&gt;setSon(pred);
01317         }
01318     }
01319 
01320  cleanup:
01321     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01322 }
01323 
01324 
01325 <span class="comment">// finde Index fuer Praedikat</span>
<a name="l01326"></a><a class="code" href="class_dbj_optimizer.html#d11">01326</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d11">DbjOptimizer::findIndexForPredicate</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> <span class="keyword">const</span> *pred,
01327         <a class="code" href="class_dbj_access_plan_index.html">DbjAccessPlanIndex</a> *&amp;indexNode, <span class="keywordtype">bool</span> &amp;used)
01328 {
01329     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01330     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *expr1 = NULL;
01331     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *op = NULL;
01332     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *expr2 = NULL;
01333     <a class="code" href="class_dbj_access_plan_column.html">DbjAccessPlanColumn</a> *column = NULL;
01334     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *value = NULL;
01335 
01336     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01337 
01338     used = <span class="keyword">false</span>;
01339 
01340     <span class="keywordflow">if</span> (!pred || pred-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Predicate) {
01341         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01342         <span class="keywordflow">goto</span> cleanup;
01343     }
01344 
01345     expr1 = pred-&gt;<a class="code" href="class_dbj_access_plan.html#a4">getSon</a>();
01346     op = expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01347     expr2 = op-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01348 
01349     <span class="keywordflow">if</span> (<a class="code" href="group__trace__def.html#ga2">DBJ_TRACE_ACTIVE</a>()) {
01350         <span class="keywordtype">void</span> <span class="keyword">const</span> *expr1Data = NULL;
01351         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> expr1Length = 0;
01352         <span class="keywordtype">void</span> <span class="keyword">const</span> *expr2Data = NULL;
01353         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> expr2Length = 0;
01354 
01355         <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column ||
01356                 expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::VarcharValue) {
01357             expr1Data = expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>();
01358             expr1Length = strlen(expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01359         }
01360         <span class="keywordflow">else</span> {
01361             expr1Data = expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>();
01362             expr1Length = 4;
01363         }
01364         <span class="keywordflow">if</span> (expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column ||
01365                 expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::VarcharValue) {
01366             expr2Data = expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>();
01367             expr2Length = strlen(expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>());
01368         }
01369         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::NullValue) {
01370             expr2Data = <span class="stringliteral">"NULL"</span>;
01371             expr2Length = 4;
01372         }
01373         <span class="keywordflow">else</span> {
01374             expr2Data = expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>();
01375             expr2Length = 4;
01376         }
01377         <a class="code" href="group__trace__def.html#ga5">DBJ_TRACE_DATA3</a>(10,
01378                 expr1Length, expr1Data,
01379                 strlen(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>()), op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(),
01380                 expr2Length, expr2Data);
01381     }
01382 
01383     <span class="comment">// Vergleich zweier Spalten</span>
01384     <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column &amp;&amp;
01385             expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column) {
01386         <span class="keywordflow">goto</span> cleanup;
01387     }
01388 
01389     <span class="comment">// LIKE-Praedikate haben keine Index-Unterstuetzung</span>
01390     <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"LIKE"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a> ||
01391             <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"NOT LIKE"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a> ||
01392             <a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>(), <span class="stringliteral">"&lt;&gt;"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
01393         <span class="keywordflow">goto</span> cleanup;
01394     }
01395 
01396     <span class="comment">// IS [NOT] NULL hat keine Index-Unterstuetzung</span>
01397     <span class="keywordflow">if</span> (expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::NullValue) {
01398         <span class="keywordflow">goto</span> cleanup;
01399     }
01400 
01401     <span class="keywordflow">if</span> (expr1-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column) {
01402         column = static_cast&lt;DbjAccessPlanColumn *&gt;(expr1);
01403         value = expr2;
01404     }
01405     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (expr2-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::Column) {
01406         column = static_cast&lt;DbjAccessPlanColumn *&gt;(expr2);
01407         value = expr1;
01408     }
01409     <span class="keywordflow">else</span> {
01410         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01411         <span class="keywordflow">goto</span> cleanup;
01412     }
01413 
01414     {
01415         <a class="code" href="class_dbj_table.html">DbjTable</a> *tableDesc = column-&gt;<a class="code" href="class_dbj_access_plan_column.html#a3">getTableDescriptor</a>();
01416         <a class="code" href="group__tableid.html#ga5">IndexId</a> idxId = DBJ_UNKNOWN_INDEX_ID;
01417 
01418         <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(20, <span class="stringliteral">"Searching index for predicate"</span>);
01419         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a17">hasIndexOfType</a>(*(column-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>()), <a class="code" href="group__datatypes.html#gga1a35">BTree</a>, idxId);
01420         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01421             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01422             <span class="keywordflow">goto</span> cleanup;
01423         }
01424         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01425             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warning zuruecksetzen</span>
01426             rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a17">hasIndexOfType</a>(*(column-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>()), <a class="code" href="group__datatypes.html#gga1a36">Hash</a>, idxId);
01427             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01428                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01429                 <span class="keywordflow">goto</span> cleanup;
01430             }
01431             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01432                 <span class="comment">// auch kein Hash-Index auf der Spalte</span>
01433                 <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(20, <span class="stringliteral">"No index found"</span>);
01434                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warning zuruecksetzen</span>
01435                 <span class="keywordflow">goto</span> cleanup;
01436             }
01437 
01438             <span class="comment">// wir haben einen Hash-Index - darauf gehen keine</span>
01439             <span class="comment">// Bereichsanfragen</span>
01440             <span class="keywordflow">if</span> (*op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'&gt;'</span> || *op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>() == <span class="charliteral">'&lt;'</span>) {
01441                 <span class="keywordflow">goto</span> cleanup;
01442             }
01443         }
01444 
01445         <span class="keywordflow">if</span> (indexNode != NULL) {
01446             <span class="comment">// wir haben schon einen Index gefunden - dies ist der gleiche?</span>
01447             <span class="keywordflow">if</span> (idxId != *indexNode-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>()) {
01448                 <span class="keywordflow">goto</span> cleanup;
01449             }
01450         }
01451         <span class="keywordflow">else</span> {
01452             <span class="comment">// konstruiere und initialisiere neuen Knoten</span>
01453             <a class="code" href="class_dbj_index.html">DbjIndex</a> *idxDesc = NULL;
01454             <span class="keywordtype">char</span> <span class="keyword">const</span> *idxName = NULL;
01455             <a class="code" href="class_dbj_catalog_manager.html">DbjCatalogManager</a> *catalogMgr = <a class="code" href="class_dbj_catalog_manager.html#e0">DbjCatalogManager::getInstance</a>();
01456 
01457             indexNode = <span class="keyword">new</span> <a class="code" href="class_dbj_access_plan_index.html">DbjAccessPlanIndex</a>();
01458             <span class="keywordflow">if</span> (!indexNode) {
01459                 <span class="keywordflow">goto</span> cleanup;
01460             }
01461 
01462             rc = indexNode-&gt;setIntData(idxId);
01463             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01464                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01465                 <span class="keywordflow">goto</span> cleanup;
01466             }
01467             rc = catalogMgr-&gt;<a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(idxId, idxDesc);
01468             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01469                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01470                 <span class="keywordflow">goto</span> cleanup;
01471             }
01472             rc = indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#d0">setIndexDescriptor</a>(idxDesc);
01473             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01474                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01475                 <span class="keywordflow">goto</span> cleanup;
01476             }
01477             rc = idxDesc-&gt;<a class="code" href="class_dbj_index.html#a2">getIndexName</a>(idxName);
01478             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01479                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01480                 <span class="keywordflow">goto</span> cleanup;
01481             }
01482             rc = indexNode-&gt;setStringData(idxName);
01483             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01484                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01485                 <span class="keywordflow">goto</span> cleanup;
01486             }
01487         }
01488 
01489         <span class="keywordtype">char</span> operation = *op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>();
01490         <span class="keywordflow">if</span> (column == expr2) {
01491             <span class="comment">// drehe Vergleiche um</span>
01492             <span class="keywordflow">if</span> (operation == <span class="charliteral">'&lt;'</span>) {
01493                 operation = <span class="charliteral">'&gt;'</span>;
01494             }
01495             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (operation == <span class="charliteral">'&gt;'</span>) {
01496                 operation = <span class="charliteral">'&lt;'</span>;
01497             }
01498         }
01499 
01500         <span class="comment">// konstruiere Schluessel</span>
01501         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> *key = <span class="keyword">new</span> <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a>();
01502         <span class="keywordflow">if</span> (!key) {
01503             <span class="keywordflow">goto</span> cleanup;
01504         }
01505         <span class="keywordflow">if</span> (value-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::IntegerValue) {
01506             key-&gt;<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01507             key-&gt;<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = *(value-&gt;<a class="code" href="class_dbj_access_plan.html#a7">getIntData</a>());
01508         }
01509         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() == DbjAccessPlan::VarcharValue) {
01510             key-&gt;<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01511             <span class="keywordtype">char</span> <span class="keyword">const</span> *stringValue = value-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>();
01512             key-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = <span class="keyword">new</span> <span class="keywordtype">char</span> [strlen(stringValue)+1];
01513             <span class="keywordflow">if</span> (!key-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>) {
01514                 <span class="keyword">delete</span> key;
01515                 <span class="keywordflow">goto</span> cleanup;
01516             }
01517             key-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>[0] = <span class="charliteral">'\0'</span>;
01518             <a class="code" href="group__string__def.html#ga2">DbjStringConcat</a>(key-&gt;<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a>, stringValue);
01519         }
01520 
01521         <span class="comment">// markiere dieses Praedikat als in den Index-Scan eingeflossen, so</span>
01522         <span class="comment">// dass es aus dem Zugriffsplan entfernt werden kann</span>
01523         <span class="comment">// (dies wird zurueckgesetzt, wenn die Selektion nach dem Index-Scan</span>
01524         <span class="comment">// noch noetig ist, wie beispielsweise bei '&lt;' oder '&gt;' Vergleichen)</span>
01525         used = <span class="keyword">true</span>;
01526 
01527         <span class="comment">// Initialisiere Bereichsgrenzen des Indexscans - abhaengig von der</span>
01528         <span class="comment">// Vergleichsoperation</span>
01529         <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(40, <span class="stringliteral">"Setting index keys for scan"</span>);
01530         <span class="keywordflow">switch</span> (operation) {
01531           <span class="keywordflow">case</span> <span class="charliteral">'&lt;'</span>: <span class="comment">// &lt; und &lt;=</span>
01532               <span class="keywordflow">if</span> (indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a3">getStopKey</a>() == NULL ||
01533                       *indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a3">getStopKey</a>() &gt; *key) {
01534                   rc = indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#d2">setStopKey</a>(key);
01535                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01536                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01537                       <span class="keywordflow">goto</span> cleanup;
01538                   }
01539               }
01540               <span class="keywordflow">if</span> (op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>()[1] == <span class="charliteral">'\0'</span>) { <span class="comment">// nur &lt;</span>
01541                   used = <span class="keyword">false</span>;
01542               }
01543               <span class="keywordflow">break</span>;
01544 
01545           <span class="keywordflow">case</span> <span class="charliteral">'='</span>:
01546               <span class="keywordflow">if</span> (indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a2">getStartKey</a>() == NULL ||
01547                       *indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a2">getStartKey</a>() &lt; *key) {
01548                   rc = indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#d1">setStartKey</a>(key);
01549                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01550                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01551                       <span class="keywordflow">goto</span> cleanup;
01552                   }
01553               }
01554               <span class="keywordflow">if</span> (indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a3">getStopKey</a>() == NULL ||
01555                       *indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a3">getStopKey</a>() &gt; *key) {
01556                   rc = indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#d2">setStopKey</a>(key);
01557                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01558                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01559                       <span class="keywordflow">goto</span> cleanup;
01560                   }
01561               }
01562               <span class="keywordflow">break</span>;
01563 
01564           <span class="keywordflow">case</span> <span class="charliteral">'&gt;'</span>: <span class="comment">// &gt; und &gt;=</span>
01565               <span class="keywordflow">if</span> (indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a2">getStartKey</a>() == NULL ||
01566                       *indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#a2">getStartKey</a>() &lt; *key) {
01567                   rc = indexNode-&gt;<a class="code" href="class_dbj_access_plan_index.html#d1">setStartKey</a>(key);
01568                   <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01569                       <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01570                       <span class="keywordflow">goto</span> cleanup;
01571                   }
01572               }
01573               <span class="keywordflow">if</span> (op-&gt;<a class="code" href="class_dbj_access_plan.html#a6">getStringData</a>()[1] == <span class="charliteral">'\0'</span>) { <span class="comment">// nur &lt;</span>
01574                   used = <span class="keyword">false</span>;
01575               }
01576               <span class="keywordflow">break</span>;
01577 
01578           <span class="keywordflow">default</span>:
01579               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01580               <span class="keywordflow">goto</span> cleanup;
01581         }
01582     }
01583 
01584  cleanup:
01585     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01586 }
01587 
01588 
01589 <span class="comment">// sortiere Tabellenliste</span>
<a name="l01590"></a><a class="code" href="class_dbj_optimizer.html#d12">01590</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d12">DbjOptimizer::sortTableList</a>(<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *&amp;tableList)
01591 {
01592     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01593     <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmpList = NULL;
01594 
01595     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01596 
01597     <span class="keywordflow">if</span> (!tableList || tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Sources) {
01598         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01599         <span class="keywordflow">goto</span> cleanup;
01600     }
01601 
01602     <span class="comment">// haenge Liste aus</span>
01603     tmpList = tableList-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01604     tableList-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(NULL);
01605 
01606     <span class="comment">// teste Typen aller Knoten</span>
01607     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *tmp = tmpList; tmp != NULL; tmp = tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>()) {
01608         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="class_dbj_access_plan.html#a1">getNodeType</a>() != DbjAccessPlan::Table) {
01609             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01610             <span class="keywordflow">goto</span> cleanup;
01611         }
01612     }
01613 
01614     <span class="comment">// durchlaufe Liste und haenge jeweils die Tabelle mit den wenigsten Tupel</span>
01615     <span class="comment">// an "Sources" neu an</span>
01616     <span class="keywordflow">while</span> (tmpList != NULL) {
01617         <a class="code" href="class_dbj_access_plan_table.html">DbjAccessPlanTable</a> *current = static_cast&lt;DbjAccessPlanTable *&gt;(
01618                 tmpList);
01619         <a class="code" href="class_dbj_access_plan_table.html">DbjAccessPlanTable</a> *minCountTable = NULL;
01620         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> tupleCount = 0;
01621         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> minTupleCount = 0;
01622 
01623         <span class="comment">// finde Tabelle mit minimaler Tupel-Anzahl</span>
01624         <span class="keywordflow">while</span> (current != NULL) {
01625             rc = <a class="code" href="class_dbj_optimizer.html#d13">getTupleCount</a>(current, tupleCount);
01626             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01627                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01628                 <span class="keywordflow">goto</span> cleanup;
01629             }
01630             <span class="keywordflow">if</span> (tupleCount &lt; minTupleCount || minCountTable == NULL) {
01631                 minCountTable = current;
01632                 minTupleCount = tupleCount;
01633             }
01634             current = static_cast&lt;DbjAccessPlanTable *&gt;(current-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>());
01635         }
01636 
01637         {
01638             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *prev = minCountTable-&gt;<a class="code" href="class_dbj_access_plan.html#a3">getPrevious</a>();
01639             <a class="code" href="class_dbj_access_plan.html">DbjAccessPlan</a> *next = minCountTable-&gt;<a class="code" href="class_dbj_access_plan.html#a2">getNext</a>();
01640 
01641             <span class="comment">// haenge Minimum aus temporaerer Liste aus</span>
01642             <span class="keywordflow">if</span> (prev == NULL) {
01643                 tmpList = next;
01644             }
01645             <span class="keywordflow">else</span> {
01646                 prev-&gt;<a class="code" href="class_dbj_access_plan.html#d0">setNext</a>(next);
01647             }
01648             minCountTable-&gt;setNext(NULL);
01649 
01650             <span class="comment">// haenge es hinter Sources an</span>
01651             tableList-&gt;<a class="code" href="class_dbj_access_plan.html#d2">addNext</a>(minCountTable);
01652         }
01653 
01654         minCountTable = NULL;
01655         minTupleCount = 0;
01656     }
01657 
01658  cleanup:
01659     <span class="keywordflow">if</span> (tmpList != NULL) {
01660         tableList-&gt;<a class="code" href="class_dbj_access_plan.html#d2">addNext</a>(tmpList);
01661     }
01662     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01663 }
01664 
01665 
01666 <span class="comment">// bestimme Anzahl der Tupel in Tabelle</span>
<a name="l01667"></a><a class="code" href="class_dbj_optimizer.html#d13">01667</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_optimizer.html#d13">DbjOptimizer::getTupleCount</a>(<a class="code" href="class_dbj_access_plan_table.html">DbjAccessPlanTable</a> <span class="keyword">const</span> *tableNode,
01668         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> &amp;tupleCount)
01669 {
01670     <a class="code" href="class_dbj_table.html">DbjTable</a> *tableDesc = NULL;
01671 
01672     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01673 
01674     <span class="keywordflow">if</span> (!tableNode) {
01675         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01676         <span class="keywordflow">goto</span> cleanup;
01677     }
01678     tableDesc = tableNode-&gt;<a class="code" href="class_dbj_access_plan_table.html#a2">getTableDescriptor</a>();
01679     <span class="keywordflow">if</span> (!tableDesc) {
01680         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01681         <span class="keywordflow">goto</span> cleanup;
01682     }
01683     tupleCount = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a4">getTupleCount</a>();
01684 
01685  cleanup:
01686     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01687 }
01688 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:29 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
