<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjCatalogManager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjCatalogManager.cpp</h1><a href="_dbj_catalog_manager_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2004-2005                                                         *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include &lt;time.h&gt;</span>       <span class="comment">// localtime()</span>
00012 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>   <span class="comment">// gettimeofday()</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="_dbj_catalog_manager_8hpp.html">DbjCatalogManager.hpp</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="_dbj_record_8hpp.html">DbjRecord.hpp</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="_dbj_record_manager_8hpp.html">DbjRecordManager.hpp</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="_dbj_table_8hpp.html">DbjTable.hpp</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="_dbj_record_iterator_8hpp.html">DbjRecordIterator.hpp</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="_dbj_record_tuple_8hpp.html">DbjRecordTuple.hpp</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="_dbj_index_manager_8hpp.html">DbjIndexManager.hpp</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="_dbj_index_iterator_8hpp.html">DbjIndexIterator.hpp</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="_dbj_config_8hpp.html">DbjConfig.hpp</a>"</span>
00023 
00024 
<a name="l00025"></a><a class="code" href="_dbj_catalog_manager_8cpp.html#a0">00025</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="_dbj_catalog_manager_8cpp.html#a0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a4">CatalogManager</a>;
00026 
<a name="l00027"></a><a class="code" href="class_dbj_catalog_manager.html#v0">00027</a> <a class="code" href="class_dbj_catalog_manager.html">DbjCatalogManager</a> *<a class="code" href="class_dbj_catalog_manager.html#v0">DbjCatalogManager::instance</a>;
00028 
<a name="l00029"></a><a class="code" href="class_dbj_catalog_manager.html#s0">00029</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> <a class="code" href="class_dbj_catalog_manager.html#s0">DbjCatalogManager::SYSTABLES_ID</a>;
<a name="l00030"></a><a class="code" href="class_dbj_catalog_manager.html#s1">00030</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> <a class="code" href="class_dbj_catalog_manager.html#s1">DbjCatalogManager::SYSCOLUMNS_ID</a>;
<a name="l00031"></a><a class="code" href="class_dbj_catalog_manager.html#s2">00031</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> <a class="code" href="class_dbj_catalog_manager.html#s2">DbjCatalogManager::SYSINDEXES_ID</a>;
<a name="l00032"></a><a class="code" href="class_dbj_catalog_manager.html#s3">00032</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s3">DbjCatalogManager::MAX_CATALOG_TABLEID</a>;
<a name="l00033"></a><a class="code" href="class_dbj_catalog_manager.html#s4">00033</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s4">DbjCatalogManager::IDX_SYSTABLES_TABLEID_ID</a>;
<a name="l00034"></a><a class="code" href="class_dbj_catalog_manager.html#s5">00034</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s5">DbjCatalogManager::IDX_SYSTABLES_TABLENAME_ID</a>;
<a name="l00035"></a><a class="code" href="class_dbj_catalog_manager.html#s6">00035</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s6">DbjCatalogManager::IDX_SYSCOLUMNS_TABLEID_ID</a>;
<a name="l00036"></a><a class="code" href="class_dbj_catalog_manager.html#s7">00036</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s7">DbjCatalogManager::IDX_SYSCOLUMNS_COLUMNNAME_ID</a>;
<a name="l00037"></a><a class="code" href="class_dbj_catalog_manager.html#s8">00037</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s8">DbjCatalogManager::IDX_SYSINDEXES_TABLEID_ID</a>;
<a name="l00038"></a><a class="code" href="class_dbj_catalog_manager.html#s9">00038</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s9">DbjCatalogManager::IDX_SYSINDEXES_INDEXNAME_ID</a>;
<a name="l00039"></a><a class="code" href="class_dbj_catalog_manager.html#s10">00039</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s10">DbjCatalogManager::IDX_SYSINDEXES_INDEXID_ID</a>;
<a name="l00040"></a><a class="code" href="class_dbj_catalog_manager.html#s11">00040</a> <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> <a class="code" href="class_dbj_catalog_manager.html#s11">DbjCatalogManager::MAX_CATALOG_INDEXID</a>;
00041 
00042 
00043 <span class="comment">// Definitionen der Indexe auf Systemtabellen</span>
00044 <span class="comment">// (die Liste MUSS nach der Index-ID sortiert und lueckenlos sein)</span>
<a name="l00045"></a><a class="code" href="class_dbj_catalog_manager.html#v1">00045</a> <span class="keyword">const</span> <a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html">DbjCatalogManager::IndexDefinition</a> <a class="code" href="class_dbj_catalog_manager.html#v1">DbjCatalogManager::indexDefs</a>[] = {
00046     { <a class="code" href="class_dbj_catalog_manager.html#s4">DbjCatalogManager::IDX_SYSTABLES_TABLEID_ID</a>,
00047       <span class="stringliteral">"IDX_SYSTABLES_TABLEID_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s0">DbjCatalogManager::SYSTABLES_ID</a>,
00048       1, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>, <span class="keyword">true</span> },
00049     { <a class="code" href="class_dbj_catalog_manager.html#s5">DbjCatalogManager::IDX_SYSTABLES_TABLENAME_ID</a>,
00050       <span class="stringliteral">"IDX_SYSTABLES_TABLENAME_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s0">DbjCatalogManager::SYSTABLES_ID</a>,
00051       0, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>, <span class="keyword">true</span> },
00052     { <a class="code" href="class_dbj_catalog_manager.html#s6">DbjCatalogManager::IDX_SYSCOLUMNS_TABLEID_ID</a>,
00053       <span class="stringliteral">"IDX_SYSCOLUMNS_TABLEID_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s1">DbjCatalogManager::SYSCOLUMNS_ID</a>,
00054       0, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>, <span class="keyword">false</span> },
00055     { <a class="code" href="class_dbj_catalog_manager.html#s7">DbjCatalogManager::IDX_SYSCOLUMNS_COLUMNNAME_ID</a>,
00056       <span class="stringliteral">"IDX_SYSCOLUMNS_COLUMNNAME_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s1">DbjCatalogManager::SYSCOLUMNS_ID</a>,
00057       1, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>, <span class="keyword">false</span> },
00058     { <a class="code" href="class_dbj_catalog_manager.html#s8">DbjCatalogManager::IDX_SYSINDEXES_TABLEID_ID</a>,
00059       <span class="stringliteral">"IDX_SYSINDEXES_TABLEID_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s2">DbjCatalogManager::SYSINDEXES_ID</a>,
00060       0, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>, <span class="keyword">false</span> },
00061     { <a class="code" href="class_dbj_catalog_manager.html#s9">DbjCatalogManager::IDX_SYSINDEXES_INDEXNAME_ID</a>,
00062       <span class="stringliteral">"IDX_SYSINDEXES_INDEXNAME_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s2">DbjCatalogManager::SYSINDEXES_ID</a>,
00063       1, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>, <span class="keyword">true</span> },
00064     { <a class="code" href="class_dbj_catalog_manager.html#s10">DbjCatalogManager::IDX_SYSINDEXES_INDEXID_ID</a>,
00065       <span class="stringliteral">"IDX_SYSINDEXES_INDEXID_ID"</span>, <a class="code" href="class_dbj_catalog_manager.html#s2">DbjCatalogManager::SYSINDEXES_ID</a>,
00066       2, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>, <span class="keyword">true</span> }
00067 };
00068 
00069 
00070 <span class="comment">// Konstruktor</span>
<a name="l00071"></a><a class="code" href="class_dbj_catalog_manager.html#d0">00071</a> <a class="code" href="class_dbj_catalog_manager.html#d0">DbjCatalogManager::DbjCatalogManager</a>(<span class="keyword">const</span> <span class="keywordtype">bool</span> startTx)
00072     : indexMgr(NULL), recordMgr(NULL)
00073 {
00074     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00075 
00076     <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a> = <a class="code" href="class_dbj_index_manager.html#e0">DbjIndexManager::getInstance</a>();
00077     <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a> = <a class="code" href="class_dbj_record_manager.html#e0">DbjRecordManager::getInstance</a>();
00078 
00079     <span class="keywordflow">if</span> (startTx) {
00080         <a class="code" href="class_dbj_catalog_manager.html#a0">startTransaction</a>();
00081     }
00082 }
00083 
00084 
00085 <span class="comment">// Starte Transaktion (oeffne Index auf Katalogtabellen)</span>
<a name="l00086"></a><a class="code" href="class_dbj_catalog_manager.html#a0">00086</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a0">DbjCatalogManager::startTransaction</a>()
00087 {
00088     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00089 
00090     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00091 
00092     <span class="comment">// oeffne alle Indexe</span>
00093     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga9">Uint16</a> i = 0; i &lt; <span class="keyword">sizeof</span> <a class="code" href="class_dbj_catalog_manager.html#v1">indexDefs</a> / <span class="keyword">sizeof</span> <a class="code" href="class_dbj_catalog_manager.html#v1">indexDefs</a>[0]; i++) {
00094         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a2">openIndex</a>(<a class="code" href="class_dbj_catalog_manager.html#v1">indexDefs</a>[i].indexId, <a class="code" href="class_dbj_catalog_manager.html#v1">indexDefs</a>[i].unique,
00095                 <a class="code" href="group__datatypes.html#gga1a35">BTree</a>, <a class="code" href="class_dbj_catalog_manager.html#v1">indexDefs</a>[i].dataType);
00096         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00097             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00098             <span class="keywordflow">goto</span> cleanup;
00099         }
00100     }
00101 
00102  cleanup:
00103     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00104 }
00105 
00106 
00107 <span class="comment">/* Falls es sich um Systemtabellen handelt werden die ID's direkt </span>
00108 <span class="comment">   zurueckgegeben und nicht aus der DB geholt*/</span>
<a name="l00109"></a><a class="code" href="class_dbj_catalog_manager.html#a1">00109</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a1">DbjCatalogManager::getTableId</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *tableName,
00110         <a class="code" href="group__tableid.html#ga1">TableId</a> &amp;tableId)
00111 {
00112     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00113     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
00114     <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
00115     <a class="code" href="class_dbj_table.html">DbjTable</a> *sysTables = NULL;
00116     <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *recordTableId = 0;
00117 
00118     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00119 
00120     <span class="keywordflow">if</span> (!tableName) {
00121         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00122         <span class="keywordflow">goto</span> cleanup;
00123     }
00124     <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(1, tableName);
00125     
00126     <span class="comment">// Spezialbehandlung fuer die Systemtabellen</span>
00127     <span class="keywordflow">if</span> (*tableName == <span class="charliteral">'S'</span>) {
00128         <span class="comment">// SYSTABLES</span>
00129         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(tableName, <span class="stringliteral">"SYSTABLES"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00130             tableId = <a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>;
00131             <span class="keywordflow">goto</span> cleanup;
00132         }
00133         <span class="comment">// SYSCOLUMNS</span>
00134         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(tableName, <span class="stringliteral">"SYSCOLUMNS"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00135             tableId = <a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>;
00136             <span class="keywordflow">goto</span> cleanup;
00137         }
00138         <span class="comment">// SYSINDEXES</span>
00139         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(tableName, <span class="stringliteral">"SYSINDEXES"</span>) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00140             tableId = <a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>;
00141             <span class="keywordflow">goto</span> cleanup;
00142         }
00143     }
00144 
00145     <span class="comment">// suche die tableId mit Hilfe des Indexes der auf tableName in SYSTABLES</span>
00146     <span class="comment">// liegt --&gt; IndexId = IDX_SYSTABLES_TABLENAME_ID</span>
00147     {
00148         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> key;
00149         key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
00150         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = const_cast&lt;char*&gt;(tableName);
00151         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s5">IDX_SYSTABLES_TABLENAME_ID</a>, key, tupleId);
00152         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
00153         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00154             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00155             <span class="keywordflow">goto</span> cleanup;
00156         }
00157     }
00158     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, sysTables);
00159     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00160         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00161         <span class="keywordflow">goto</span> cleanup;
00162     }
00163     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId, record);
00164     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00165         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00166         <span class="keywordflow">goto</span> cleanup;
00167     }
00168     {
00169         <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> recordTuple(record, sysTables);
00170         <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00171             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00172             <span class="keywordflow">goto</span> cleanup;
00173         }
00174         record = NULL;
00175         rc = recordTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(1, recordTableId);
00176         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00177             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00178             <span class="keywordflow">goto</span> cleanup;
00179         }
00180         <span class="keywordflow">if</span> (recordTableId == NULL || *recordTableId &lt;= 0) {
00181             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00182             <span class="keywordflow">goto</span> cleanup;
00183         }
00184 
00185         <span class="comment">//tableId setzten</span>
00186         tableId = *recordTableId;
00187     }
00188 
00189  cleanup:
00190     <span class="keyword">delete</span> sysTables;
00191     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00192 }
00193 
00194 
<a name="l00195"></a><a class="code" href="class_dbj_catalog_manager.html#a3">00195</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a3">DbjCatalogManager::getIndexId</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *indexName,
00196         <a class="code" href="group__tableid.html#ga5">IndexId</a> &amp;indexId)
00197 {
00198     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00199     <a class="code" href="class_dbj_table.html">DbjTable</a> *sysIndexes = NULL;
00200     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
00201     <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
00202 
00203     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00204 
00205     <span class="keywordflow">if</span> (!indexName) {
00206         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00207         <span class="keywordflow">goto</span> cleanup;
00208     }
00209     <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(1, indexName);
00210 
00211     <span class="comment">// Falls es sich um einen Index auf den Systemtabellen handelt, kann die</span>
00212     <span class="comment">// ID direkt zurueckgegeben werden</span>
00213     <span class="keywordflow">if</span> (*indexName == <span class="charliteral">'I'</span>) {
00214         <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSTABLES_TABLEID_ID"</span>) ==
00215                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00216             indexId = <a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>;
00217             <span class="keywordflow">goto</span> cleanup;
00218         }
00219         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSTABLES_TABLENAME_ID"</span>) ==
00220                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00221             indexId = <a class="code" href="class_dbj_catalog_manager.html#s5">IDX_SYSTABLES_TABLENAME_ID</a>;
00222             <span class="keywordflow">goto</span> cleanup;
00223         }
00224         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSCOLUMNS_TABLEID_ID"</span>) ==
00225                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00226             indexId = <a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>;
00227             <span class="keywordflow">goto</span> cleanup;
00228         }
00229         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSCOLUMNS_COLUMNNAME_ID"</span>) ==
00230                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00231             indexId = <a class="code" href="class_dbj_catalog_manager.html#s7">IDX_SYSCOLUMNS_COLUMNNAME_ID</a>;
00232             <span class="keywordflow">goto</span> cleanup;
00233         }
00234         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSINDEXES_TABLEID_ID"</span>) ==
00235                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00236             indexId = <a class="code" href="class_dbj_catalog_manager.html#s8">IDX_SYSINDEXES_TABLEID_ID</a>;
00237             <span class="keywordflow">goto</span> cleanup;
00238         }
00239         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSINDEXES_INDEXNAME_ID"</span>) ==
00240                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00241             indexId = <a class="code" href="class_dbj_catalog_manager.html#s9">IDX_SYSINDEXES_INDEXNAME_ID</a>;
00242             <span class="keywordflow">goto</span> cleanup;
00243         }
00244         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(indexName, <span class="stringliteral">"IDX_SYSINDEXES_INDEXID_ID"</span>) ==
00245                 <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00246             indexId = <a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>;
00247             <span class="keywordflow">goto</span> cleanup;
00248         }
00249     }
00250 
00251     <span class="comment">/*</span>
00252 <span class="comment">     * Sonstige Indexe</span>
00253 <span class="comment">     */</span>
00254 
00255     <span class="comment">// hole Tupel fuer Index aus SYSINDEXES Tabelle (via Index-Scan)</span>
00256     {
00257         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> idxKey;
00258         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
00259         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> =  const_cast&lt;char *&gt;(indexName);
00260         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s9">IDX_SYSINDEXES_INDEXNAME_ID</a>, idxKey, tupleId);
00261         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
00262         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00263             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00264             <span class="keywordflow">goto</span> cleanup;
00265         }
00266     }
00267     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, sysIndexes);
00268     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00269         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00270         <span class="keywordflow">goto</span> cleanup;
00271     }
00272     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, tupleId, record);
00273     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00274         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00275         <span class="keywordflow">goto</span> cleanup;
00276     }
00277     {
00278         <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> recTuple(record, sysIndexes);
00279         <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *sintIndexId = NULL;
00280         record = NULL;
00281         recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(2, sintIndexId); <span class="comment">// IndexId aus Tuple auslesen</span>
00282         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00283             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00284             <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00285         }
00286         <span class="keywordflow">if</span> (sintIndexId == NULL || *sintIndexId &lt;= 0 ||
00287                 *sintIndexId &gt; DBJ_MAX_INDEX_ID) {
00288             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00289             <span class="keywordflow">goto</span> cleanup;
00290         }
00291 
00292         indexId = *sintIndexId;
00293     }
00294 
00295  cleanup:
00296     <span class="keyword">delete</span> sysIndexes;
00297     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00298 }
00299 
<a name="l00300"></a><a class="code" href="class_dbj_catalog_manager.html#a2">00300</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a2">DbjCatalogManager::getTableDescriptor</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
00301         <a class="code" href="class_dbj_table.html">DbjTable</a> *&amp;tableDesc)
00302 {
00303     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00304     <a class="code" href="class_dbj_table.html">DbjTable</a> *systemTable = NULL;
00305     <a class="code" href="class_dbj_index_iterator.html">DbjIndexIterator</a> *iter = NULL;
00306     <span class="keywordtype">bool</span> gotDesc = <span class="keyword">false</span>;
00307 
00308     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00309     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
00310 
00311     <span class="keywordflow">if</span> (tableDesc == NULL) {
00312         tableDesc = <span class="keyword">new</span> <a class="code" href="class_dbj_table.html">DbjTable</a>;
00313         <span class="keywordflow">if</span> (!tableDesc) {
00314             <span class="keywordflow">goto</span> cleanup;
00315         }
00316         gotDesc = <span class="keyword">true</span>;
00317     }
00318 
00319     <span class="comment">// somit koennen wir den Deskriptor auch modifizieren</span>
00320     tableDesc-&gt;<a class="code" href="class_dbj_table.html#r0">tableId</a> = <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a> + 1;
00321 
00322     <span class="comment">// SYSTABLES</span>
00323     <span class="keywordflow">if</span> (tableId == <a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>) {
00324         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a20">createColumns</a>(5);
00325         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00326             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00327             <span class="keywordflow">goto</span> cleanup;
00328         }
00329         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a18">setTableName</a>(<span class="stringliteral">"SYSTABLES"</span>);
00330         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00331             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00332             <span class="keywordflow">goto</span> cleanup;
00333         }
00334         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(0, <span class="stringliteral">"TABLE_NAME"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00335                 DBJ_MAX_TABLE_NAME_LENGTH, <span class="keyword">false</span>);
00336         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00337             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00338             <span class="keywordflow">goto</span> cleanup;
00339         }
00340         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(1, <span class="stringliteral">"TABLE_ID"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00341                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00342         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00343             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00344             <span class="keywordflow">goto</span> cleanup;
00345         }
00346         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(2, <span class="stringliteral">"COLUMN_COUNT"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00347                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00348         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00349             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00350             <span class="keywordflow">goto</span> cleanup;
00351         }
00352         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(3, <span class="stringliteral">"CREATE_TIME"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00353                 26, <span class="keyword">false</span>);
00354         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00355             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00356             <span class="keywordflow">goto</span> cleanup;
00357         }
00358         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(4, <span class="stringliteral">"TUPLE_COUNT"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00359                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00360         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00361             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00362             <span class="keywordflow">goto</span> cleanup;
00363         }
00364     }
00365     <span class="comment">// SYSCOLUMNS</span>
00366     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tableId == <a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>) {
00367         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a20">createColumns</a>(6);
00368         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00369             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00370             <span class="keywordflow">goto</span> cleanup;
00371         }
00372         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a18">setTableName</a>(<span class="stringliteral">"SYSCOLUMNS"</span>);
00373         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00374             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00375             <span class="keywordflow">goto</span> cleanup;
00376         }
00377         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(0, <span class="stringliteral">"TABLE_ID"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00378                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00379         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00380             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00381             <span class="keywordflow">goto</span> cleanup;
00382         }
00383         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(1, <span class="stringliteral">"COLUMN_NAME"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00384                 DBJ_MAX_COLUMN_NAME_LENGTH, <span class="keyword">false</span>);
00385         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00386             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00387             <span class="keywordflow">goto</span> cleanup;
00388         }
00389         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(2, <span class="stringliteral">"COLUMN_ID"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00390                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00391         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00392             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00393             <span class="keywordflow">goto</span> cleanup;
00394         }
00395         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(3, <span class="stringliteral">"DATA_TYPE"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00396                 128, <span class="keyword">false</span>);
00397         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00398             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00399             <span class="keywordflow">goto</span> cleanup;
00400         }
00401         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(4, <span class="stringliteral">"MAX_LENGTH"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00402                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00403         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00404             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00405             <span class="keywordflow">goto</span> cleanup;
00406         }
00407         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(5, <span class="stringliteral">"NULLABLE"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00408                 1, <span class="keyword">false</span>);
00409         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00410             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00411             <span class="keywordflow">goto</span> cleanup;
00412         }
00413     }
00414     <span class="comment">// SYSINDEXES</span>
00415     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tableId == <a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>) {
00416         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a20">createColumns</a>(7);
00417         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00418             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00419             <span class="keywordflow">goto</span> cleanup;
00420         }
00421         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a18">setTableName</a>(<span class="stringliteral">"SYSINDEXES"</span>);
00422         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00423             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00424             <span class="keywordflow">goto</span> cleanup;
00425         }
00426         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(0, <span class="stringliteral">"TABLE_ID"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00427                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00428         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00429             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00430             <span class="keywordflow">goto</span> cleanup;
00431         }
00432         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(1, <span class="stringliteral">"INDEX_NAME"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00433                 DBJ_MAX_INDEX_NAME_LENGTH, <span class="keyword">false</span>);
00434         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00435             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00436             <span class="keywordflow">goto</span> cleanup;
00437         }
00438         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(2, <span class="stringliteral">"INDEX_ID"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00439                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00440         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00441             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00442             <span class="keywordflow">goto</span> cleanup;
00443         }
00444         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(3, <span class="stringliteral">"INDEX_TYPE"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00445                 5, <span class="keyword">false</span>);
00446         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00447             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00448             <span class="keywordflow">goto</span> cleanup;
00449         }
00450         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(4, <span class="stringliteral">"COLUMN_ID"</span>, <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>,
00451                 <span class="keyword">sizeof</span>(<a class="code" href="group__int__datatypes.html#ga12">Sint32</a>), <span class="keyword">false</span>);
00452         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00453             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00454             <span class="keywordflow">goto</span> cleanup;
00455         }
00456         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(5, <span class="stringliteral">"IS_UNIQUE"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00457                 1, <span class="keyword">false</span>);
00458         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00459             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00460             <span class="keywordflow">goto</span> cleanup;
00461         }
00462         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(6, <span class="stringliteral">"CREATE_TIME"</span>, <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>,
00463                 26, <span class="keyword">false</span>);
00464         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00465             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00466             <span class="keywordflow">goto</span> cleanup;
00467         }
00468     }
00469 
00470     <span class="comment">// sonstige Tabellen</span>
00471     <span class="keywordflow">else</span> {
00472         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> key;
00473         <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
00474         <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
00475 
00476         tableDesc-&gt;<a class="code" href="class_dbj_table.html#r0">tableId</a> = tableId;
00477 
00478         <span class="comment">// Frage SYSTABLES ab (via Index-Zugriff)</span>
00479         rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, systemTable);
00480         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00481             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00482             <span class="keywordflow">goto</span> cleanup;
00483         }
00484 
00485         key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
00486         key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
00487         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, key, tupleId);
00488         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00489             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00490             <span class="keywordflow">goto</span> cleanup;
00491         }
00492         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId, record);
00493         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00494             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00495             <span class="keywordflow">goto</span> cleanup;
00496         }
00497         {
00498             <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> numColumns = 0;
00499             <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *columnCount = NULL;
00500             <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> recTuple(record, systemTable);
00501             <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00502                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00503                 <span class="keywordflow">goto</span> cleanup;
00504             }
00505             record = NULL;
00506 
00507             <span class="comment">// TABLE_NAME</span>
00508             {
00509                 <span class="keyword">const</span> <span class="keywordtype">char</span> *tableName = NULL;
00510                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> tableNameLength = 0;
00511                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(0, tableName, tableNameLength);
00512                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00513                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00514                     <span class="keywordflow">goto</span> cleanup;
00515                 }
00516                 <span class="keywordflow">if</span> (!tableName) {
00517                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00518                     <span class="keywordflow">goto</span> cleanup;
00519                 }
00520                 rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a18">setTableName</a>(tableName, tableNameLength);
00521                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00522                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00523                     <span class="keywordflow">goto</span> cleanup;
00524                 }
00525             }
00526 
00527             <span class="comment">// TABLE_ID (wird nur verifiziert)</span>
00528             {
00529                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *<span class="keywordtype">id</span> = 0;
00530                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(1, <span class="keywordtype">id</span>);
00531                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00532                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00533                     <span class="keywordflow">goto</span> cleanup;
00534                 }
00535                 <span class="keywordflow">if</span> (!<span class="keywordtype">id</span> || *<span class="keywordtype">id</span> != tableId) {
00536                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00537                     <span class="keywordflow">goto</span> cleanup;
00538                 }
00539             }
00540 
00541             <span class="comment">// COLUMN_COUNT</span>
00542             rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(2, columnCount);
00543             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00544                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00545                 <span class="keywordflow">goto</span> cleanup;
00546             }
00547             <span class="keywordflow">if</span> (!columnCount || *columnCount &lt; 1 ||
00548                     *columnCount &gt; DBJ_MAX_UINT16) {
00549                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00550                 <span class="keywordflow">goto</span> cleanup;
00551             }
00552             rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a20">createColumns</a>(*columnCount);
00553             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00554                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00555                 <span class="keywordflow">goto</span> cleanup;
00556             }
00557 
00558             <span class="comment">// TUPLE_COUNT</span>
00559             {
00560                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *tupleCount = 0;
00561                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(4, tupleCount);
00562                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00563                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00564                     <span class="keywordflow">goto</span> cleanup;
00565                 }
00566                 <span class="keywordflow">if</span> (!tupleCount || *tupleCount &lt; 0) {
00567                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00568                     <span class="keywordflow">goto</span> cleanup;
00569                 }
00570                 tableDesc-&gt;<a class="code" href="class_dbj_table.html#r2">tupleCount</a> = *tupleCount;
00571             }
00572 
00573             tableDesc-&gt;<a class="code" href="class_dbj_table.html#r7">numIndexes</a> = 0;
00574 
00575             <span class="comment">// Frage SYSCOLUMNS ab (via Index-Scan)</span>
00576             rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, systemTable);
00577             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00578                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00579                 <span class="keywordflow">goto</span> cleanup;
00580             }
00581 
00582             key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
00583             key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
00584             rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a6">findRange</a>(<a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>, &amp;key, &amp;key, iter);
00585             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00586                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00587                 <span class="keywordflow">goto</span> cleanup;
00588             }
00589             <span class="comment">// verarbeite alle Spalten</span>
00590             <span class="keywordflow">while</span> (iter-&gt;<a class="code" href="class_dbj_index_iterator.html#a1">hasNext</a>()) {
00591                 <span class="keywordtype">char</span> columnName[DBJ_MAX_COLUMN_NAME_LENGTH+1] = { <span class="charliteral">'\0'</span> };
00592                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *columnId = NULL;
00593                 <a class="code" href="group__datatypes.html#ga0">DbjDataType</a> dataType = <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>;
00594                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *maxLength = NULL;
00595                 <span class="keywordtype">bool</span> nullable = <span class="keyword">false</span>;
00596                 numColumns++;
00597 
00598                 rc = iter-&gt;<a class="code" href="class_dbj_index_iterator.html#a2">getNextTupleId</a>(tupleId);
00599                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00600                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00601                     <span class="keywordflow">goto</span> cleanup;
00602                 }
00603 
00604                 rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, tupleId, record);
00605                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00606                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00607                     <span class="keywordflow">goto</span> cleanup;
00608                 }
00609 
00610                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a3">initialize</a>(record, systemTable);
00611                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00612                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00613                     <span class="keywordflow">goto</span> cleanup;
00614                 }
00615 
00616                 <span class="comment">// COLUMN_NAME</span>
00617                 {
00618                     <span class="keyword">const</span> <span class="keywordtype">char</span> *colName = NULL;
00619                     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> colNameLength = 0;
00620                     rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(1, colName, colNameLength);
00621                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00622                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00623                         <span class="keywordflow">goto</span> cleanup;
00624                     }
00625                     <span class="keywordflow">if</span> (!colName ||
00626                             colNameLength &gt; DBJ_MAX_COLUMN_NAME_LENGTH) {
00627                         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00628                         <span class="keywordflow">goto</span> cleanup;
00629                     }
00630                     <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(columnName, colName, colNameLength);
00631                     columnName[colNameLength] = <span class="charliteral">'\0'</span>;
00632                 }
00633 
00634                 <span class="comment">// COLUMN_ID</span>
00635                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(2, columnId);
00636                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00637                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00638                     <span class="keywordflow">goto</span> cleanup;
00639                 }
00640                 <span class="keywordflow">if</span> (!columnId || *columnId &lt; 0 ||
00641                         *columnId &gt; tableDesc-&gt;<a class="code" href="class_dbj_table.html#r3">numColumns</a>) {
00642                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00643                     <span class="keywordflow">goto</span> cleanup;
00644                 }
00645 
00646                 <span class="comment">// DATA_TYPE</span>
00647                 {
00648                     <span class="keyword">const</span> <span class="keywordtype">char</span> *type = NULL;
00649                     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> typeLength = 0;
00650                     rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(3, type, typeLength);
00651                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00652                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00653                         <span class="keywordflow">goto</span> cleanup;
00654                     }
00655                     <span class="keywordflow">if</span> (!type) {
00656                         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00657                         <span class="keywordflow">goto</span> cleanup;
00658                     }
00659                     <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(<span class="stringliteral">"VARCHAR"</span>, type,
00660                                 typeLength) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00661                         dataType = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
00662                     }
00663                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(<span class="stringliteral">"INTEGER"</span>, type,
00664                                      typeLength) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00665                         dataType = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
00666                     }
00667                     <span class="keywordflow">else</span> {
00668                         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00669                         <span class="keywordflow">goto</span> cleanup;
00670                     }
00671                 }
00672 
00673                 <span class="comment">// MAX_LENGTH</span>
00674                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(4, maxLength);
00675                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00676                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00677                     <span class="keywordflow">goto</span> cleanup;
00678                 }
00679                 <span class="keywordflow">if</span> (!maxLength || *maxLength &lt;= 0 ||
00680                         *maxLength &gt; DBJ_MAX_UINT16) {
00681                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00682                     <span class="keywordflow">goto</span> cleanup;
00683                 }
00684 
00685                 <span class="comment">// NULLABLE</span>
00686                 {
00687                     <span class="keyword">const</span> <span class="keywordtype">char</span> *nulls = NULL;
00688                     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> nullsLength = 0;
00689                     rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(5, nulls, nullsLength);
00690                     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00691                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00692                         <span class="keywordflow">goto</span> cleanup;
00693                     }
00694                     <span class="keywordflow">if</span> (!nulls || nullsLength != 1) {
00695                         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00696                         <span class="keywordflow">goto</span> cleanup;
00697                     }
00698                     <span class="keywordflow">switch</span> (*nulls) {
00699                       <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>: nullable = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
00700                       <span class="keywordflow">case</span> <span class="charliteral">'N'</span>: nullable = <span class="keyword">false</span>; <span class="keywordflow">break</span>;
00701                       <span class="keywordflow">default</span>:
00702                           <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00703                           <span class="keywordflow">goto</span> cleanup;
00704                     }
00705                 }
00706 
00707                 rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a21">setColumnDefinition</a>(*columnId, columnName,
00708                         dataType, *maxLength, nullable);
00709                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00710                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00711                     <span class="keywordflow">goto</span> cleanup;
00712                 }
00713             } <span class="comment">// end Index-Scan ueber SYSCOLUMNS</span>
00714             <span class="keywordflow">if</span> (numColumns != *columnCount) {
00715                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00716                 <span class="keywordflow">goto</span> cleanup;
00717             }
00718         } <span class="comment">// "recTuple" wird hier freigegeben</span>
00719     }
00720 
00721     tableDesc-&gt;<a class="code" href="class_dbj_table.html#r0">tableId</a> = tableId;
00722 
00723  cleanup:
00724     <span class="keywordflow">if</span> (gotDesc &amp;&amp; <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00725         <span class="keyword">delete</span> tableDesc;
00726         tableDesc = NULL;
00727     }
00728     <span class="keyword">delete</span> systemTable;
00729     <span class="keyword">delete</span> iter;
00730     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();;    
00731 }
00732 
00733 
<a name="l00734"></a><a class="code" href="class_dbj_catalog_manager.html#a4">00734</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a4">DbjCatalogManager::getIndexDescriptor</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> indexId,
00735         <a class="code" href="class_dbj_index.html">DbjIndex</a> *&amp;indexDesc)
00736 {
00737     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00738     <a class="code" href="group__tableid.html#ga1">TableId</a> tableId = DBJ_UNKNOWN_TABLE_ID;
00739     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> columnId = 0;
00740     <a class="code" href="group__datatypes.html#ga1">DbjIndexType</a> indexType = <a class="code" href="group__datatypes.html#gga1a37">UnknownIndexType</a>;
00741     <span class="keywordtype">bool</span> unique = <span class="keyword">false</span>;
00742     <span class="keywordtype">bool</span> gotDesc = <span class="keyword">false</span>;
00743     <a class="code" href="class_dbj_table.html">DbjTable</a> *sysIndexes = NULL;
00744     <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
00745 
00746     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00747     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Index ID"</span>, indexId);
00748 
00749     <span class="keywordflow">if</span> (!indexDesc) {
00750         indexDesc = <span class="keyword">new</span> <a class="code" href="class_dbj_index.html">DbjIndex</a>();
00751         <span class="keywordflow">if</span> (!indexDesc) {
00752             <span class="keywordflow">goto</span> cleanup;
00753         }
00754         gotDesc = <span class="keyword">true</span>;
00755     }
00756 
00757     <span class="comment">// somit koennen wir den Index-Deskriptor modifizieren</span>
00758     indexDesc-&gt;<a class="code" href="class_dbj_index.html#r0">indexId</a> = <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a> + 1;
00759 
00760     <span class="comment">// Sonderbehandlung fuer Indexe auf Systemtabellen</span>
00761     <span class="keywordflow">if</span> (indexId &lt;= <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a>) {
00762         <span class="keyword">const</span> <span class="keywordtype">char</span> *indexName = NULL;
00763         <a class="code" href="group__datatypes.html#ga0">DbjDataType</a> dataType = <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>;
00764 
00765         rc = <a class="code" href="class_dbj_catalog_manager.html#d6">getSystemIndexParameters</a>(indexId, indexName, tableId, columnId,
00766                 dataType, unique);
00767         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00768             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00769             <span class="keywordflow">goto</span> cleanup;
00770         }
00771 
00772         rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a7">setIndexName</a>(indexName);
00773         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00774             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00775             <span class="keywordflow">goto</span> cleanup;
00776         }
00777         indexType = <a class="code" href="group__datatypes.html#gga1a35">BTree</a>; <span class="comment">// alle Katalogindexe sind B-Baeume</span>
00778     }
00779 
00780     <span class="comment">/*</span>
00781 <span class="comment">     * Sonstige Indexe</span>
00782 <span class="comment">     */</span>
00783     <span class="keywordflow">else</span> {
00784         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> idxKey;
00785         <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
00786 
00787         rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, sysIndexes);
00788         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00789             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00790             <span class="keywordflow">goto</span> cleanup;
00791         }
00792 
00793         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
00794         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = indexId;
00795         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, idxKey, tupleId);
00796         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00797             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00798             <span class="keywordflow">goto</span> cleanup;
00799         }
00800         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, tupleId, record);
00801         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00802             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00803             <span class="keywordflow">goto</span> cleanup;
00804         }
00805         {
00806             <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> recTuple(record, sysIndexes);
00807             <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00808                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00809                 <span class="keywordflow">goto</span> cleanup;
00810             }
00811             record = NULL;
00812 
00813             <span class="comment">// TABLE_ID</span>
00814             {
00815                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *intValue = NULL;
00816                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(0, intValue);
00817                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00818                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00819                     <span class="keywordflow">goto</span> cleanup;
00820                 }
00821                 <span class="keywordflow">if</span> (!intValue || *intValue &lt;= 0 || *intValue &gt; DBJ_MAX_TABLE_ID) {
00822                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00823                     <span class="keywordflow">goto</span> cleanup;
00824                 }
00825                 tableId = *intValue;
00826             }
00827 
00828             <span class="comment">// INDEX_NAME</span>
00829             {
00830                 <span class="keyword">const</span> <span class="keywordtype">char</span> *idxName = NULL;
00831                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> idxNameLength = 0;
00832                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(1, idxName, idxNameLength);
00833                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00834                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00835                     <span class="keywordflow">goto</span> cleanup;
00836                 }
00837                 <span class="keywordflow">if</span> (!idxName) {
00838                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00839                     <span class="keywordflow">goto</span> cleanup;
00840                 }
00841                 rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a7">setIndexName</a>(idxName, idxNameLength);
00842                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00843                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00844                     <span class="keywordflow">goto</span> cleanup;
00845                 }
00846             }
00847 
00848             <span class="comment">// INDEX_ID (wird nur verifiziert)</span>
00849             {
00850                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *intValue = NULL;
00851                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(2, intValue);
00852                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00853                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00854                     <span class="keywordflow">goto</span> cleanup;
00855                 }
00856                 <span class="keywordflow">if</span> (!intValue || *intValue != indexId) {
00857                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00858                     <span class="keywordflow">goto</span> cleanup;
00859                 }
00860             }
00861 
00862             <span class="comment">// INDEX_TYPE</span>
00863             {
00864                 <span class="keyword">const</span> <span class="keywordtype">char</span> *type = NULL;
00865                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> typeLength = 0;
00866                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(3, type, typeLength);
00867                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00868                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00869                     <span class="keywordflow">goto</span> cleanup;
00870                 }
00871                 <span class="keywordflow">if</span> (!type) {
00872                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00873                     <span class="keywordflow">goto</span> cleanup;
00874                 }
00875                 <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(<span class="stringliteral">"HASH"</span>, type, typeLength) == <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00876                     indexType = <a class="code" href="group__datatypes.html#gga1a36">Hash</a>;
00877                 }
00878                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__string__def.html#ga0">DbjStringCompare</a>(<span class="stringliteral">"BTREE"</span>, type, typeLength) ==
00879                         <a class="code" href="group__datatypes.html#gga2a38">DBJ_EQUALS</a>) {
00880                     indexType = <a class="code" href="group__datatypes.html#gga1a35">BTree</a>;
00881                 }
00882                 <span class="keywordflow">else</span> {
00883                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00884                     <span class="keywordflow">goto</span> cleanup;
00885                 }
00886             }
00887 
00888             <span class="comment">// COLUMN_ID</span>
00889             {
00890                 <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *intValue = NULL;
00891                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(4, intValue);
00892                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00893                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00894                     <span class="keywordflow">goto</span> cleanup;
00895                 }
00896                 <span class="keywordflow">if</span> (!intValue || *intValue &lt; 0 || *intValue &gt; DBJ_MAX_UINT16) {
00897                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00898                     <span class="keywordflow">goto</span> cleanup;
00899                 }
00900                 columnId = *intValue;
00901             }
00902 
00903             <span class="comment">// IS_UNIQUE</span>
00904             {
00905                 <span class="keyword">const</span> <span class="keywordtype">char</span> *uniq = NULL;
00906                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> uniqueLength = 0;
00907                 rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(5, uniq, uniqueLength);
00908                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00909                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00910                     <span class="keywordflow">goto</span> cleanup;
00911                 }
00912                 <span class="keywordflow">if</span> (!uniq || uniqueLength != 1) {
00913                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00914                     <span class="keywordflow">goto</span> cleanup;
00915                 }
00916                 <span class="keywordflow">if</span> (*uniq == <span class="charliteral">'Y'</span>) {
00917                     unique = <span class="keyword">true</span>;
00918                 }
00919                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*uniq == <span class="charliteral">'N'</span>) {
00920                     unique = <span class="keyword">false</span>;
00921                 }
00922                 <span class="keywordflow">else</span> {
00923                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
00924                     <span class="keywordflow">goto</span> cleanup;
00925                 }
00926             }
00927         } <span class="comment">// "recTuple" wird hier freigegeben</span>
00928     }
00929 
00930     rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a10">setTableId</a>(tableId);
00931     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00932         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00933         <span class="keywordflow">goto</span> cleanup;
00934     }
00935     rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a9">setIndexType</a>(indexType);
00936     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00937         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00938         <span class="keywordflow">goto</span> cleanup;
00939     }
00940     rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a11">setColumnNumber</a>(columnId);
00941     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00942         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00943         <span class="keywordflow">goto</span> cleanup;
00944     }
00945     rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a12">setUnique</a>(unique);
00946     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00947         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00948         <span class="keywordflow">goto</span> cleanup;
00949     }
00950     indexDesc-&gt;<a class="code" href="class_dbj_index.html#r0">indexId</a> = indexId;
00951 
00952  cleanup:
00953     <span class="keywordflow">if</span> (gotDesc &amp;&amp; <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00954         <span class="keyword">delete</span> indexDesc;
00955         indexDesc = NULL;
00956     }
00957     <span class="keyword">delete</span> sysIndexes;
00958     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00959 }
00960 
<a name="l00961"></a><a class="code" href="class_dbj_catalog_manager.html#d3">00961</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a5">DbjCatalogManager::addTable</a>(<a class="code" href="class_dbj_table.html">DbjTable</a> &amp;tableDesc,
00962         <span class="keyword">const</span> <span class="keywordtype">bool</span> protectCatalog, <a class="code" href="group__tableid.html#ga1">TableId</a> &amp;tableId)
00963 {
00964     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00965     <a class="code" href="class_dbj_table.html">DbjTable</a> *systemTable = NULL;
00966     <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> *recordTuple = NULL;
00967     <span class="keyword">const</span> <span class="keywordtype">char</span> *tableName = NULL;
00968     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> numColumns = 0;
00969     <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> intValue = 0;
00970     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> idxKey;
00971     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
00972 
00973     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00974 
00975     <span class="keywordflow">if</span> (protectCatalog) {
00976         <span class="keywordflow">if</span> (tableDesc.<a class="code" href="class_dbj_table.html#r0">tableId</a> &lt;= <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a> &amp;&amp;
00977                 tableDesc.<a class="code" href="class_dbj_table.html#r0">tableId</a> != DBJ_UNKNOWN_TABLE_ID) {
00978             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a33">DBJ_CAT_MODIFYING_CATALOG_TABLES_NOT_ALLOWED</a>);
00979             <span class="keywordflow">goto</span> cleanup;
00980         }
00981     }
00982 
00983     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, systemTable);
00984     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00985         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00986         <span class="keywordflow">goto</span> cleanup;
00987     }
00988     recordTuple = <span class="keyword">new</span> <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a>(systemTable);
00989     <span class="keywordflow">if</span> (!recordTuple || <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00990         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00991         <span class="keywordflow">goto</span> cleanup;
00992     }
00993 
00994     <span class="comment">/*</span>
00995 <span class="comment">     * Setze die einzelnen Attribute</span>
00996 <span class="comment">     */</span>
00997 
00998     <span class="comment">// TABLE_NAME</span>
00999     rc = tableDesc.<a class="code" href="class_dbj_table.html#a3">getTableName</a>(tableName);
01000     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01001         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01002         <span class="keywordflow">goto</span> cleanup;
01003     }
01004     rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(0, tableName, strlen(tableName));
01005     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01006         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01007         <span class="keywordflow">goto</span> cleanup;
01008     }
01009 
01010     <span class="comment">// TABLE_ID</span>
01011     {
01012         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01013         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = 0; <span class="comment">// wird ignoriert</span>
01014         <a class="code" href="struct_tuple_id.html">TupleId</a> idxTupleId;
01015 
01016         <span class="comment">// Suche nach letzter tableId</span>
01017         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a5">findLastKey</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, idxKey,
01018                 idxTupleId);
01019         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01020             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01021             <span class="keywordflow">goto</span> cleanup;
01022         }
01023         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01024             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung zuruecksetzen</span>
01025             <span class="comment">// wir legen gerade die erste Tabelle des Katalogs an</span>
01026             intValue = 1; <span class="comment">// SYSTABLES_ID</span>
01027         }
01028         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> &lt; DBJ_MAX_TABLE_ID) {
01029             intValue = idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> + 1;
01030         }
01031         <span class="keywordflow">else</span> {
01032             <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
01033             <span class="comment">// Alle moeglichen IDs sind vergeben - suche sequentiell nach</span>
01034             <span class="comment">// Luecken</span>
01035             idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a>;
01036             <span class="keywordflow">do</span> {
01037                 idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a>++;
01038                 rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, idxKey,
01039                         idxTupleId);
01040                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01041                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01042                     <span class="keywordflow">goto</span> cleanup;
01043                 }
01044                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01045                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung zuruecksetzen</span>
01046                     intValue = idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a>;
01047                     found = <span class="keyword">true</span>;
01048                     <span class="keywordflow">break</span>;
01049                 }
01050             } <span class="keywordflow">while</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
01051             <span class="keywordflow">if</span> (!found) {
01052                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a40">DBJ_CAT_TOO_MANY_TABLES</a>);
01053                 <span class="keywordflow">goto</span> cleanup;
01054             }
01055         }
01056 
01057         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(1, &amp;intValue);
01058         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01059             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01060             <span class="keywordflow">goto</span> cleanup;
01061         }
01062 
01063         <span class="comment">// Setze Rueckgabewert</span>
01064         tableId = intValue;
01065         tableDesc.<a class="code" href="class_dbj_table.html#r0">tableId</a> = tableId;
01066     }
01067     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(10, <span class="stringliteral">"Table ID"</span>, tableId);
01068 
01069     <span class="comment">// COLUMN_COUNT</span>
01070     rc = tableDesc.<a class="code" href="class_dbj_table.html#a5">getNumColumns</a>(numColumns);
01071     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01072         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01073         <span class="keywordflow">goto</span> cleanup;
01074     }
01075     intValue = numColumns;
01076     rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(2, &amp;intValue);
01077     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01078         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01079         <span class="keywordflow">goto</span> cleanup;
01080     }
01081 
01082     <span class="comment">// CREATE_TIME</span>
01083     {
01084         <span class="keywordtype">char</span> createTime[27] = { <span class="charliteral">'\0'</span> };
01085         rc = <a class="code" href="class_dbj_catalog_manager.html#d5">getCurrentTimestamp</a>(createTime);
01086         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01087             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01088             <span class="keywordflow">goto</span> cleanup;
01089         }
01090 
01091         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(3, createTime, 26);
01092         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01093             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01094             <span class="keywordflow">goto</span> cleanup;
01095         }
01096     }
01097 
01098     <span class="comment">// TUPLE_COUNT</span>
01099     intValue = 0;
01100     rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(4, &amp;intValue);
01101     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01102         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01103         <span class="keywordflow">goto</span> cleanup;
01104     }
01105 
01106     <span class="comment">// Record in SYSTABLES eintragen</span>
01107     <span class="keywordflow">if</span> (recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>() == NULL) {
01108         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01109         <span class="keywordflow">goto</span> cleanup;
01110     }
01111     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a2">insert</a>(*recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>(), <a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId);
01112     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01113         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01114         <span class="keywordflow">goto</span> cleanup;
01115     }
01116 
01117     <span class="comment">// Indexe auf SYSTABLES.TABLE_ID und SYSTABLES.TABLE_NAME pflegen</span>
01118     {
01119         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01120         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01121         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, idxKey, tupleId);
01122         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01123             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01124             <span class="keywordflow">goto</span> cleanup;
01125         }
01126         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01127         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = const_cast&lt;char *&gt;(tableName);
01128         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s5">IDX_SYSTABLES_TABLENAME_ID</a>, idxKey, tupleId);
01129         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01130         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01131             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01132             <span class="keywordflow">goto</span> cleanup;
01133         }
01134     }
01135 
01136     <span class="comment">// Tupelzaehler fuer SYSTABLES anpassen</span>
01137     rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, 1);
01138     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01139         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01140         <span class="keywordflow">goto</span> cleanup;
01141     }
01142 
01143     <span class="comment">/*</span>
01144 <span class="comment">     * Alle Attribute/Spalten in SYSCOLUMNS hinterlegen</span>
01145 <span class="comment">     */</span>
01146     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, systemTable);
01147     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01148         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01149         <span class="keywordflow">goto</span> cleanup;
01150     }
01151     rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a3">initialize</a>(systemTable);
01152     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01153         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01154         <span class="keywordflow">goto</span> cleanup;
01155     }
01156 
01157     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga9">Uint16</a> i = 0; i &lt; numColumns; i++) {
01158         <span class="keyword">const</span> <span class="keywordtype">char</span> *columnName = NULL;
01159         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> maxLength = 0;
01160         <a class="code" href="group__datatypes.html#ga0">DbjDataType</a> dataType = <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>;
01161         <span class="keywordtype">bool</span> isNullable = <span class="keyword">false</span>;
01162 
01163         <span class="comment">// TABLE_ID</span>
01164         intValue = tableId;
01165         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(0, &amp;intValue);
01166         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01167             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01168             <span class="keywordflow">goto</span> cleanup;
01169         }
01170 
01171         <span class="comment">// COLUMN_NAME</span>
01172         rc = tableDesc.<a class="code" href="class_dbj_table.html#a8">getColumnName</a>(i, columnName);
01173         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01174             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01175             <span class="keywordflow">goto</span> cleanup;
01176         }
01177         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(1, columnName, strlen(columnName));
01178         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01179             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01180             <span class="keywordflow">goto</span> cleanup;
01181         }
01182 
01183         <span class="comment">// COLUMN_ID</span>
01184         intValue = i;
01185         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(2, &amp;intValue);
01186         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01187             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01188             <span class="keywordflow">goto</span> cleanup;
01189         }
01190 
01191         <span class="comment">// DATA_TYPE</span>
01192         rc = tableDesc.<a class="code" href="class_dbj_table.html#a10">getColumnDatatype</a>(i, dataType);
01193         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01194             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01195             <span class="keywordflow">goto</span> cleanup;
01196         }
01197         {
01198             <span class="keywordtype">char</span> *type = NULL;
01199             <span class="keywordtype">char</span> intType[] = <span class="stringliteral">"INTEGER"</span>;
01200             <span class="keywordtype">char</span> vcType[] = <span class="stringliteral">"VARCHAR"</span>;
01201             <span class="keywordflow">switch</span> (dataType) {
01202               <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>: type = intType; <span class="keywordflow">break</span>;
01203               <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>: type = vcType; <span class="keywordflow">break</span>;
01204               <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>:
01205                   <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01206                   <span class="keywordflow">goto</span> cleanup;
01207             }
01208             rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(3, type, strlen(type));
01209             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01210                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01211                 <span class="keywordflow">goto</span> cleanup;
01212             }
01213         }
01214 
01215         <span class="comment">// MAX_LENGTH</span>
01216         rc = tableDesc.<a class="code" href="class_dbj_table.html#a11">getMaxColumnLength</a>(i, maxLength);
01217         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01218             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01219             <span class="keywordflow">goto</span> cleanup;
01220         }
01221         intValue = maxLength;
01222         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(4, &amp;intValue);
01223         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01224             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01225             <span class="keywordflow">goto</span> cleanup;
01226         }
01227 
01228         <span class="comment">// NULLABLE</span>
01229         rc = tableDesc.<a class="code" href="class_dbj_table.html#a12">getIsNullable</a>(i, isNullable);
01230         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01231             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01232             <span class="keywordflow">goto</span> cleanup;
01233         }
01234         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(5, isNullable ? <span class="stringliteral">"Y"</span> : <span class="stringliteral">"N"</span>, 1);
01235         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01236             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01237             <span class="keywordflow">goto</span> cleanup;
01238         }
01239 
01240         <span class="comment">// Record einfuegen</span>
01241         <span class="keywordflow">if</span> (recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>() == NULL) {
01242             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01243             <span class="keywordflow">goto</span> cleanup;
01244         }
01245         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a2">insert</a>(*recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>(), <a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>,
01246                 tupleId);
01247         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01248             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01249             <span class="keywordflow">goto</span> cleanup;
01250         }
01251 
01252         <span class="comment">// Indexe SYSCOLUMNS.TABLE_ID und SYSCOLUMNS.COLUMN_NAME pflegen</span>
01253         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01254         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01255         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>, idxKey, tupleId);
01256         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01257             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01258             <span class="keywordflow">goto</span> cleanup;
01259         }
01260         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01261         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = const_cast&lt;char *&gt;(columnName);
01262         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s7">IDX_SYSCOLUMNS_COLUMNNAME_ID</a>, idxKey, tupleId);
01263         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01264         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01265             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01266             <span class="keywordflow">goto</span> cleanup;
01267         }
01268     }
01269 
01270     <span class="comment">// Tupelzaehler fuer SYSCOLUMNS anpassen</span>
01271     <span class="comment">// (Die Tupelzaehler fuer den Katalog koennen erst aktualisiert werden,</span>
01272     <span class="comment">// sobald alle notwendigen Eintraege in SYSTABLES vorhanden sind.)</span>
01273     <span class="keywordflow">if</span> (tableId &gt; <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a>) {
01274         rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, numColumns);
01275         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01276             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01277             <span class="keywordflow">goto</span> cleanup;
01278         }
01279     }
01280 
01281  cleanup:
01282     <span class="keyword">delete</span> systemTable;
01283     <span class="keyword">delete</span> recordTuple;
01284     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01285 }
01286 
01287 
<a name="l01288"></a><a class="code" href="class_dbj_catalog_manager.html#a6">01288</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a6">DbjCatalogManager::removeTable</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId)
01289 {
01290     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01291     <a class="code" href="class_dbj_table.html">DbjTable</a> *tableDesc = NULL;
01292     <a class="code" href="class_dbj_table.html">DbjTable</a> *sysColumns = NULL;
01293     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> key;
01294     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
01295     <a class="code" href="struct_tuple_id.html">TupleId</a> *columnTid = NULL;
01296     <a class="code" href="class_dbj_index_iterator.html">DbjIndexIterator</a> *iter = NULL;
01297     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> columnCount = 0;
01298     <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
01299     <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> *recTuple = NULL;
01300 
01301     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01302     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
01303 
01304     <span class="comment">// Katalogtabellen duerfen nicht geloescht werden</span>
01305     <span class="keywordflow">if</span> (tableId &lt;= <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a>) {
01306         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a33">DBJ_CAT_MODIFYING_CATALOG_TABLES_NOT_ALLOWED</a>);
01307         <span class="keywordflow">goto</span> cleanup;
01308     }
01309 
01310     {
01311         <a class="code" href="class_dbj_catalog_manager.html">DbjCatalogManager</a> catalogMgr;
01312         rc = catalogMgr.<a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(tableId, tableDesc);
01313         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01314             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01315             <span class="keywordflow">goto</span> cleanup;
01316         }
01317         rc = catalogMgr.<a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, sysColumns);
01318         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01319             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01320             <span class="keywordflow">goto</span> cleanup;
01321         }
01322     }
01323     rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a5">getNumColumns</a>(columnCount);
01324     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01325         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01326         <span class="keywordflow">goto</span> cleanup;
01327     }
01328     columnTid = <span class="keyword">new</span> <a class="code" href="struct_tuple_id.html">TupleId</a>[columnCount];
01329     <span class="keywordflow">if</span> (!columnTid) {
01330         <span class="keywordflow">goto</span> cleanup;
01331     }
01332     recTuple = <span class="keyword">new</span> <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a>(tableDesc);
01333     <span class="keywordflow">if</span> (!recTuple) {
01334         <span class="keywordflow">goto</span> cleanup;
01335     }
01336 
01337     <span class="comment">// loesche alle Spalten der Tabelle aus SYSCOLUMNS</span>
01338     key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01339     key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01340     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a6">findRange</a>(<a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>, &amp;key, &amp;key, iter);
01341     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01342         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01343         <span class="keywordflow">goto</span> cleanup;
01344     }
01345     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga9">Uint16</a> i = 0; i &lt; columnCount; i++) {
01346         <span class="keyword">const</span> <span class="keywordtype">char</span> *columnName = NULL;
01347         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> columnNameLength = 0;
01348         <span class="keywordtype">char</span> column[DBJ_MAX_COLUMN_NAME_LENGTH+1] = { <span class="charliteral">'\0'</span> };
01349 
01350         <span class="keywordflow">if</span> (!iter-&gt;<a class="code" href="class_dbj_index_iterator.html#a1">hasNext</a>()) {
01351             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01352             <span class="keywordflow">goto</span> cleanup;
01353         }
01354         rc = iter-&gt;<a class="code" href="class_dbj_index_iterator.html#a2">getNextTupleId</a>(tupleId);
01355         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01356             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01357             <span class="keywordflow">goto</span> cleanup;
01358         }
01359 
01360         <span class="comment">// pflege Index SYSCOLUMNS.COLUMN_NAME</span>
01361         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, tupleId, record);
01362         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01363             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01364             <span class="keywordflow">goto</span> cleanup;
01365         }
01366         rc = recTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a3">initialize</a>(record, sysColumns);
01367         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01368             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01369             <span class="keywordflow">goto</span> cleanup;
01370         }
01371         rc = recTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a5">getVarchar</a>(1, columnName, columnNameLength);
01372         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01373             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01374             <span class="keywordflow">goto</span> cleanup;
01375         }
01376         <span class="keywordflow">if</span> (!columnName) {
01377             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01378             <span class="keywordflow">goto</span> cleanup;
01379         }
01380         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(column, columnName, columnNameLength);
01381         column[columnNameLength] = <span class="charliteral">'\0'</span>;
01382 
01383         <span class="comment">// loesche Indexeintrag</span>
01384         key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01385         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = column;
01386         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s7">IDX_SYSCOLUMNS_COLUMNNAME_ID</a>, key, &amp;tupleId);
01387         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01388         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01389             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01390             <span class="keywordflow">goto</span> cleanup;
01391         }
01392 
01393         <span class="comment">// loesche Record der Tabelle</span>
01394         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a3">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, tupleId);
01395         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01396             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01397             <span class="keywordflow">goto</span> cleanup;
01398         }
01399 
01400         <span class="comment">// merke Tuple-ID um SYSCOLUMNS.TABLE_ID anschliessend noch</span>
01401         <span class="comment">// aufzuraeumen</span>
01402         columnTid[i] = tupleId;
01403     }
01404     <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="class_dbj_index_iterator.html#a1">hasNext</a>()) {
01405         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01406         <span class="keywordflow">goto</span> cleanup;
01407     }
01408     <span class="keyword">delete</span> iter;
01409     iter = NULL;
01410 
01411     <span class="comment">// pflege Index auf SYSCOLUMNS.TABLE_ID</span>
01412     key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01413     key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01414     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga9">Uint16</a> i = 0; i &lt; columnCount; i++) {
01415         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>, key, &amp;columnTid[i]);
01416         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01417             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01418             <span class="keywordflow">goto</span> cleanup;
01419         }
01420     }
01421 
01422     rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, -columnCount);
01423     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01424         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01425         <span class="keywordflow">goto</span> cleanup;
01426     }
01427 
01428     <span class="comment">// nun entfernt Tabelle aus SYSTABLES</span>
01429     key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01430     key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01431     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, key, tupleId);
01432     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01433         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01434         <span class="keywordflow">goto</span> cleanup;
01435     }
01436 
01437     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a3">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId);
01438     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01439         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01440         <span class="keywordflow">goto</span> cleanup;
01441     }
01442 
01443     <span class="comment">// pflege Indexe auf SYSTABLES.TABLEID und SYSTABLES.TABLE_NAME</span>
01444     key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01445     key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01446     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, key, NULL);
01447     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01448         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01449         <span class="keywordflow">goto</span> cleanup;
01450     }
01451     {
01452         <span class="keyword">const</span> <span class="keywordtype">char</span> *tableName = NULL;
01453         rc = tableDesc-&gt;<a class="code" href="class_dbj_table.html#a3">getTableName</a>(tableName);
01454         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01455             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01456             <span class="keywordflow">goto</span> cleanup;
01457         }
01458         key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01459         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = const_cast&lt;char *&gt;(tableName);
01460         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s5">IDX_SYSTABLES_TABLENAME_ID</a>, key, NULL);
01461         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01462         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01463             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01464             <span class="keywordflow">goto</span> cleanup;
01465         }
01466     }
01467 
01468     rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, -1);
01469     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01470         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01471         <span class="keywordflow">goto</span> cleanup;
01472     }
01473 
01474  cleanup:
01475     <span class="keyword">delete</span> tableDesc;
01476     <span class="keyword">delete</span> sysColumns;
01477     <span class="keyword">delete</span> columnTid;
01478     <span class="keyword">delete</span> recTuple;
01479     <span class="keyword">delete</span> iter;
01480     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01481 }
01482 
01483 
<a name="l01484"></a><a class="code" href="class_dbj_catalog_manager.html#d4">01484</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a7">DbjCatalogManager::addIndex</a>(<a class="code" href="class_dbj_index.html">DbjIndex</a> &amp;indexDesc,
01485         <span class="keyword">const</span> <span class="keywordtype">bool</span> protectCatalog, <a class="code" href="group__tableid.html#ga5">IndexId</a> &amp;indexId)
01486 {
01487     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01488     <a class="code" href="class_dbj_table.html">DbjTable</a> *systemTable = NULL;
01489     <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> *recordTuple = NULL;
01490     <a class="code" href="group__tableid.html#ga1">TableId</a> tableId = DBJ_UNKNOWN_TABLE_ID;
01491     <span class="keyword">const</span> <span class="keywordtype">char</span> *indexName = NULL;
01492     <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> intValue = 0;
01493     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
01494 
01495     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01496 
01497     <span class="keywordflow">if</span> (protectCatalog) {
01498         <span class="keywordflow">if</span> (indexDesc.<a class="code" href="class_dbj_index.html#r3">tableId</a> &lt;= <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a> &amp;&amp;
01499                 indexDesc.<a class="code" href="class_dbj_index.html#r3">tableId</a> != DBJ_UNKNOWN_TABLE_ID) {
01500             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a33">DBJ_CAT_MODIFYING_CATALOG_TABLES_NOT_ALLOWED</a>);
01501             <span class="keywordflow">goto</span> cleanup;
01502         }
01503     }
01504 
01505     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, systemTable);
01506     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01507         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01508         <span class="keywordflow">goto</span> cleanup;
01509     }
01510     recordTuple = <span class="keyword">new</span> <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a>(systemTable);
01511     <span class="keywordflow">if</span> (!recordTuple || <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01512         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01513         <span class="keywordflow">goto</span> cleanup;
01514     }
01515 
01516     <span class="comment">// TABLE_ID</span>
01517     rc = indexDesc.<a class="code" href="class_dbj_index.html#a4">getTableId</a>(tableId);
01518     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01519         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01520         <span class="keywordflow">goto</span> cleanup;
01521     }
01522     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(10, <span class="stringliteral">"Table ID fuer Index"</span>, tableId);
01523     intValue = tableId;
01524     rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(0, &amp;intValue);
01525     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01526         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01527         <span class="keywordflow">goto</span> cleanup;
01528     }
01529 
01530     <span class="comment">// INDEX_NAME</span>
01531     rc = indexDesc.<a class="code" href="class_dbj_index.html#a2">getIndexName</a>(indexName);
01532     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01533         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01534         <span class="keywordflow">goto</span> cleanup;
01535     }
01536     rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(1, indexName, strlen(indexName));
01537     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01538         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01539         <span class="keywordflow">goto</span> cleanup;
01540     }
01541 
01542     <span class="comment">// INDEX_ID</span>
01543     {
01544         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> idxKey;
01545         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01546         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = 0; <span class="comment">// wird ignoriert</span>
01547         <a class="code" href="struct_tuple_id.html">TupleId</a> idxTupleId;
01548 
01549         <span class="comment">// Suche nach letzter Index-ID</span>
01550         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a5">findLastKey</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, idxKey,
01551                 idxTupleId);
01552         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01553             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01554             <span class="keywordflow">goto</span> cleanup;
01555         }
01556         <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01557             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung zuruecksetzen</span>
01558             <span class="comment">// wir legen gerade den ersten Index ueberhaupt an</span>
01559             intValue = 1; <span class="comment">// IDX_SYSTABLES_TABLEID_ID</span>
01560         }
01561         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> &lt; DBJ_MAX_INDEX_ID) {
01562             intValue = idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> + 1;
01563         }
01564         <span class="keywordflow">else</span> {
01565             <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
01566             <span class="comment">// Alle moeglichen IDs sind vergeben - suche sequentiell nach</span>
01567             <span class="comment">// Luecken</span>
01568             idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a>;
01569             <span class="keywordflow">do</span> {
01570                 idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a>++;
01571                 rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, idxKey,
01572                         idxTupleId);
01573                 <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01574                     <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01575                     <span class="keywordflow">goto</span> cleanup;
01576                 }
01577                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>) {
01578                     <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung zuruecksetzen</span>
01579                     intValue = idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a>;
01580                     found = <span class="keyword">true</span>;
01581                     <span class="keywordflow">break</span>;
01582                 }
01583             } <span class="keywordflow">while</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
01584             <span class="keywordflow">if</span> (!found) {
01585                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a41">DBJ_CAT_TOO_MANY_INDEXES</a>);
01586                 <span class="keywordflow">goto</span> cleanup;
01587             }
01588         }
01589 
01590         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(2, &amp;intValue);
01591         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01592             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01593             <span class="keywordflow">goto</span> cleanup;
01594         }
01595 
01596         <span class="comment">// Setze Rueckgabewert</span>
01597         indexId = intValue;
01598         indexDesc.<a class="code" href="class_dbj_index.html#r0">indexId</a> = indexId;
01599     }
01600     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(20, <span class="stringliteral">"Index ID"</span>, indexId);
01601 
01602     <span class="comment">// INDEX_TYPE</span>
01603     {
01604         <a class="code" href="group__datatypes.html#ga1">DbjIndexType</a> type = <a class="code" href="group__datatypes.html#gga1a37">UnknownIndexType</a>;
01605         rc = indexDesc.<a class="code" href="class_dbj_index.html#a3">getIndexType</a>(type);
01606         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01607             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01608             <span class="keywordflow">goto</span> cleanup;
01609         }
01610         <span class="keywordflow">switch</span> (type) {
01611           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga1a36">Hash</a>:
01612               rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(3, <span class="stringliteral">"HASH"</span>, 4);
01613               <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01614                   <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01615                   <span class="keywordflow">goto</span> cleanup;
01616               }
01617               <span class="keywordflow">break</span>;
01618 
01619           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga1a35">BTree</a>:
01620               rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(3, <span class="stringliteral">"BTREE"</span>, 5);
01621               <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01622                   <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01623                   <span class="keywordflow">goto</span> cleanup;
01624               }
01625               <span class="keywordflow">break</span>;
01626 
01627           <span class="keywordflow">case</span> <a class="code" href="group__datatypes.html#gga1a37">UnknownIndexType</a>:
01628               <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01629               <span class="keywordflow">goto</span> cleanup;
01630         }
01631     }
01632 
01633     <span class="comment">// COLUMN_ID</span>
01634     {
01635         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> columnId = 0;
01636         rc = indexDesc.<a class="code" href="class_dbj_index.html#a5">getColumnNumber</a>(columnId);
01637         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01638             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01639             <span class="keywordflow">goto</span> cleanup;
01640         }
01641         intValue = columnId;
01642         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(4, &amp;intValue);
01643         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01644             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01645             <span class="keywordflow">goto</span> cleanup;
01646         }
01647     }
01648 
01649     <span class="comment">// IS_UNIQUE</span>
01650     {
01651         <span class="keywordtype">bool</span> unique = <span class="keyword">false</span>;
01652         rc = indexDesc.<a class="code" href="class_dbj_index.html#a6">getUnique</a>(unique);
01653         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01654             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01655             <span class="keywordflow">goto</span> cleanup;
01656         }
01657         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(5, unique ? <span class="stringliteral">"Y"</span> : <span class="stringliteral">"N"</span>, 1);
01658         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01659             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01660             <span class="keywordflow">goto</span> cleanup;
01661         }
01662     }
01663 
01664     <span class="comment">// CREATE_TIME</span>
01665     {
01666         <span class="keywordtype">char</span> createTime[27] = { <span class="charliteral">'\0'</span> };
01667         rc = <a class="code" href="class_dbj_catalog_manager.html#d5">getCurrentTimestamp</a>(createTime);
01668         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01669             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01670             <span class="keywordflow">goto</span> cleanup;
01671         }
01672         rc = recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a12">setVarchar</a>(6, createTime, 26);
01673         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01674             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01675             <span class="keywordflow">goto</span> cleanup;
01676         }
01677     }
01678 
01679     <span class="comment">// Record in SYSINDEXES eintragen</span>
01680     <span class="keywordflow">if</span> (recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>() == NULL) {
01681         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01682         <span class="keywordflow">goto</span> cleanup;
01683     }
01684     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a2">insert</a>(*recordTuple-&gt;<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>(), <a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, tupleId);
01685     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01686         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01687         <span class="keywordflow">goto</span> cleanup;
01688     }
01689 
01690     <span class="comment">// Indexe auf SYSINDEXES.TABLE_ID, SYSINDEXES.INDEX_NAME und</span>
01691     <span class="comment">// SYSINDEXES.INDEX_ID pflegen</span>
01692     {
01693         <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> idxKey;
01694         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01695         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01696         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s8">IDX_SYSINDEXES_TABLEID_ID</a>, idxKey, tupleId);
01697         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01698             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01699             <span class="keywordflow">goto</span> cleanup;
01700         }
01701         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01702         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = const_cast&lt;char *&gt;(indexName);
01703         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s9">IDX_SYSINDEXES_INDEXNAME_ID</a>, idxKey, tupleId);
01704         idxKey.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01705         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01706             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01707             <span class="keywordflow">goto</span> cleanup;
01708         }
01709         idxKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01710         idxKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = indexId;
01711         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a7">insert</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, idxKey, tupleId);
01712         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01713             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01714             <span class="keywordflow">goto</span> cleanup;
01715         }
01716     }
01717 
01718     <span class="comment">// Tupelzaehler fuer SYSINDEXES anpassen</span>
01719     <span class="comment">// (Die Tupelzaehler fuer den Katalog koennen erst aktualisiert werden,</span>
01720     <span class="comment">// sobald alle notwendigen Eintraege in SYSTABLES vorhanden sind.)</span>
01721     <span class="keywordflow">if</span> (indexId &gt; <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a>) {
01722         rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, 1);
01723         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01724             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01725             <span class="keywordflow">goto</span> cleanup;
01726         }
01727     }
01728 
01729  cleanup:
01730     <span class="keyword">delete</span> systemTable;
01731     <span class="keyword">delete</span> recordTuple;
01732     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();   
01733 }
01734 
01735 
<a name="l01736"></a><a class="code" href="class_dbj_catalog_manager.html#a8">01736</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a8">DbjCatalogManager::removeIndex</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> indexId)
01737 {
01738     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01739     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> key;
01740     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
01741     <a class="code" href="class_dbj_index.html">DbjIndex</a> *indexDesc = NULL;
01742 
01743     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01744     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Index ID"</span>, indexId);
01745 
01746     <span class="comment">// Indexe auf dem Katalog duerfen nicht geloescht werden</span>
01747     <span class="keywordflow">if</span> (indexId &lt;= <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a>) {
01748         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a33">DBJ_CAT_MODIFYING_CATALOG_TABLES_NOT_ALLOWED</a>);
01749         <span class="keywordflow">goto</span> cleanup;
01750     }
01751 
01752     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(indexId, indexDesc);
01753     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01754         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01755         <span class="keywordflow">goto</span> cleanup;
01756     }    
01757 
01758     <span class="comment">// finde Tupel-ID des Index im Katalog (SYSINDEXES) via Index-Scan</span>
01759     key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01760     key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = indexId;
01761     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, key, tupleId);
01762     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01763         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01764         <span class="keywordflow">goto</span> cleanup;
01765     }
01766 
01767     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a3">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, tupleId);
01768     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01769         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01770         <span class="keywordflow">goto</span> cleanup;
01771     }
01772 
01773     <span class="comment">// pflege Indexe auf SYSINDEXES.TABLE_ID, SYSINDEXES.INDEX_NAME und</span>
01774     <span class="comment">// SYSINDEXES.INDEX_ID</span>
01775     {
01776         <a class="code" href="group__tableid.html#ga1">TableId</a> tableId = DBJ_UNKNOWN_TABLE_ID;
01777         rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a4">getTableId</a>(tableId);
01778         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01779             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01780             <span class="keywordflow">goto</span> cleanup;
01781         }
01782 
01783         key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01784         key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01785         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s8">IDX_SYSINDEXES_TABLEID_ID</a>, key, &amp;tupleId);
01786         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01787             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01788             <span class="keywordflow">goto</span> cleanup;
01789         }
01790     }
01791     {
01792         <span class="keyword">const</span> <span class="keywordtype">char</span> *indexName = NULL;
01793         rc = indexDesc-&gt;<a class="code" href="class_dbj_index.html#a2">getIndexName</a>(indexName);
01794         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01795             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01796             <span class="keywordflow">goto</span> cleanup;
01797         }
01798 
01799         key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>;
01800         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = const_cast&lt;char *&gt;(indexName);
01801         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s9">IDX_SYSINDEXES_INDEXNAME_ID</a>, key, &amp;tupleId);
01802         key.<a class="code" href="class_dbj_index_key.html#o2">varcharKey</a> = NULL;
01803         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01804             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01805             <span class="keywordflow">goto</span> cleanup;
01806         }
01807     }
01808     key.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01809     key.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = indexId;
01810     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a8">remove</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, key, &amp;tupleId);
01811     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01812         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01813         <span class="keywordflow">goto</span> cleanup;
01814     }
01815 
01816     rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, -1);
01817     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01818         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01819         <span class="keywordflow">goto</span> cleanup;
01820     }
01821 
01822  cleanup:
01823     <span class="keyword">delete</span> indexDesc;
01824     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01825 }
01826 
01827 
01828 <span class="comment">// Record mit entsprechender TableId aus Katalog holen und bzgl. tupleCount</span>
01829 <span class="comment">// aktualisieren</span>
<a name="l01830"></a><a class="code" href="class_dbj_catalog_manager.html#a9">01830</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a9">DbjCatalogManager::updateTupleCount</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
01831         <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> diff)
01832 {
01833     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01834     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> indexKey;
01835     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
01836     <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
01837     <a class="code" href="class_dbj_table.html">DbjTable</a> *sysTables = NULL;
01838 
01839     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01840     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
01841     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Differenz"</span>, diff);
01842 
01843     indexKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01844     indexKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01845 
01846     <span class="keywordflow">if</span> (diff == 0) {
01847         <span class="keywordflow">goto</span> cleanup;
01848     }
01849       
01850     <span class="comment">// Suche Tupel-ID des Records ueber den Index Manager</span>
01851     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, indexKey, tupleId);
01852     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01853         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01854         <span class="keywordflow">goto</span> cleanup;
01855     }
01856 
01857     <span class="comment">// Hole Record aus der Datenbank</span>
01858     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, sysTables);
01859     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01860         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01861         <span class="keywordflow">goto</span> cleanup;
01862     }
01863     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId, record);
01864     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01865         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01866         <span class="keywordflow">goto</span> cleanup;
01867     }
01868 
01869     <span class="comment">// Setze neuen Tupel-Zaehler in Attribut 4 des Records</span>
01870     {
01871         <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *tupleCount = 0;
01872         <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> recTuple(record, sysTables);
01873         <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01874             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01875             <span class="keywordflow">goto</span> cleanup;
01876         }
01877         record = NULL;
01878 
01879         rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(4, tupleCount);
01880         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01881             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01882             <span class="keywordflow">goto</span> cleanup;
01883         }
01884         <span class="keywordflow">if</span> (tupleCount == NULL || *tupleCount &lt; 0) {
01885             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
01886             <span class="keywordflow">goto</span> cleanup;
01887         }
01888 
01889         <span class="comment">// Ueber- und Unterlaeufe abfangen</span>
01890         <span class="keywordflow">if</span> (diff &lt; 0 &amp;&amp; *tupleCount + diff &lt; 0) {
01891             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01892             <span class="keywordflow">goto</span> cleanup;
01893         }
01894         <span class="keywordflow">if</span> (diff &gt; 0 &amp;&amp; *tupleCount &gt; DBJ_MAX_SINT32 - diff) {
01895             *const_cast&lt;Sint32 *&gt;(tupleCount) = DBJ_MAX_SINT32;
01896         }
01897         <span class="keywordflow">else</span> {
01898             *const_cast&lt;Sint32 *&gt;(tupleCount) += diff;
01899         }
01900         <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(10, <span class="stringliteral">"Table-ID"</span>, tableId);
01901         <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(10, <span class="stringliteral">"Tupelzaehler"</span>, *tupleCount);
01902 
01903         rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a13">setInt</a>(4, tupleCount);
01904         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01905             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01906             <span class="keywordflow">goto</span> cleanup;
01907         }
01908 
01909         <span class="comment">// alten Record ersetzten</span>
01910         <span class="keywordflow">if</span> (recTuple.<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>() == NULL || <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01911             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01912             <span class="keywordflow">goto</span> cleanup;
01913         }
01914         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a4">replace</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId, *recTuple.<a class="code" href="class_dbj_record_tuple.html#a11">getRecord</a>());
01915         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01916             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01917             <span class="keywordflow">goto</span> cleanup;
01918         }
01919     }
01920 
01921  cleanup:
01922     <span class="keyword">delete</span> sysTables;
01923     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01924 }
01925 
01926 
01927 <span class="comment">// Gib Tupel-Anzahl einer Tabelle</span>
<a name="l01928"></a><a class="code" href="class_dbj_catalog_manager.html#a10">01928</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#a10">DbjCatalogManager::getTupleCount</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
01929         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> &amp;tupleCount)
01930 {
01931     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01932     <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId;
01933     <a class="code" href="class_dbj_index_key.html">DbjIndexKey</a> indexKey;
01934     <a class="code" href="class_dbj_record.html">DbjRecord</a> *record = NULL;
01935     <a class="code" href="class_dbj_table.html">DbjTable</a> *sysTable = NULL;
01936 
01937     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01938     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
01939 
01940     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, sysTable);
01941     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01942         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01943         <span class="keywordflow">goto</span> cleanup;
01944     }
01945 
01946     <span class="comment">// Finde Tupel ueber Index-Scan</span>
01947     indexKey.<a class="code" href="class_dbj_index_key.html#o0">dataType</a> = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>;
01948     indexKey.<a class="code" href="class_dbj_index_key.html#o1">intKey</a> = tableId;
01949     rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a3">find</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, indexKey, tupleId);
01950     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01951         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01952         <span class="keywordflow">goto</span> cleanup;
01953     }
01954     rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a5">get</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, tupleId, record);
01955     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01956         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01957         <span class="keywordflow">goto</span> cleanup;
01958     }
01959     {
01960         <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga12">Sint32</a> *count = NULL;
01961         <a class="code" href="class_dbj_record_tuple.html">DbjRecordTuple</a> recTuple(record, sysTable);
01962         <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01963             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01964             <span class="keywordflow">goto</span> cleanup;
01965         }
01966         record = NULL;
01967 
01968         <span class="comment">// das 5. Attribut enthaelt den Zaehler</span>
01969         rc = recTuple.<a class="code" href="class_dbj_record_tuple.html#a6">getInt</a>(4, count);
01970         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01971             <span class="keywordflow">goto</span> cleanup;
01972         }
01973         <span class="keywordflow">if</span> (!count || count &lt; 0) {
01974             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a42">DBJ_CAT_INCONSISTENT_CATALOG</a>);
01975             <span class="keywordflow">goto</span> cleanup;
01976         }
01977         tupleCount = *count;
01978     }
01979   
01980  cleanup:
01981     <span class="keyword">delete</span> sysTable;
01982     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01983 }
01984 
01985 
01986 <span class="comment">// Initialisiere Katalog beim Systemstart</span>
<a name="l01987"></a><a class="code" href="class_dbj_catalog_manager.html#h0">01987</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#h0">DbjCatalogManager::initializeCatalog</a>()
01988 {
01989     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01990 
01991     <a class="code" href="class_dbj_catalog_manager.html">DbjCatalogManager</a> catalogMgr(<span class="keyword">false</span>);
01992     <span class="keywordflow">return</span> catalogMgr.<a class="code" href="class_dbj_catalog_manager.html#d2">setupCatalog</a>();
01993 }
01994 
01995 
01996 <span class="comment">// Pruefe, ob die Katalogtabellen bereits existieren.  Wenn nicht, dann werden</span>
01997 <span class="comment">// sie und die zugehoerigen Indexe neu angelegt.</span>
<a name="l01998"></a><a class="code" href="class_dbj_catalog_manager.html#d2">01998</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#d2">DbjCatalogManager::setupCatalog</a>()
01999 {
02000     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
02001     <span class="keywordtype">bool</span> createCat = <span class="keyword">false</span>;
02002     <a class="code" href="class_dbj_table.html">DbjTable</a> *systemTable = NULL;
02003     <a class="code" href="class_dbj_index.html">DbjIndex</a> *systemIndex = NULL;
02004     <a class="code" href="group__tableid.html#ga1">TableId</a> tableId = DBJ_UNKNOWN_TABLE_ID;
02005     <a class="code" href="group__tableid.html#ga5">IndexId</a> indexId = DBJ_UNKNOWN_INDEX_ID;
02006 
02007     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
02008 
02009     <span class="comment">// Katalogtabellen</span>
02010     <span class="keywordflow">for</span> (<a class="code" href="group__tableid.html#ga1">TableId</a> i = 1; i &lt;= <a class="code" href="class_dbj_catalog_manager.html#s3">MAX_CATALOG_TABLEID</a>; i++) {
02011         rc = <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a0">createTable</a>(i);
02012         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a58">DBJ_RM_TABLE_ALREADY_EXISTS</a>) {
02013             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02014             <span class="keywordflow">goto</span> cleanup;
02015         }
02016         <span class="keywordflow">if</span> (i == 1 &amp;&amp; rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02017             createCat = <span class="keyword">true</span>; <span class="comment">// Katalog wird neu angelegt</span>
02018         }
02019 
02020         <span class="comment">// Tabelle konnte angelegt werden, durfte aber nicht bzw.</span>
02021         <span class="comment">// Tabelle musste angelegt werden, konnte aber nicht</span>
02022         <span class="keywordflow">if</span> ((rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; !createCat) ||
02023                 (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a58">DBJ_RM_TABLE_ALREADY_EXISTS</a> &amp;&amp; createCat)) {
02024             <span class="keyword">const</span> <span class="keywordtype">char</span> *dbPath = getenv(<span class="stringliteral">"DBJ_DATABASE_PATH"</span>);
02025             <span class="keywordflow">if</span> (dbPath == NULL) {
02026                 dbPath = DBJ_DEFAULT_DATABASE_PATH;
02027             }
02028             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a35">DBJ_CAT_INCOMPLETE_CATALOG_FOUND</a>, dbPath);
02029             <span class="keywordflow">goto</span> cleanup;
02030         }
02031 
02032         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02033             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Fehler zuruecksetzen</span>
02034         }
02035     }
02036 
02037     <span class="comment">// Alle Indexe auf den Katalogtabellen</span>
02038     <span class="comment">// die Definition hier muss mit der in "getIndexDescriptor"</span>
02039     <span class="comment">// uebereinstimmen!</span>
02040     <span class="keywordflow">for</span> (<a class="code" href="group__tableid.html#ga5">IndexId</a> i = 1; i &lt;= <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a>; i++) {
02041         <a class="code" href="group__datatypes.html#ga0">DbjDataType</a> dataType = <a class="code" href="group__datatypes.html#gga0a34">UnknownDataType</a>;
02042         <span class="keywordtype">bool</span> unique = <span class="keyword">false</span>;
02043         <span class="keywordflow">switch</span> (i) {
02044           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>:
02045               dataType = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>; unique = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
02046           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s5">IDX_SYSTABLES_TABLENAME_ID</a>:
02047               dataType = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>; unique = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
02048           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>:
02049               dataType = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>; unique = <span class="keyword">false</span>; <span class="keywordflow">break</span>;
02050           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s7">IDX_SYSCOLUMNS_COLUMNNAME_ID</a>:
02051               dataType = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>; unique = <span class="keyword">false</span>; <span class="keywordflow">break</span>;
02052           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s8">IDX_SYSINDEXES_TABLEID_ID</a>:
02053               dataType = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>; unique = <span class="keyword">false</span>; <span class="keywordflow">break</span>;
02054           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s9">IDX_SYSINDEXES_INDEXNAME_ID</a>:
02055               dataType = <a class="code" href="group__datatypes.html#gga0a32">VARCHAR</a>; unique = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
02056           <span class="keywordflow">case</span> <a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>:
02057               dataType = <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>; unique = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
02058           <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
02059         }
02060         rc = <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a0">createIndex</a>(i, unique, <a class="code" href="group__datatypes.html#gga1a35">BTree</a>, dataType);
02061         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a61">DBJ_IM_INDEX_ALREADY_EXISTS</a>) {
02062             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02063             <span class="keywordflow">goto</span> cleanup;
02064         }
02065 
02066 
02067         <span class="comment">// Index konnte angelegt werden, durfte aber nicht bzw.</span>
02068         <span class="comment">// Index musste angelegt werden, konnte aber nicht</span>
02069         <span class="keywordflow">if</span> ((rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; !createCat) ||
02070                 (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a61">DBJ_IM_INDEX_ALREADY_EXISTS</a> &amp;&amp; createCat)) {
02071             <span class="keyword">const</span> <span class="keywordtype">char</span> *dbPath = getenv(<span class="stringliteral">"DBJ_DATABASE_PATH"</span>);
02072             <span class="keywordflow">if</span> (dbPath == NULL) {
02073                 dbPath = DBJ_DEFAULT_DATABASE_PATH;
02074             }
02075             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a35">DBJ_CAT_INCOMPLETE_CATALOG_FOUND</a>, dbPath);
02076             <span class="keywordflow">goto</span> cleanup;
02077         }
02078 
02079         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02080             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Fehler zuruecksetzen</span>
02081         }
02082     }
02083 
02084     <span class="keywordflow">if</span> (!createCat) {
02085         <span class="keywordflow">goto</span> cleanup;
02086     }
02087 
02088     <span class="comment">/*</span>
02089 <span class="comment">     * SYSTABLES und Indexe auf TABLE_ID bzw. TABLE_NAME</span>
02090 <span class="comment">     */</span>
02091     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s0">SYSTABLES_ID</a>, systemTable);
02092     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02093         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02094         <span class="keywordflow">goto</span> cleanup;
02095     }
02096     rc = <a class="code" href="class_dbj_catalog_manager.html#a5">addTable</a>(*systemTable, <span class="keyword">false</span>, tableId);
02097     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02098         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02099         <span class="keywordflow">goto</span> cleanup;
02100     }
02101     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s4">IDX_SYSTABLES_TABLEID_ID</a>, systemIndex);
02102     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02103         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02104         <span class="keywordflow">goto</span> cleanup;
02105     }                                          
02106     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02107     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02108         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02109         <span class="keywordflow">goto</span> cleanup;
02110     }
02111     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s5">IDX_SYSTABLES_TABLENAME_ID</a>, systemIndex);
02112     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02113         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02114         <span class="keywordflow">goto</span> cleanup;
02115     }
02116     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02117     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02118         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02119         <span class="keywordflow">goto</span> cleanup;
02120     }
02121   
02122     <span class="comment">/*</span>
02123 <span class="comment">     * SYSCOLUMNS und Indexe auf TABLE_ID und COLUMN_NAME</span>
02124 <span class="comment">     */</span>
02125     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>, systemTable);
02126     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02127         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02128         <span class="keywordflow">goto</span> cleanup;
02129     }
02130     rc = <a class="code" href="class_dbj_catalog_manager.html#a5">addTable</a>(*systemTable, <span class="keyword">false</span>, tableId);
02131     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02132         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02133         <span class="keywordflow">goto</span> cleanup;
02134     }
02135     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s6">IDX_SYSCOLUMNS_TABLEID_ID</a>, systemIndex);
02136     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02137         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02138         <span class="keywordflow">goto</span> cleanup;
02139     }
02140     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02141     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02142         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02143         <span class="keywordflow">goto</span> cleanup;
02144     }
02145     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s7">IDX_SYSCOLUMNS_COLUMNNAME_ID</a>, systemIndex);
02146     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02147         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02148         <span class="keywordflow">goto</span> cleanup;
02149     }
02150     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02151     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02152         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02153         <span class="keywordflow">goto</span> cleanup;
02154     }
02155 
02156     <span class="comment">/*</span>
02157 <span class="comment">     * SYSINDEXES und Index auf TABLE_ID, INDEX_NAME und INDEX_ID</span>
02158 <span class="comment">     */</span>
02159     rc = <a class="code" href="class_dbj_catalog_manager.html#a2">getTableDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>, systemTable);
02160     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02161         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02162         <span class="keywordflow">goto</span> cleanup;
02163     }
02164     rc = <a class="code" href="class_dbj_catalog_manager.html#a5">addTable</a>(*systemTable, <span class="keyword">false</span>, tableId);
02165     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02166         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02167         <span class="keywordflow">goto</span> cleanup;
02168     }
02169     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s8">IDX_SYSINDEXES_TABLEID_ID</a>, systemIndex);
02170     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02171         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02172         <span class="keywordflow">goto</span> cleanup;
02173     }
02174     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02175     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02176         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02177         <span class="keywordflow">goto</span> cleanup;
02178     }
02179     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s9">IDX_SYSINDEXES_INDEXNAME_ID</a>, systemIndex);
02180     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02181         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02182         <span class="keywordflow">goto</span> cleanup;
02183     }
02184     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02185     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02186         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02187         <span class="keywordflow">goto</span> cleanup;
02188     }
02189     rc = <a class="code" href="class_dbj_catalog_manager.html#a4">getIndexDescriptor</a>(<a class="code" href="class_dbj_catalog_manager.html#s10">IDX_SYSINDEXES_INDEXID_ID</a>, systemIndex);
02190     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02191         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02192         <span class="keywordflow">goto</span> cleanup;
02193     }
02194     rc = <a class="code" href="class_dbj_catalog_manager.html#a7">addIndex</a>(*systemIndex, <span class="keyword">false</span>, indexId);
02195     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02196         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02197         <span class="keywordflow">goto</span> cleanup;
02198     }
02199 
02200     <span class="comment">// Erst jetzt koennen wir die Tupelzaehler fuer SYSCOLUMNS und SYSINDEXES</span>
02201     <span class="comment">// aktualisieren</span>
02202     rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s1">SYSCOLUMNS_ID</a>,
02203             5 <span class="comment">/* SYSTABLES */</span> +
02204             6 <span class="comment">/* SYSCOLUMNS */</span> +
02205             7 <span class="comment">/* SYSINDEXES */</span>);
02206     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02207         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02208         <span class="keywordflow">goto</span> cleanup;
02209     }
02210     rc = <a class="code" href="class_dbj_catalog_manager.html#a9">updateTupleCount</a>(<a class="code" href="class_dbj_catalog_manager.html#s2">SYSINDEXES_ID</a>,
02211             2 <span class="comment">/* SYSTABLES */</span> +
02212             2 <span class="comment">/* SYSCOLUMNS */</span> +
02213             3 <span class="comment">/* SYSINDEXES */</span>);
02214     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02215         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
02216         <span class="keywordflow">goto</span> cleanup;
02217     }
02218 
02219  cleanup:
02220     <span class="keywordflow">if</span> (<a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() == <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
02221         <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a7">commit</a>();
02222         <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a9">commit</a>();
02223     }
02224     <span class="keywordflow">else</span> {
02225         <a class="code" href="class_dbj_catalog_manager.html#r1">recordMgr</a>-&gt;<a class="code" href="class_dbj_record_manager.html#a8">rollback</a>();
02226         <a class="code" href="class_dbj_catalog_manager.html#r0">indexMgr</a>-&gt;<a class="code" href="class_dbj_index_manager.html#a10">rollback</a>();
02227     }
02228 
02229     <span class="keyword">delete</span> systemTable;
02230     <span class="keyword">delete</span> systemIndex;
02231     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
02232 }
02233 
02234 
02235 <span class="comment">// Gib aktuellen Zeitstempel</span>
<a name="l02236"></a><a class="code" href="class_dbj_catalog_manager.html#d5">02236</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#d5">DbjCatalogManager::getCurrentTimestamp</a>(<span class="keywordtype">char</span> *buffer)<span class="keyword"> const</span>
02237 <span class="keyword"></span>{
02238     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
02239 
02240     <span class="keyword">struct </span>tm timeVal;
02241     <span class="keyword">struct </span><a class="code" href="classtimeval.html">timeval</a> microSeconds;
02242 
02243     <span class="keywordflow">if</span> (!buffer) {
02244         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
02245         <span class="keywordflow">goto</span> cleanup;
02246     }
02247 
02248     <span class="keywordflow">if</span> (gettimeofday(&amp;microSeconds, NULL) != 0) {
02249         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
02250         <span class="keywordflow">goto</span> cleanup;
02251     }   
02252     <span class="keywordflow">if</span> (localtime_r(&amp;microSeconds.tv_sec, &amp;timeVal) == NULL) {
02253         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
02254         <span class="keywordflow">goto</span> cleanup;
02255     }
02256 
02257     sprintf(buffer, <span class="stringliteral">"%4d-%02d-%02d %02d:%02d:%02d.%06ld"</span>,
02258             timeVal.tm_year + 1900, timeVal.tm_mon + 1, timeVal.tm_mday,
02259             timeVal.tm_hour, timeVal.tm_min, timeVal.tm_sec,
02260             microSeconds.tv_usec);
02261     <a class="code" href="group__trace__def.html#ga3">DBJ_TRACE_DATA1</a>(10, strlen(buffer), buffer);
02262 
02263  cleanup:
02264     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
02265 }
02266 
02267 
02268 <span class="comment">// Ermittle Parameter eines System-Indexes</span>
<a name="l02269"></a><a class="code" href="class_dbj_catalog_manager.html#d6">02269</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_catalog_manager.html#d6">DbjCatalogManager::getSystemIndexParameters</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga5">IndexId</a> indexId,
02270         <span class="keyword">const</span> <span class="keywordtype">char</span> *&amp;indexName, <a class="code" href="group__tableid.html#ga1">TableId</a> &amp;tableId, <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> &amp;columnId,
02271         DbjDataType &amp;dataType, <span class="keywordtype">bool</span> &amp;unique)
02272 {
02273     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
02274     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Index ID"</span>, indexId);
02275 
02276     <span class="keywordflow">if</span> (indexId &lt; 1 || indexId &gt; <a class="code" href="class_dbj_catalog_manager.html#s11">MAX_CATALOG_INDEXID</a>) {
02277         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
02278         <span class="keywordflow">goto</span> cleanup;
02279     }
02280 
02281     {
02282         <span class="keyword">const</span> <a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html">IndexDefinition</a> &amp;indexDef = <a class="code" href="class_dbj_catalog_manager.html#v1">indexDefs</a>[indexId-1];
02283         <span class="keywordflow">if</span> (indexDef.<a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html#o0">indexId</a> != indexId) {
02284             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
02285             <span class="keywordflow">goto</span> cleanup;
02286         }
02287         indexName = indexDef.<a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html#o1">indexName</a>;
02288         tableId = indexDef.<a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html#o2">tableId</a>;
02289         columnId = indexDef.<a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html#o3">columnId</a>;
02290         dataType = indexDef.<a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html#o4">dataType</a>;
02291         unique = indexDef.<a class="code" href="struct_dbj_catalog_manager_1_1_index_definition.html#o5">unique</a>;
02292     }
02293 
02294  cleanup:
02295     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
02296 }
02297 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:28 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
