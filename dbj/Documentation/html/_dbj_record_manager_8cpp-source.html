<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjRecordManager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjRecordManager.cpp</h1><a href="_dbj_record_manager_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2004-2005                                                         *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="_dbj_record_manager_8hpp.html">DbjRecordManager.hpp</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="_dbj_record_iterator_8hpp.html">DbjRecordIterator.hpp</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="_dbj_record_8hpp.html">DbjRecord.hpp</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="_dbj_lock_manager_8hpp.html">DbjLockManager.hpp</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="_dbj_buffer_manager_8hpp.html">DbjBufferManager.hpp</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="_dbj_page_8hpp.html">DbjPage.hpp</a>"</span>
00017 
00018 
<a name="l00019"></a><a class="code" href="_dbj_record_manager_8cpp.html#a0">00019</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="_dbj_record_manager_8cpp.html#a0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a6">RecordManager</a>;
00020 
<a name="l00021"></a><a class="code" href="class_dbj_record_manager.html#v0">00021</a> <a class="code" href="class_dbj_record_manager.html">DbjRecordManager</a> *<a class="code" href="class_dbj_record_manager.html#v0">DbjRecordManager::instance</a>;
<a name="l00022"></a><a class="code" href="class_dbj_record_manager.html#v3">00022</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> <a class="code" href="class_dbj_record_manager.html#v3">DbjRecordManager::MAX_FSI_ENTRIES</a>;
<a name="l00023"></a><a class="code" href="class_dbj_record_manager.html#v2">00023</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> <a class="code" href="class_dbj_record_manager.html#v2">DbjRecordManager::FSI_BLOCK_SIZE</a>;
<a name="l00024"></a><a class="code" href="class_dbj_record_manager.html#v1">00024</a> <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> <a class="code" href="class_dbj_record_manager.html#v1">DbjRecordManager::MAX_SLOTS</a>;
00025 
00026 
00027 <span class="comment">// Konstruktor</span>
<a name="l00028"></a><a class="code" href="class_dbj_record_manager.html#d0">00028</a> <a class="code" href="class_dbj_record_manager.html#d0">DbjRecordManager::DbjRecordManager</a>() : bufferMgr(NULL), lockMgr(NULL)
00029 {
00030     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00031 
00032     <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a> = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00033     <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a> = <a class="code" href="class_dbj_lock_manager.html#e0">DbjLockManager::getInstance</a>();
00034 }
00035 
00036 
00037 <span class="comment">// Erzeuge neue Tabelle</span>
<a name="l00038"></a><a class="code" href="class_dbj_record_manager.html#a0">00038</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a0">DbjRecordManager::createTable</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId)
00039 {
00040     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00041     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00042 
00043     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00044 
00045     <span class="comment">// neues Segment anlegen</span>
00046     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a0">createSegment</a>(segmentId);
00047     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00048         <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a81">DBJ_FM_FILE_ALREADY_EXISTS</a>) {
00049             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a58">DBJ_RM_TABLE_ALREADY_EXISTS</a>, tableId);
00050             <span class="keywordflow">goto</span> cleanup;
00051         }
00052         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00053         <span class="keywordflow">goto</span> cleanup;
00054     }
00055 
00056  cleanup:
00057     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00058 }
00059 
00060 
00061 <span class="comment">// Loesche existierende Tabelle</span>
<a name="l00062"></a><a class="code" href="class_dbj_record_manager.html#a1">00062</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a1">DbjRecordManager::dropTable</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId)
00063 {
00064     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00065     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00066 
00067     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00068 
00069     <span class="comment">// loesche Segment</span>
00070     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a1">dropSegment</a>(segmentId);
00071     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00072         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00073         <span class="keywordflow">goto</span> cleanup;
00074     }
00075 
00076  cleanup:
00077     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00078 }
00079 
00080 
00081 <span class="comment">// Fuege Record ein</span>
<a name="l00082"></a><a class="code" href="class_dbj_record_manager.html#d17">00082</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a2">DbjRecordManager::insert</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_record.html">DbjRecord</a> &amp;record,
00083         <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId, <span class="keyword">const</span> RecordType recordType, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00084 {
00085     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00086     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00087     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId = 0;
00088     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00089     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
00090     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> offsetFreeBlock = 0;
00091     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> freeBlockLength = 0;
00092     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> insertSlot = 0;
00093     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> recordLength = record.<a class="code" href="class_dbj_record.html#a2">getLength</a>();
00094 
00095     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00096 
00097     <span class="keywordflow">if</span> (!record.<a class="code" href="class_dbj_record.html#a3">getRecordData</a>() || recordLength == 0 ||
00098             (recordType != <a class="code" href="class_dbj_record_manager.html#y3y0">PrimaryRecord</a> &amp;&amp; recordType != <a class="code" href="class_dbj_record_manager.html#y3y1">SecondaryRecord</a>)) {
00099         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00100         <span class="keywordflow">goto</span> cleanup;
00101     }
00102     <span class="keywordflow">if</span> (recordLength &gt; DBJ_PAGE_SIZE -  <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) ||
00103             recordLength &gt;= DBJ_MAX_UINT16) {
00104         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a53">DBJ_RM_INSERT_RECORD_TOO_LONG</a>,
00105                 recordLength, DBJ_PAGE_SIZE);
00106         <span class="keywordflow">goto</span> cleanup;
00107     }
00108 
00109     <span class="comment">// alle Records sind mindestens "sizeof(TupleId)" lang sein damit beim</span>
00110     <span class="comment">// "replace" auf jeden Fall immer genug Platz fuer die Stellvertreter-TID</span>
00111     <span class="comment">// vorhanden ist</span>
00112     <span class="keywordflow">if</span> (recordLength &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>)) {
00113         recordLength = <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>);
00114     }
00115 
00116     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a2">openSegment</a>(segmentId);
00117     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00118         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00119         <span class="keywordflow">goto</span> cleanup;
00120     }
00121 
00122     <span class="comment">// freie Seite mit genuegend Platz via FSI finden</span>
00123     rc = <a class="code" href="class_dbj_record_manager.html#d12">findFreeMemoryBlock</a>(tableId, recordLength, pageId);
00124     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a51">DBJ_RM_NO_MEMORY_BLOCK_FOUND_WARN</a>) {
00125         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00126         <span class="keywordflow">goto</span> cleanup;
00127     }
00128     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc) {
00129         <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> pageInfo;
00130 
00131         <span class="comment">/*</span>
00132 <span class="comment">         * keine passende Seite gefunden, also muss eine neue angefordert</span>
00133 <span class="comment">         * werden</span>
00134 <span class="comment">         */</span>
00135         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung zuruecksetzen</span>
00136 
00137         <span class="comment">// Seite bestimmen und holen</span>
00138         rc = <a class="code" href="class_dbj_record_manager.html#d15">getNewPageId</a>(tableId, pageId);
00139         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00140             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00141             <span class="keywordflow">goto</span> cleanup;
00142         }
00143         rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, pageId, DbjLockManager::ExclusiveLock);
00144         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00145             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00146             <span class="keywordflow">goto</span> cleanup;
00147         }
00148         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getNewPage</a>(segmentId, pageId, DbjPage::DataPage, page);
00149         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00150             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00151             <span class="keywordflow">goto</span> cleanup;
00152         }
00153 
00154         <span class="comment">// (leere) Seite im FSI eintragen</span>
00155         <a class="code" href="class_dbj_record_manager.html#d5">markEmptyPage</a>(pageInfo);
00156         rc = <a class="code" href="class_dbj_record_manager.html#d7">addFsiEntry</a>(tableId, pageId, pageInfo);
00157         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00158             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00159             <span class="keywordflow">goto</span> cleanup;
00160         }
00161 
00162         <span class="comment">// Seite initialisieren</span>
00163         slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00164         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> = 0;
00165         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o1">freeSpace</a> = DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>);
00166         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a> = DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>);
00167         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o3">consecFreeSpaceOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>);
00168     }
00169     <span class="keywordflow">else</span> {
00170         <span class="comment">// Seite bereits gefunden</span>
00171         rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, pageId,
00172                 DbjLockManager::ExclusiveLock);
00173         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00174             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00175             <span class="keywordflow">goto</span> cleanup;
00176         }
00177         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, pageId, DbjPage::DataPage, page);
00178         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00179             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00180             <span class="keywordflow">goto</span> cleanup;
00181         }
00182 
00183         <span class="comment">// finde groessten freien Platz der Seite</span>
00184         slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00185 <span class="preprocessor">#if !defined(DBJ_OPTIMIZE)</span>
00186 <span class="preprocessor"></span>        rc = <a class="code" href="class_dbj_record_manager.html#d13">findLargestFreeSpaceInPage</a>(page, offsetFreeBlock,
00187                 freeBlockLength);
00188         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00189             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00190             <span class="keywordflow">goto</span> cleanup;
00191         }
00192         <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a> != freeBlockLength ||
00193                 slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o3">consecFreeSpaceOffset</a> != offsetFreeBlock) {
00194             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00195             <span class="keywordflow">goto</span> cleanup;
00196         }
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>    }
00199 
00200     <span class="comment">// freien Platz bestimmen</span>
00201     freeBlockLength = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a>;
00202     offsetFreeBlock = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o3">consecFreeSpaceOffset</a>;
00203 
00204     <span class="comment">// jetzt wissen wir, dass der groesste freie Block an "offsetFreeBlock" zu</span>
00205     <span class="comment">// finden ist, und "freeBlockLength" gross ist</span>
00206     <span class="keywordflow">if</span> (freeBlockLength &lt; recordLength) {
00207         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00208         <span class="keywordflow">goto</span> cleanup;
00209     }
00210 
00211     <span class="comment">// nach einen freien, nicht-genutzten Slot in der Slot-Tabelle suchen</span>
00212     insertSlot = 0;
00213     <span class="keywordflow">while</span> (insertSlot &lt; slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> &amp;&amp;
00214             slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[insertSlot].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> != 0) {
00215         insertSlot++;
00216     }
00217 
00218     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00219     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00220         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00221         <span class="keywordflow">goto</span> cleanup;
00222     }
00223 
00224     <span class="comment">// alle Slots voll, fuege am Ende an</span>
00225     <span class="keywordflow">if</span> (insertSlot == slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>) {
00226         <span class="comment">// eine Seite hat maximal MAX_SLOTS Slots, und wir duerfen nie in den</span>
00227         <span class="comment">// naechsten einfuegen wollen - wenn doch, dann ist das FSI fehlerhaft</span>
00228         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>++;
00229         <span class="keywordflow">if</span> (insertSlot &gt;= <a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a>) {
00230             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00231             <span class="keywordflow">goto</span> cleanup;
00232         }
00233 
00234         <span class="comment">// wir fuegen im letzten Slot ein</span>
00235         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[insertSlot].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = 0;
00236     }
00237 
00238     <span class="comment">// fuege Record in gefundenen (leeren) Slot ein</span>
00239     <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[insertSlot].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> != 0) {
00240         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00241         <span class="keywordflow">goto</span> cleanup;
00242     }
00243 
00244     <span class="comment">// setze Record-Typ</span>
00245     slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[insertSlot].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> = recordType;
00246 
00247     <span class="comment">// Rueckgabewert der Tupel-ID setzen</span>
00248     tid.<a class="code" href="struct_tuple_id.html#o0">page</a> = pageId;
00249     tid.<a class="code" href="struct_tuple_id.html#o1">slot</a> = insertSlot;
00250 
00251     <span class="comment">// Record auf Seite kopieren</span>
00252     {
00253         <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> *slot = &amp;slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[insertSlot];
00254         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = offsetFreeBlock + freeBlockLength - recordLength;
00255         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = recordLength;
00256 
00257         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>, record.<a class="code" href="class_dbj_record.html#a3">getRecordData</a>(),
00258                 record.<a class="code" href="class_dbj_record.html#a2">getLength</a>());
00259     }
00260 
00261     <span class="comment">// aktualisiere Freiplatzinformationen in der Seite</span>
00262     rc = <a class="code" href="class_dbj_record_manager.html#d8">updateFreeSpace</a>(page);
00263     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00264         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00265         <span class="keywordflow">goto</span> cleanup;
00266     }
00267 
00268  cleanup:
00269     <span class="keywordflow">if</span> (page != NULL) {
00270         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00271     }
00272     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00273 }
00274 
00275 
00276 <span class="comment">// Loesche Record von Seite</span>
<a name="l00277"></a><a class="code" href="class_dbj_record_manager.html#a3">00277</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a3">DbjRecordManager::remove</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId, <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid)
00278 {
00279     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00280     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00281     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00282     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
00283     <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> *slot = NULL;
00284 
00285     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00286     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
00287     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page ID"</span>, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>);
00288     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(3, <span class="stringliteral">"Slot"</span>, tid.<a class="code" href="struct_tuple_id.html#o1">slot</a>);
00289 
00290     <span class="comment">// hole Datenseite</span>
00291     rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>, DbjLockManager::ExclusiveLock);
00292     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00293         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00294         <span class="keywordflow">goto</span> cleanup;
00295     }
00296     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>, DbjPage::DataPage, page);
00297     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00298         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00299         <span class="keywordflow">goto</span> cleanup;
00300     }
00301     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00302     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00303         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00304         <span class="keywordflow">goto</span> cleanup;
00305     }
00306 
00307     <span class="comment">// Slot leeren (wenn wir eine Stellvertreter-TID haben, dann muessen wir</span>
00308     <span class="comment">// noch die andere Seite leer raeumen)</span>
00309     slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00310     <span class="keywordflow">if</span> (tid.<a class="code" href="struct_tuple_id.html#o1">slot</a> &gt;= slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>) {
00311         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00312         <span class="keywordflow">goto</span> cleanup;
00313     }
00314 
00315     slot = &amp;slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[tid.<a class="code" href="struct_tuple_id.html#o1">slot</a>];
00316     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> == <a class="code" href="class_dbj_record_manager.html#y3y2">PlaceHolderTid</a>) {
00317         <a class="code" href="struct_tuple_id.html">TupleId</a> secondaryTid;
00318         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(&amp;secondaryTid, page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>,
00319                 <span class="keyword">sizeof</span> secondaryTid);
00320 
00321         rc = <a class="code" href="class_dbj_record_manager.html#a3">remove</a>(tableId, secondaryTid);
00322         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00323             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00324             <span class="keywordflow">goto</span> cleanup;
00325         }
00326     }
00327     slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = 0;
00328     slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = 0;
00329     slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> = <a class="code" href="class_dbj_record_manager.html#y3y0">PrimaryRecord</a>;
00330 
00331     <span class="comment">// war dies der aktuell letzte Slot, so wird die Slottabelle gleich</span>
00332     <span class="comment">// verkleinert</span>
00333     <span class="keywordflow">if</span> (tid.<a class="code" href="struct_tuple_id.html#o1">slot</a> == slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> - 1) {
00334         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> - 1;
00335                  slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> == 0 &amp;&amp;
00336                  slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> &gt; 0; i--) {
00337             slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>--;
00338         }
00339     }
00340 
00341     <span class="comment">// aktualisiere Freiplatzinformationen in der Seite</span>
00342     rc = <a class="code" href="class_dbj_record_manager.html#d8">updateFreeSpace</a>(page);
00343     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00344         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00345         <span class="keywordflow">goto</span> cleanup;
00346     }
00347 
00348  cleanup:
00349     <span class="keywordflow">if</span> (page != NULL) {
00350         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00351     }
00352     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00353 }
00354 
00355 
00356 <span class="comment">// Ersetze Record</span>
<a name="l00357"></a><a class="code" href="class_dbj_record_manager.html#d18">00357</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a4">DbjRecordManager::replace</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
00358         <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid, <span class="keyword">const</span> <a class="code" href="class_dbj_record.html">DbjRecord</a> &amp;record, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;newTid)
00359 {
00360     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00361     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00362     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00363     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
00364     <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> *slot = NULL;
00365     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> recordLength = record.<a class="code" href="class_dbj_record.html#a2">getLength</a>();
00366 
00367     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00368     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
00369     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page ID"</span>, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>);
00370     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Slot ID"</span>, tid.<a class="code" href="struct_tuple_id.html#o1">slot</a>);
00371 
00372     <span class="keywordflow">if</span> (!record.<a class="code" href="class_dbj_record.html#a3">getRecordData</a>() || recordLength == 0) {
00373         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00374         <span class="keywordflow">goto</span> cleanup;
00375     }
00376     <span class="keywordflow">if</span> (recordLength &gt; DBJ_PAGE_SIZE -  <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) ||
00377             recordLength &gt;= DBJ_MAX_UINT16) {
00378         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a53">DBJ_RM_INSERT_RECORD_TOO_LONG</a>,
00379                 recordLength, DBJ_PAGE_SIZE);
00380         <span class="keywordflow">goto</span> cleanup;
00381     }
00382 
00383     <span class="comment">// alle Records sind mindestens "sizeof(TupleId)" lang sein damit beim</span>
00384     <span class="comment">// "replace" auf jeden Fall immer genug Platz fuer die Stellvertreter-TID</span>
00385     <span class="comment">// vorhanden ist</span>
00386     <span class="keywordflow">if</span> (recordLength &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>)) {
00387         recordLength = <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>);
00388     }
00389 
00390     newTid = tid;
00391 
00392     <span class="comment">// Datenseite holen</span>
00393     rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, tid.page, DbjLockManager::ExclusiveLock);
00394     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00395         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00396         <span class="keywordflow">goto</span> cleanup;
00397     }
00398     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, tid.page, DbjPage::DataPage, page);
00399     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00400         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00401         <span class="keywordflow">goto</span> cleanup;
00402     }
00403 
00404     slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00405     <span class="keywordflow">if</span> (tid.slot &gt;= slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>) {
00406         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00407         <span class="keywordflow">goto</span> cleanup;
00408     }
00409     slot = &amp;slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[tid.slot];
00410     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> == 0) {
00411         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00412         <span class="keywordflow">goto</span> cleanup;
00413     }
00414     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>) + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &gt; DBJ_PAGE_SIZE ||
00415             slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) +
00416             slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>)) {
00417         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00418         <span class="keywordflow">goto</span> cleanup;
00419     }
00420 
00421     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00422     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00423         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00424         <span class="keywordflow">goto</span> cleanup;
00425     }
00426 
00427     <span class="comment">// Record wurde zuvor bereits einmal ausgelagert; also aktualisieren wir</span>
00428     <span class="comment">// den sekundaeren Record</span>
00429     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> == <a class="code" href="class_dbj_record_manager.html#y3y2">PlaceHolderTid</a>) {
00430         <a class="code" href="struct_tuple_id.html">TupleId</a> secondaryTid;
00431         <a class="code" href="struct_tuple_id.html">TupleId</a> newSecondaryTid;
00432 
00433         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(&amp;secondaryTid, page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>,
00434                 <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>));
00435         rc = <a class="code" href="class_dbj_record_manager.html#a4">replace</a>(tableId, secondaryTid, record, newSecondaryTid);
00436         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00437             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00438             <span class="keywordflow">goto</span> cleanup;
00439         }
00440 
00441         <span class="comment">// der sekundare Record musste auf eine andere Seite verschoben</span>
00442         <span class="comment">// werden; also loeschen wird den alten sekundaeren Record und</span>
00443         <span class="comment">// aktualisieren die Stellvertreter-TID auf der aktuellen Seite</span>
00444         <span class="keywordflow">if</span> (secondaryTid != newSecondaryTid) {
00445             rc = <a class="code" href="class_dbj_record_manager.html#a3">remove</a>(tableId, secondaryTid);
00446             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00447                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00448                 <span class="keywordflow">goto</span> cleanup;
00449             }
00450             <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>, &amp;newSecondaryTid,
00451                     <span class="keyword">sizeof</span> newSecondaryTid);
00452         }
00453 
00454         <span class="comment">// fertig</span>
00455         <span class="keywordflow">goto</span> cleanup;
00456     }
00457 
00458     <span class="comment">// Record waechst</span>
00459     <span class="keywordflow">if</span> (recordLength &gt; slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>) {
00460         <span class="comment">// Record ersetzen und gegebenenfalls auslagern/Seite reorganisieren</span>
00461         rc = <a class="code" href="class_dbj_record_manager.html#d20">getRecordOffsetOnPage</a>(record, tableId, tid, page, slot, newTid);
00462         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00463             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00464             <span class="keywordflow">goto</span> cleanup;
00465         }
00466 
00467         <span class="keywordflow">if</span> (tid != newTid) {
00468             <span class="comment">// Record wurde auf eine andere Seite ausgelagert</span>
00469             <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>, &amp;newTid,
00470                     <span class="keyword">sizeof</span> newTid);
00471             slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = <span class="keyword">sizeof</span> newTid;
00472             slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> = <a class="code" href="class_dbj_record_manager.html#y3y2">PlaceHolderTid</a>;
00473         }
00474         <span class="keywordflow">else</span> {
00475             <span class="comment">// Record hat immer noch auf die Seite gepasst</span>
00476             <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>,
00477                     record.<a class="code" href="class_dbj_record.html#a3">getRecordData</a>(), record.<a class="code" href="class_dbj_record.html#a2">getLength</a>());
00478             slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = recordLength;
00479         }
00480     }
00481     <span class="keywordflow">else</span> {
00482         <span class="comment">// Record in-place ersetzen</span>
00483         <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) +
00484                 slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>) ||
00485                 <a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>) + recordLength &gt; DBJ_PAGE_SIZE) {
00486             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00487             <span class="keywordflow">goto</span> cleanup;
00488         }
00489         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>, record.<a class="code" href="class_dbj_record.html#a3">getRecordData</a>(),
00490                 record.<a class="code" href="class_dbj_record.html#a2">getLength</a>());
00491         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = recordLength;
00492         <span class="comment">// Typ aendert sich nicht!</span>
00493     }
00494 
00495     <span class="comment">// Freiplatzinformationen aktualisieren</span>
00496     rc = <a class="code" href="class_dbj_record_manager.html#d8">updateFreeSpace</a>(page);
00497     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00498         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00499         <span class="keywordflow">goto</span> cleanup;
00500     }
00501 
00502  cleanup:
00503     <span class="keywordflow">if</span> (page != NULL) {
00504         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00505     }
00506     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00507 }
00508 
00509 
00510 <span class="comment">// Hole Record</span>
<a name="l00511"></a><a class="code" href="class_dbj_record_manager.html#d19">00511</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a5">DbjRecordManager::get</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
00512         <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid, <span class="keyword">const</span> <span class="keywordtype">bool</span> primaryOnly, <a class="code" href="class_dbj_record.html">DbjRecord</a> *&amp;record)
00513 {
00514     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00515     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00516     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00517     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pageData = NULL;
00518     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
00519     <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> *slot = NULL;
00520 
00521     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00522     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
00523     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page ID"</span>, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>);
00524     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(3, <span class="stringliteral">"Slot"</span>, tid.<a class="code" href="struct_tuple_id.html#o1">slot</a>);
00525 
00526     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a2">openSegment</a>(segmentId);
00527     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00528         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00529         <span class="keywordflow">goto</span> cleanup;
00530     }
00531 
00532     <span class="comment">// Datenseite holen</span>
00533     rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>, DbjLockManager::SharedLock);
00534     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00535         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00536         <span class="keywordflow">goto</span> cleanup;
00537     }
00538     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>, DbjPage::DataPage, page);
00539     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a70">DBJ_BM_PAGE_NOT_FOUND</a>) {
00540         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00541         <span class="keywordflow">goto</span> cleanup;
00542     }
00543     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc) {
00544         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
00545         <span class="keywordflow">goto</span> cleanup;
00546     }
00547 
00548     <span class="comment">// Record auf der Seite finden</span>
00549     pageData = page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>();
00550     slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(pageData);
00551     <span class="keywordflow">if</span> (tid.<a class="code" href="struct_tuple_id.html#o1">slot</a> &gt;= slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> ||
00552             slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[tid.<a class="code" href="struct_tuple_id.html#o1">slot</a>].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> == 0) {
00553         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00554         <span class="keywordflow">goto</span> cleanup;
00555     }
00556     slot = &amp;slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[tid.<a class="code" href="struct_tuple_id.html#o1">slot</a>];
00557     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> &gt;= DBJ_PAGE_SIZE) {
00558         <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a54">DBJ_RM_RECORD_OUT_OF_PAGE_BOUNDS</a>,
00559                 slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>, tid.<a class="code" href="struct_tuple_id.html#o0">page</a>, segmentId);
00560         <span class="keywordflow">goto</span> cleanup;
00561     }
00562     <span class="keywordflow">if</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>) &gt; DBJ_PAGE_SIZE) {
00563         <a class="code" href="_dbj_error_8hpp.html#a6">DBJ_SET_ERROR_TOKEN5</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a52">DBJ_RM_GET_RECORD_TOO_LONG</a>, slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>,
00564                 tid.<a class="code" href="struct_tuple_id.html#o0">page</a>, segmentId, slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>, DBJ_PAGE_SIZE);
00565         <span class="keywordflow">goto</span> cleanup;
00566     }
00567 
00568     <span class="keywordflow">if</span> (primaryOnly &amp;&amp; slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> != <a class="code" href="class_dbj_record_manager.html#y3y2">PlaceHolderTid</a> &amp;&amp;
00569             slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> != <a class="code" href="class_dbj_record_manager.html#y3y0">PrimaryRecord</a>) {
00570         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00571         <span class="keywordflow">goto</span> cleanup;
00572     }
00573 
00574     <span class="comment">// Slot enthaelt nur eine Stellvertreter-TID und der Record ist eigentlich</span>
00575     <span class="comment">// auf einer anderen Seite</span>
00576     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> == <a class="code" href="class_dbj_record_manager.html#y3y2">PlaceHolderTid</a>) {
00577         <a class="code" href="struct_tuple_id.html">TupleId</a> realTid;
00578 
00579         <a class="code" href="group__memory__functions.html#ga5">DbjMemCopy</a>(&amp;realTid, pageData + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>, <span class="keyword">sizeof</span> realTid);
00580 
00581         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00582         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00583             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00584             <span class="keywordflow">goto</span> cleanup;
00585         }
00586 
00587         rc = <a class="code" href="class_dbj_record_manager.html#a5">get</a>(tableId, realTid, <span class="keyword">false</span>, record);
00588         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00589             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00590             <span class="keywordflow">goto</span> cleanup;
00591         }
00592     }
00593     <span class="keywordflow">else</span> {
00594         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *recordData = pageData + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>;
00595 
00596         <span class="comment">// kopiere Binaerdaten in das DbjRecord Objekt</span>
00597         <span class="keywordflow">if</span> (record == NULL) {
00598             record = <span class="keyword">new</span> <a class="code" href="class_dbj_record.html">DbjRecord</a>(recordData, slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>);
00599             <span class="keywordflow">if</span> (record == NULL || <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>() != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00600                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00601                 <span class="keywordflow">goto</span> cleanup;
00602             }
00603         }
00604         <span class="keywordflow">else</span> {
00605             <span class="comment">// ueberschreibe alte Daten</span>
00606             rc = record-&gt;<a class="code" href="class_dbj_record.html#d0">setData</a>(recordData, slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>);
00607             <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00608                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00609                 <span class="keywordflow">goto</span> cleanup;
00610             }
00611         }
00612     }
00613 
00614     <span class="comment">// setze TupleId im Record</span>
00615     rc = record-&gt;<a class="code" href="class_dbj_record.html#d1">setTupleId</a>(tid);
00616     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00617         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00618         <span class="keywordflow">goto</span> cleanup;
00619     }
00620 
00621  cleanup:
00622     <span class="keywordflow">if</span> (page != NULL) {
00623         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00624     }
00625     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00626 }
00627 
00628 
00629 <span class="comment">// Gib Iterator fuer Table-Scan</span>
<a name="l00630"></a><a class="code" href="class_dbj_record_manager.html#a6">00630</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a6">DbjRecordManager::getRecordIterator</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
00631         <a class="code" href="class_dbj_record_iterator.html">DbjRecordIterator</a> *&amp;iter)
00632 {
00633     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00634     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00635 
00636     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00637 
00638     <span class="keywordflow">if</span> (iter != NULL) {
00639         <span class="keyword">delete</span> iter;
00640     }
00641     iter = <span class="keyword">new</span> <a class="code" href="class_dbj_record_iterator.html">DbjRecordIterator</a>(tableId);
00642     <span class="keywordflow">if</span> (!iter) {
00643         <span class="keywordflow">goto</span> cleanup;
00644     }
00645 
00646     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a2">openSegment</a>(segmentId);
00647     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00648         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00649         <span class="keywordflow">goto</span> cleanup;
00650     }
00651 
00652  cleanup:
00653     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00654 }
00655 
00656 
00657 <span class="comment">// Beende Transaktion erfolgreich</span>
<a name="l00658"></a><a class="code" href="class_dbj_record_manager.html#a7">00658</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a7">DbjRecordManager::commit</a>()
00659 {
00660     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00661 
00662     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00663 
00664     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a7">flush</a>();
00665     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00666         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00667         <span class="keywordflow">goto</span> cleanup;
00668     }
00669     rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a2">releaseAll</a>();
00670     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00671         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00672         <span class="keywordflow">goto</span> cleanup;
00673     }
00674 
00675  cleanup:
00676     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00677 }
00678 
00679 
00680 <span class="comment">// Setze Transaktion zurueck</span>
<a name="l00681"></a><a class="code" href="class_dbj_record_manager.html#a8">00681</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#a8">DbjRecordManager::rollback</a>()
00682 {
00683     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00684 
00685     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00686 
00687     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a8">discard</a>();
00688     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00689         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00690         <span class="keywordflow">goto</span> cleanup;
00691     }
00692     rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a2">releaseAll</a>();
00693     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00694         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00695         <span class="keywordflow">goto</span> cleanup;
00696     }
00697 
00698  cleanup:
00699     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00700 }
00701 
00702 
00703 <span class="comment">// Fuege neue Seite zum FSI hinzu (mit dynamischer Erweiterung des FSI)</span>
<a name="l00704"></a><a class="code" href="class_dbj_record_manager.html#d7">00704</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d7">DbjRecordManager::addFsiEntry</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
00705         <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId, <span class="keyword">const</span> <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> &amp;pageInfo)
00706 {
00707     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00708     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00709     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00710     <a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html">FsiPage</a> *fsiPage = NULL;
00711     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fsiPageId = <a class="code" href="class_dbj_record_manager.html#d2">getFsiPageId</a>(pageId);
00712 
00713     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00714 
00715     <span class="comment">// FSI-Seite darf nicht selbst ins FSI eingefuegt werden</span>
00716     <span class="keywordflow">if</span> (pageId == fsiPageId) {
00717         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a57">DBJ_RM_FSI_ENTRY_NOT_ALLOWED</a>, pageId, segmentId);
00718         <span class="keywordflow">goto</span> cleanup;
00719     }
00720 
00721     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, fsiPageId,
00722             DbjPage::FreeSpaceInventoryPage, page);
00723     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a70">DBJ_BM_PAGE_NOT_FOUND</a>) {
00724         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00725         <span class="keywordflow">goto</span> cleanup;
00726     }
00727     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc) {
00728         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// BM-fehler zuruecksetzen</span>
00729 
00730         <span class="comment">// FSI-Seite gibt es noch gar nicht; neu anlegen</span>
00731         rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, fsiPageId,
00732                 DbjLockManager::ExclusiveLock);
00733         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00734             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00735             <span class="keywordflow">goto</span> cleanup;
00736         }
00737         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getNewPage</a>(segmentId, fsiPageId,
00738                 DbjPage::FreeSpaceInventoryPage, page);
00739         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00740             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00741             <span class="keywordflow">goto</span> cleanup;
00742         }
00743 
00744         <span class="comment">// Seite als FSI interpretieren und initialisieren</span>
00745         fsiPage = reinterpret_cast&lt;FsiPage *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00746         fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a> = 0;
00747 
00748         <span class="comment">// Markiere alle Seiten, die diese FSI-Seite verwaltet, als</span>
00749         <span class="comment">// nicht-existent</span>
00750         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i = 0; i &lt; <a class="code" href="class_dbj_record_manager.html#v3">MAX_FSI_ENTRIES</a>; i++) {
00751             <a class="code" href="class_dbj_record_manager.html#d4">markNotExists</a>(fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o2">pageInfo</a>[i]);
00752         }
00753     }
00754     <span class="keywordflow">else</span> {
00755         rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00756         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00757             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00758             <span class="keywordflow">goto</span> cleanup;
00759         }
00760 
00761         fsiPage = reinterpret_cast&lt;FsiPage *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00762     }
00763 
00764     <span class="comment">// FSI-Eintrag auf der Seite aendern und Eintrag zaehlen</span>
00765     {
00766         <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> &amp;fsiEntry = fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o2">pageInfo</a>[<a class="code" href="class_dbj_record_manager.html#d3">getFsiSlot</a>(pageId)];
00767         <span class="keywordflow">if</span> (<a class="code" href="class_dbj_record_manager.html#d6">pageAlreadyExists</a>(fsiEntry)) {
00768             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00769             <span class="keywordflow">goto</span> cleanup;
00770         }
00771         fsiEntry = pageInfo;
00772         fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a>++;
00773     }
00774 
00775  cleanup:
00776     <span class="keywordflow">if</span> (page) {
00777         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00778     }
00779     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00780 }
00781 
00782 
00783 <span class="comment">// Aendere Daten einer Seite im FSI</span>
<a name="l00784"></a><a class="code" href="class_dbj_record_manager.html#d10">00784</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d10">DbjRecordManager::updateFsiEntry</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId,
00785         <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageToEdit, <span class="keyword">const</span> <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> &amp;newPageInfo)
00786 {
00787     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00788     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00789     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fsiPageId = <a class="code" href="class_dbj_record_manager.html#d2">getFsiPageId</a>(pageToEdit);
00790 
00791     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00792 
00793     <span class="comment">// FSI-Seite darf nicht selbst ins FSI eingefuegt werden</span>
00794     <span class="keywordflow">if</span> (pageToEdit == fsiPageId) {
00795         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a57">DBJ_RM_FSI_ENTRY_NOT_ALLOWED</a>,
00796                 pageToEdit, segmentId);
00797         <span class="keywordflow">goto</span> cleanup;
00798     }
00799 
00800     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, fsiPageId,
00801             DbjPage::FreeSpaceInventoryPage, page);
00802     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00803         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00804         <span class="keywordflow">goto</span> cleanup;
00805     }
00806     rc = page-&gt;<a class="code" href="class_dbj_page.html#a5">markAsModified</a>();
00807     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00808         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00809         <span class="keywordflow">goto</span> cleanup;
00810     }
00811 
00812     <span class="comment">// FSI-Eintrag auf der Seite aendern</span>
00813     {
00814         <a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html">FsiPage</a> *fsiPage = reinterpret_cast&lt;FsiPage *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00815         <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> &amp;fsiEntry = fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o2">pageInfo</a>[<a class="code" href="class_dbj_record_manager.html#d3">getFsiSlot</a>(pageToEdit)];
00816         <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_record_manager.html#d6">pageAlreadyExists</a>(fsiEntry)) {
00817             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
00818             <span class="keywordflow">goto</span> cleanup;
00819         }
00820         fsiEntry = newPageInfo;
00821     }
00822 
00823  cleanup:
00824     <span class="keywordflow">if</span> (page != NULL) {
00825         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00826     }
00827     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00828 }
00829 
00830 
00831 <span class="comment">// FSI-Eintrag einer Seite finden</span>
<a name="l00832"></a><a class="code" href="class_dbj_record_manager.html#d11">00832</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d11">DbjRecordManager::findFsiEntry</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
00833         <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageToFind, <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> &amp;pageInfo)
00834 {
00835     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00836     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
00837     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00838     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fsiPageId = <a class="code" href="class_dbj_record_manager.html#d2">getFsiPageId</a>(pageToFind);
00839 
00840     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00841 
00842     <span class="comment">// FSI-Seite darf nicht selbst im FSI sein</span>
00843     <span class="keywordflow">if</span> (pageToFind == fsiPageId) {
00844         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a57">DBJ_RM_FSI_ENTRY_NOT_ALLOWED</a>,
00845                 pageToFind, segmentId);
00846         <span class="keywordflow">goto</span> cleanup;
00847     }
00848 
00849     rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, fsiPageId,
00850             DbjPage::FreeSpaceInventoryPage, page);
00851     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a70">DBJ_BM_PAGE_NOT_FOUND</a>) {
00852         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00853         <span class="keywordflow">goto</span> cleanup;
00854     }
00855     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc) {
00856         <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a55">DBJ_RM_FSI_PAGE_DOES_NOT_EXIST</a>, fsiPageId,
00857                 pageToFind, segmentId);
00858         <span class="keywordflow">goto</span> cleanup;
00859     }
00860 
00861     <span class="comment">// FSI-Eintrag der gesuchten Seite ermitteln</span>
00862     {
00863         <a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html">FsiPage</a> *fsiPage = reinterpret_cast&lt;FsiPage *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00864         pageInfo = fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o2">pageInfo</a>[<a class="code" href="class_dbj_record_manager.html#d3">getFsiSlot</a>(pageToFind)];
00865     }
00866 
00867     <span class="comment">// Pruefe, ob Seite bereits im FSI als "existent" markiert ist</span>
00868     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_record_manager.html#d6">pageAlreadyExists</a>(pageInfo)) {
00869         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a56">DBJ_RM_NO_FSI_ENTRY_FOR_PAGE</a>,
00870                 pageToFind, segmentId);
00871         <span class="keywordflow">goto</span> cleanup;
00872     }
00873         
00874  cleanup:
00875     <span class="keywordflow">if</span> (page != NULL) {
00876         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00877     }
00878     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00879         
00880 }
00881 
00882 
00883 <span class="comment">// Finde freien Platz in irgendeiner Seite</span>
<a name="l00884"></a><a class="code" href="class_dbj_record_manager.html#d12">00884</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d12">DbjRecordManager::findFreeMemoryBlock</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> table,
00885         <span class="keyword">const</span> <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> numBytes, <a class="code" href="group__id__datatypes.html#ga0">PageId</a> &amp;freePage)
00886 {
00887     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00888     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(table);
00889     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00890     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fsiPageId = 0;
00891     <a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html">FsiPage</a> *fsiPage = NULL;
00892     <span class="keywordtype">bool</span> foundEntry = <span class="keyword">false</span>;
00893 
00894     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00895     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, table);
00896     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Record size"</span>, numBytes);
00897 
00898     <span class="comment">// Platzangabe im FSI wird in Bloecken der Groesse FSI_BLOCK_SIZE</span>
00899     <span class="comment">// gefuehrt (Platzbedarf aufrunden!)</span>
00900     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> minBlockSize = numBytes / <a class="code" href="class_dbj_record_manager.html#v2">FSI_BLOCK_SIZE</a>;
00901     <span class="keywordflow">if</span> (numBytes % <a class="code" href="class_dbj_record_manager.html#v2">FSI_BLOCK_SIZE</a> != 0) {
00902         minBlockSize++;
00903     }
00904 
00905     <span class="comment">// durchsuche die einzelnen FSI-Seiten, bis eine passende Seite gefunden</span>
00906     <span class="comment">// wird</span>
00907     <span class="keywordflow">while</span> (!foundEntry) {
00908         <span class="comment">// hole FSI-Seite</span>
00909         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, fsiPageId,
00910                 DbjPage::FreeSpaceInventoryPage, page);
00911         <span class="keywordflow">if</span> (rc == <a class="code" href="_dbj_error_codes_8hpp.html#a107a70">DBJ_BM_PAGE_NOT_FOUND</a>) {
00912             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung/Fehler zuruecksetzen</span>
00913             <span class="keywordflow">break</span>;
00914         }
00915         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00916             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00917             <span class="keywordflow">goto</span> cleanup;
00918         }
00919 
00920         <span class="comment">// einzelnen Eintraege der FSI-Seite durchsuchen</span>
00921         fsiPage = reinterpret_cast&lt;FsiPage *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00922         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga9">Uint16</a> i = 0; i &lt; fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a> &amp;&amp; !foundEntry; i++) {
00923             <span class="keywordflow">if</span> (fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o2">pageInfo</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html#o1">freeSpaceBlock</a> &gt;= minBlockSize) {
00924                 foundEntry = <span class="keyword">true</span>;
00925                 freePage = fsiPageId + i + 1;
00926                 <span class="keywordflow">break</span>;
00927             }
00928         }
00929 
00930         <span class="comment">// alte FSI-Seite freigeben</span>
00931         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00932         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00933             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00934             <span class="keywordflow">goto</span> cleanup;
00935         }
00936         page = NULL;
00937 
00938         <span class="comment">// falls Eintrag nicht gefunden, dann gehe auf die naechste FSI-Seite</span>
00939         <span class="keywordflow">if</span> (!foundEntry) {
00940             <span class="comment">// FSI-Seite hat noch nicht-genutzte Slots</span>
00941             <span class="keywordflow">if</span> (fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a> &lt; <a class="code" href="class_dbj_record_manager.html#v3">MAX_FSI_ENTRIES</a>) {
00942                 <span class="keywordflow">break</span>;
00943             }
00944             <span class="comment">// letzte FSI-Seite erreicht</span>
00945             <span class="keywordflow">if</span> (fsiPageId == <a class="code" href="class_dbj_record_manager.html#d2">getFsiPageId</a>(DBJ_MAX_PAGE_ID)) {
00946                 <span class="keywordflow">break</span>;
00947             }
00948             fsiPageId += <a class="code" href="class_dbj_record_manager.html#v3">MAX_FSI_ENTRIES</a> + 1;
00949         }
00950     }
00951 
00952     <span class="comment">// falls kein passender Eintrag gefunden, dann Warnung setzen</span>
00953     <span class="keywordflow">if</span> (!foundEntry) {
00954         <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a51">DBJ_RM_NO_MEMORY_BLOCK_FOUND_WARN</a>,
00955                 table, numBytes);
00956         <span class="keywordflow">goto</span> cleanup;
00957     }
00958 
00959  cleanup:
00960     <span class="keywordflow">if</span> (page != NULL) {
00961         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
00962     }
00963     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00964 }
00965 
00966 
00967 <span class="comment">// Aktualisiere Freiplatzinformationen in der Seite und im FSI</span>
<a name="l00968"></a><a class="code" href="class_dbj_record_manager.html#d8">00968</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d8">DbjRecordManager::updateFreeSpace</a>(<a class="code" href="class_dbj_page.html">DbjPage</a> *page)
00969 {
00970     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00971     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
00972     <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> oldFsiLargestFreeBlock = 0;
00973     <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> oldFsiFreeSpace = 0;
00974     <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> pageInfo;
00975 
00976     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00977 
00978     <span class="keywordflow">if</span> (!page) {
00979         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00980         <span class="keywordflow">goto</span> cleanup;
00981     }
00982 
00983     slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
00984     oldFsiLargestFreeBlock = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a> / <a class="code" href="class_dbj_record_manager.html#v2">FSI_BLOCK_SIZE</a>;
00985     oldFsiFreeSpace = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o1">freeSpace</a> / <a class="code" href="class_dbj_record_manager.html#v2">FSI_BLOCK_SIZE</a>;
00986 
00987     <span class="comment">// neuen Freiplatz in der Seite errechnen</span>
00988     rc = <a class="code" href="class_dbj_record_manager.html#d13">findLargestFreeSpaceInPage</a>(page, slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o3">consecFreeSpaceOffset</a>,
00989             slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a>);
00990     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00991         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00992         <span class="keywordflow">goto</span> cleanup;
00993     }
00994     rc = <a class="code" href="class_dbj_record_manager.html#d14">findFreeSpaceInPage</a>(page, slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o1">freeSpace</a>);
00995     <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
00996         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00997         <span class="keywordflow">goto</span> cleanup;
00998     }
00999     <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a> &gt; slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o1">freeSpace</a>) {
01000         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01001         <span class="keywordflow">goto</span> cleanup;
01002     }
01003 
01004     <span class="comment">// Eintrag in FSI-Seite aktualisieren, wenn noetig</span>
01005     pageInfo.<a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html#o1">freeSpaceBlock</a> = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a> / <a class="code" href="class_dbj_record_manager.html#v2">FSI_BLOCK_SIZE</a>;
01006     pageInfo.<a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html#o0">freeSpace</a> = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o1">freeSpace</a> / <a class="code" href="class_dbj_record_manager.html#v2">FSI_BLOCK_SIZE</a>;
01007     <span class="keywordflow">if</span> (oldFsiLargestFreeBlock != pageInfo.<a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html#o1">freeSpaceBlock</a> ||
01008             oldFsiFreeSpace != pageInfo.<a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html#o0">freeSpace</a>) {
01009         rc = <a class="code" href="class_dbj_record_manager.html#d10">updateFsiEntry</a>(page-&gt;<a class="code" href="class_dbj_page.html#a0">getSegmentId</a>(), page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>(), pageInfo);
01010         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01011             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01012             <span class="keywordflow">goto</span> cleanup;
01013         }
01014     }
01015 
01016  cleanup:
01017     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01018 }
01019 
01020 
01021 <span class="comment">// Datenstruktur zum sortieren von Slot-Eintraegen gemaess der Offsets der</span>
01022 <span class="comment">// Eintraege</span>
<a name="l01023"></a><a class="code" href="struct_slot_info.html">01023</a> <span class="keyword">struct </span><a class="code" href="struct_slot_info.html">SlotInfo</a> {
01024     <span class="comment">// Index in der Slot-Tabelle</span>
<a name="l01025"></a><a class="code" href="struct_slot_info.html#o0">01025</a>     <a class="code" href="group__int__datatypes.html#ga3">Uint8</a> <a class="code" href="struct_slot_info.html#o0">slotIndex</a>;
01026     <span class="comment">// Offset des jeweiligen Records</span>
<a name="l01027"></a><a class="code" href="struct_slot_info.html#o1">01027</a>     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> <a class="code" href="struct_slot_info.html#o1">offset</a>;
01028 };
01029 
<a name="l01030"></a><a class="code" href="_dbj_record_manager_8cpp.html#a1">01030</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_dbj_record_manager_8cpp.html#a1">slotInfoCompare</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *slot1, <span class="keyword">const</span> <span class="keywordtype">void</span> *slot2)
01031 {
01032     <span class="keyword">const</span> <a class="code" href="struct_slot_info.html">SlotInfo</a> *info1 = static_cast&lt;const SlotInfo *&gt;(slot1);
01033     <span class="keyword">const</span> <a class="code" href="struct_slot_info.html">SlotInfo</a> *info2 = static_cast&lt;const SlotInfo *&gt;(slot2);
01034     <span class="keywordflow">return</span> info1-&gt;<a class="code" href="struct_slot_info.html#o1">offset</a> &lt; info2-&gt;<a class="code" href="struct_slot_info.html#o1">offset</a> ? -1 : +1;
01035 }
01036 
01037 
01038 <span class="comment">// reorganisiere Seite</span>
<a name="l01039"></a><a class="code" href="class_dbj_record_manager.html#d9">01039</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d9">DbjRecordManager::reorganizePage</a>(<a class="code" href="class_dbj_page.html">DbjPage</a> *page,
01040         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> &amp;freeSpace, <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> &amp;freeSpaceOffset)
01041 {
01042     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
01043     <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> slotArray[<a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a> + 2];
01044     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> numUsedSlots = 0;
01045     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> prevOffset = 0;
01046     <span class="keywordtype">bool</span> needSort = <span class="keyword">false</span>;
01047     <a class="code" href="struct_slot_info.html">SlotInfo</a> sortArray[<a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a>];
01048 
01049     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01050 
01051     <span class="keywordflow">if</span> (!page) {
01052         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01053         <span class="keywordflow">goto</span> cleanup;
01054     }
01055 
01056     <span class="comment">// kopiere Eintraege der Slot-Tabelle zum Sortieren</span>
01057     slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01058     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>; i--; ) {
01059         <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &gt; 0) {
01060             sortArray[numUsedSlots].<a class="code" href="struct_slot_info.html#o0">slotIndex</a> = i;
01061             sortArray[numUsedSlots].<a class="code" href="struct_slot_info.html#o1">offset</a> = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>;
01062             <span class="keywordflow">if</span> (!needSort &amp;&amp; slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> &lt; prevOffset) {
01063                 needSort = <span class="keyword">true</span>;
01064             }
01065             <span class="keywordflow">else</span> {
01066                 prevOffset = slotArray[numUsedSlots].offset;
01067             }
01068             numUsedSlots++;
01069         }
01070     }
01071 
01072     <span class="comment">// sortiere Array wenn noetig</span>
01073     <span class="keywordflow">if</span> (needSort) {
01074         qsort(sortArray, numUsedSlots, <span class="keyword">sizeof</span>(<a class="code" href="struct_slot_info.html">SlotInfo</a>), <a class="code" href="_dbj_record_manager_8cpp.html#a1">slotInfoCompare</a>);
01075     }
01076 
01077     <span class="comment">// jetzt schieben wir die Daten aller Records an das Ende der Seite</span>
01078     {
01079         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *target = page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + DBJ_PAGE_SIZE;
01080         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> entry = numUsedSlots; entry--; ) {
01081             <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> *slot = &amp;slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[sortArray[entry].<a class="code" href="struct_slot_info.html#o0">slotIndex</a>];
01082             <span class="keywordflow">if</span> (page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> +
01083                     slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> == target) {
01084                 target -= slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>;
01085                 <span class="keywordflow">continue</span>;
01086             }
01087 <span class="preprocessor">#if !defined(DBJ_OPTIMIZE)</span>
01088 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> +
01089                     slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &gt; target) {
01090                 <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01091                 <span class="keywordflow">goto</span> cleanup;
01092             }
01093 <span class="preprocessor">#endif </span><span class="comment">/* DBJ_OPTIMIZE */</span>
01094             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *recordData = page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>() + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>;
01095             <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga9">Uint16</a> i = slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>; i--; ) {
01096                 target--;
01097                 *target = recordData[i];
01098             }
01099             slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = target - page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>();
01100         }
01101 
01102         <span class="comment">// neuen Freiplatz ermitteln</span>
01103         freeSpace = (target - page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>()) -
01104             (<span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) + slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>));
01105         freeSpaceOffset = <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) +
01106             slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>);
01107     }
01108 
01109  cleanup:
01110     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01111 }
01112 
01113 
01114 <span class="comment">// Vergleiche zwei Slots entsprechend des Offsets</span>
<a name="l01115"></a><a class="code" href="_dbj_record_manager_8cpp.html#a2">01115</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_dbj_record_manager_8cpp.html#a2">slotCompare</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *slot1, <span class="keyword">const</span> <span class="keywordtype">void</span> *slot2)
01116 {
01117     <span class="keywordflow">return</span> <a class="code" href="class_dbj_record_manager.html#e1">DbjRecordManager::compareSlotsByOffset</a>(slot1, slot2);
01118 }
01119 
01120 
01121 <span class="comment">// finde groessten zusammenhaengenen Freiplatz in der Seite</span>
<a name="l01122"></a><a class="code" href="class_dbj_record_manager.html#d13">01122</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d13">DbjRecordManager::findLargestFreeSpaceInPage</a>(
01123         <span class="keyword">const</span> <a class="code" href="class_dbj_page.html">DbjPage</a> *page, <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> &amp;maxBlockOffset, <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> &amp;maxBlockSize)
01124 {
01125     <span class="keyword">const</span> <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
01126     <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> slotArray[<a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a> + 2];
01127     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> numUsedSlots = 0;
01128     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> prevOffset = 0;
01129     <span class="keywordtype">bool</span> needSort = <span class="keyword">false</span>;
01130 
01131     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01132 
01133     <span class="keywordflow">if</span> (!page) {
01134         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01135         <span class="keywordflow">goto</span> cleanup;
01136     }
01137 
01138     maxBlockOffset = 0;
01139     maxBlockSize = 0;
01140 
01141     <span class="comment">// kopiere Eintraege der Slot-Tabelle zum Sortieren</span>
01142     slotPage = reinterpret_cast&lt;const SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01143     slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) +
01144         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>); <span class="comment">// 1x extra Slot mit dabei</span>
01145     slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = 0;
01146     numUsedSlots++;
01147     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>; i--; ) {
01148         <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &gt; 0) {
01149             slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a>;
01150             slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> =
01151                 slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>;
01152             <span class="keywordflow">if</span> (!needSort &amp;&amp; slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> &lt; prevOffset) {
01153                 needSort = <span class="keyword">true</span>;
01154             }
01155             <span class="keywordflow">else</span> {
01156                 prevOffset = slotArray[numUsedSlots].offset;
01157             }
01158             numUsedSlots++;
01159         }
01160     }
01161     slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = DBJ_PAGE_SIZE;
01162     slotArray[numUsedSlots].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = 0;
01163     numUsedSlots++;
01164 
01165     <span class="comment">// die Seite ist komplett voll</span>
01166     <span class="keywordflow">if</span> (numUsedSlots == <a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a> + 2) {
01167         maxBlockSize = 0;
01168         maxBlockOffset = 0;
01169         <span class="keywordflow">goto</span> cleanup;
01170     }
01171 
01172     <span class="comment">// sortiere Array wenn noetig</span>
01173     <span class="keywordflow">if</span> (needSort) {
01174         qsort(slotArray, numUsedSlots, <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>), <a class="code" href="_dbj_record_manager_8cpp.html#a2">slotCompare</a>);
01175     }
01176 
01177     <span class="comment">// scanne Array</span>
01178     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = 0; i &lt; numUsedSlots - 1; i++) {
01179         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> gap = slotArray[i+1].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> -
01180             (slotArray[i].offset + slotArray[i].recordLength);
01181         <span class="keywordflow">if</span> (gap &gt; maxBlockSize) {
01182             maxBlockSize = gap;
01183             maxBlockOffset = slotArray[i].offset + slotArray[i].recordLength;
01184         }
01185     }
01186 
01187  cleanup:
01188     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01189 }
01190 
01191 
01192 <span class="comment">// Berechne Freiplatz in der Seite</span>
<a name="l01193"></a><a class="code" href="class_dbj_record_manager.html#d14">01193</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d14">DbjRecordManager::findFreeSpaceInPage</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_page.html">DbjPage</a> *page,
01194         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> &amp;freeSpace)
01195 {
01196     <span class="keyword">const</span> <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
01197     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> usedPageSize = 0;
01198 
01199     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01200 
01201     <span class="keywordflow">if</span> (!page) {
01202         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01203         <span class="keywordflow">goto</span> cleanup;
01204     }
01205 
01206     <span class="comment">// Slot-Tabelle ist voll?</span>
01207     slotPage = reinterpret_cast&lt;const SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01208     <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> &gt;= <a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a>) {
01209         <span class="keywordtype">bool</span> haveEmptySlot = <span class="keyword">false</span>;
01210         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = 0; i &lt; slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>; i++) {
01211             <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> == 0) {
01212                 haveEmptySlot = <span class="keyword">true</span>;
01213                 <span class="keywordflow">break</span>;
01214             }
01215         }
01216 
01217         <span class="comment">// alle Slots sind belegt, also ist auch kein Freiplatz mehr auf der</span>
01218         <span class="comment">// Seite</span>
01219         <span class="keywordflow">if</span> (!haveEmptySlot) {
01220             freeSpace = 0;
01221             <span class="keywordflow">goto</span> cleanup;
01222         }
01223     }
01224 
01225     <span class="comment">// Groesse des Headers und der Slottabelle ermitteln</span>
01226     <span class="comment">// (1x extra Slot ist mit dabei)</span>
01227     usedPageSize = <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a>) +
01228         slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a>);
01229 
01230     <span class="comment">// Platz der einzelnen Records noch einberechnen</span>
01231     <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = 0; i &lt; slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>; i++) {
01232         usedPageSize += slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>;
01233     }
01234     <span class="keywordflow">if</span> (usedPageSize &gt;= DBJ_PAGE_SIZE) {
01235         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01236         <span class="keywordflow">goto</span> cleanup;
01237     }
01238 
01239     freeSpace = DBJ_PAGE_SIZE - usedPageSize;
01240 
01241  cleanup:
01242     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01243 }
01244 
01245 
01246 <span class="comment">// Ermittle ID fuer neue, noch nicht-existierende Seite</span>
<a name="l01247"></a><a class="code" href="class_dbj_record_manager.html#d15">01247</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d15">DbjRecordManager::getNewPageId</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
01248         <a class="code" href="group__id__datatypes.html#ga0">PageId</a> &amp;pageId)
01249 {
01250     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01251     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
01252     <a class="code" href="group__id__datatypes.html#ga0">PageId</a> fsiPageId = 0;
01253     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
01254     <a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html">FsiPage</a> *fsiPage = NULL;
01255     <span class="keywordtype">bool</span> foundEntry = <span class="keyword">false</span>;
01256 
01257     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01258 
01259     <span class="keywordflow">while</span> (!foundEntry) {
01260         <span class="comment">// hole FSI-Seite</span>
01261         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, fsiPageId,
01262                 DbjPage::FreeSpaceInventoryPage, page);
01263         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a70">DBJ_BM_PAGE_NOT_FOUND</a>) {
01264             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01265             <span class="keywordflow">goto</span> cleanup;
01266         }
01267         <span class="keywordflow">if</span> (rc) {
01268             <span class="comment">// FSI-Seite existiert noch nicht</span>
01269             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>); <span class="comment">// Warnung/Fehler zuruecksetzen</span>
01270             <span class="keywordflow">if</span> (fsiPageId &gt;= DBJ_MAX_PAGE_ID) {
01271                 <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a60">DBJ_RM_NO_MORE_PAGES</a>, tableId);
01272                 <span class="keywordflow">goto</span> cleanup;
01273             }
01274             pageId = fsiPageId + 1;
01275             <span class="keywordflow">goto</span> cleanup;
01276         }
01277 
01278         <span class="comment">// einzelnen Eintraege der FSI-Seite durchsuchen</span>
01279         fsiPage = reinterpret_cast&lt;FsiPage *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01280         <span class="keywordflow">if</span> (fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a> &lt; <a class="code" href="class_dbj_record_manager.html#v3">MAX_FSI_ENTRIES</a>) {
01281             <span class="keywordflow">if</span> (fsiPageId &gt; DBJ_MAX_PAGE_ID - (fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a> + 1)) {
01282                 <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a60">DBJ_RM_NO_MORE_PAGES</a>, tableId);
01283                 <span class="keywordflow">goto</span> cleanup;
01284             }
01285             foundEntry = <span class="keyword">true</span>;
01286             pageId = fsiPageId + fsiPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_fsi_page.html#o1">countEntries</a> + 1;
01287         }
01288 
01289         <span class="comment">// alte FSI-Seite freigeben</span>
01290         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01291         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01292             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01293             <span class="keywordflow">goto</span> cleanup;
01294         }
01295 
01296         <span class="comment">// falls Eintrag nicht gefunden, dann gehe auf die naechste FSI-Seite</span>
01297         <span class="keywordflow">if</span> (!foundEntry) {
01298             <span class="keywordflow">if</span> (fsiPageId &gt; DBJ_MAX_PAGE_ID - (<a class="code" href="class_dbj_record_manager.html#v3">MAX_FSI_ENTRIES</a> + 1)) {
01299                 <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a60">DBJ_RM_NO_MORE_PAGES</a>, tableId);
01300                 <span class="keywordflow">goto</span> cleanup;
01301             }
01302             fsiPageId += <a class="code" href="class_dbj_record_manager.html#v3">MAX_FSI_ENTRIES</a> + 1;
01303         }
01304     }
01305 
01306  cleanup:
01307     <span class="keywordflow">if</span> (page != NULL) {
01308         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01309     }
01310     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01311 }
01312 
01313 
01314 <span class="comment">// Finde naechsten Record zur angegebenen Tupel-ID</span>
<a name="l01315"></a><a class="code" href="class_dbj_record_manager.html#d16">01315</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d16">DbjRecordManager::findNextRecord</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId,
01316         <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tupleId)
01317 {
01318     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01319     <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a9">convertTableIdToSegmentId</a>(tableId);
01320     <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
01321     <span class="keywordtype">bool</span> foundRecord = <span class="keyword">false</span>;
01322 
01323     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01324     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Table ID"</span>, tableId);
01325     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page ID"</span>, tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>);
01326     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(3, <span class="stringliteral">"Slot"</span>, tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a>);
01327 
01328     <span class="comment">// Wenn wir den allerersten Record zurueckgeben sollen, dann ist "page"</span>
01329     <span class="comment">// auf 0 gesetzt, was ja eine FSI-Seite sein wuerde</span>
01330     <span class="keywordflow">if</span> (tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a> == 0) {
01331         tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a> = 1;
01332         tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a> = 0;
01333     }
01334     <span class="keywordflow">else</span> {
01335         <span class="keywordflow">if</span> (tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a> &lt; <a class="code" href="class_dbj_record_manager.html#v1">MAX_SLOTS</a>) {
01336             tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a>++;
01337         }
01338         <span class="keywordflow">else</span> {
01339             tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a> = 0;
01340             tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>++;
01341         }
01342     }
01343     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Naechste Seite"</span>, tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>);
01344     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Naechster Slot"</span>, tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a>);
01345 
01346     <span class="comment">// finde eine nicht-leere, existierende Seite</span>
01347     <span class="keywordflow">while</span> (!foundRecord) {
01348         <a class="code" href="struct_dbj_record_manager_1_1_fsi_entry.html">FsiEntry</a> pageInfo;
01349         <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
01350 
01351         <span class="comment">// zunaechst im FSI nachschlagen, ob Seite ueberhaupt belegt ist</span>
01352         rc = <a class="code" href="class_dbj_record_manager.html#d11">findFsiEntry</a>(tableId, tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>, pageInfo);
01353         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a> &amp;&amp;
01354                 rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a55">DBJ_RM_FSI_PAGE_DOES_NOT_EXIST</a> &amp;&amp;
01355                 rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a56">DBJ_RM_NO_FSI_ENTRY_FOR_PAGE</a>) {
01356             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01357             <span class="keywordflow">goto</span> cleanup;
01358         }
01359         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc) {
01360             <span class="comment">// Falls die FSI-Seite nicht existiert, dann sind wir bereits am</span>
01361             <span class="comment">// Ende der Tabelle angelangt.  Das gleich gilt fuer den Fall dass</span>
01362             <span class="comment">// die angefragte Seite im FSI noch nicht vermerkt ist, da die</span>
01363             <span class="comment">// Seiten-Nummern stets fortlaufend und lueckenlos vergeben</span>
01364             <span class="comment">// werden.  (Selbst ein ROLLBACK ist kein Problem, da via Locking</span>
01365             <span class="comment">// die FSI-Seite auch gesperrt ist.)</span>
01366             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a4">DBJ_NOT_FOUND_WARN</a>);
01367             <span class="keywordflow">goto</span> cleanup;
01368         }
01369 
01370         <span class="comment">// Datenseite anfordern und nach ersten nicht-leeren Slot suchen</span>
01371         rc = <a class="code" href="class_dbj_record_manager.html#r1">lockMgr</a>-&gt;<a class="code" href="class_dbj_lock_manager.html#a0">request</a>(segmentId, tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>,
01372                 DbjLockManager::SharedLock);
01373         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01374             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01375             <span class="keywordflow">goto</span> cleanup;
01376         }
01377         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a3">getPage</a>(segmentId, tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>,
01378                 DbjPage::DataPage, page);
01379         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01380             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01381             <span class="keywordflow">goto</span> cleanup;
01382         }
01383 
01384         <span class="comment">// finde naechsten nicht-ausgelagerten Record</span>
01385         slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01386         <span class="keywordflow">for</span> (<a class="code" href="group__int__datatypes.html#ga3">Uint8</a> i = tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a>; i &lt; slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o4">numberOfSlots</a>; i++) {
01387             <span class="keywordflow">if</span> (slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o2">recordType</a> != <a class="code" href="class_dbj_record_manager.html#y3y1">SecondaryRecord</a> &amp;&amp;
01388                     slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o5">recordSlot</a>[i].<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &gt; 0) {
01389                 foundRecord = <span class="keyword">true</span>;
01390                 tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a> = i;
01391                 <span class="keywordflow">break</span>;
01392             }
01393         }
01394         rc = <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01395         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01396             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01397             <span class="keywordflow">goto</span> cleanup;
01398         }
01399 
01400         <span class="comment">// kein Record auf der Seite gefunden - durchsuche naechste Seite</span>
01401         <span class="keywordflow">if</span> (!foundRecord) {
01402             tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>++;
01403             <span class="keywordflow">if</span> (tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a> == <a class="code" href="class_dbj_record_manager.html#d2">getFsiPageId</a>(tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>)) {
01404                 tupleId.<a class="code" href="struct_tuple_id.html#o0">page</a>++;
01405             }
01406             tupleId.<a class="code" href="struct_tuple_id.html#o1">slot</a> = 0;
01407         }
01408     }
01409 
01410  cleanup:
01411     <span class="keywordflow">if</span> (page != NULL) {
01412         <a class="code" href="class_dbj_record_manager.html#r0">bufferMgr</a>-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">releasePage</a>(page);
01413     }
01414     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01415 }
01416 
01417 
01418 <span class="comment">// Bestimme die Stelle an der der Record eingefuegt werden soll (oder neue TID</span>
01419 <span class="comment">// von ausgelagertem Record)</span>
<a name="l01420"></a><a class="code" href="class_dbj_record_manager.html#d20">01420</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_record_manager.html#d20">DbjRecordManager::getRecordOffsetOnPage</a>(<span class="keyword">const</span> <a class="code" href="class_dbj_record.html">DbjRecord</a> &amp;record,
01421         <span class="keyword">const</span> <a class="code" href="group__tableid.html#ga1">TableId</a> tableId, <span class="keyword">const</span> <a class="code" href="struct_tuple_id.html">TupleId</a> tupleId,
01422         <a class="code" href="class_dbj_page.html">DbjPage</a> *page, <a class="code" href="struct_dbj_record_manager_1_1_slot.html">Slot</a> *slot, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;newTupleId)
01423 {
01424     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
01425     <a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html">SlotPageHeader</a> *slotPage = NULL;
01426     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> pageFreeSpace = 0;
01427     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> pageConsecFreeSpace = 0;
01428     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> pageConsecFreeSpaceOffset = 0;
01429     <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> recordLength = record.<a class="code" href="class_dbj_record.html#a2">getLength</a>();
01430 
01431     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
01432 
01433     <span class="keywordflow">if</span> (!page) {
01434         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
01435         <span class="keywordflow">goto</span> cleanup;
01436     }
01437 
01438     <span class="comment">// jeder Record ist mindestens "sizeof(TupleId)" lang</span>
01439     <span class="keywordflow">if</span> (recordLength &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>)) {
01440         recordLength = <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>);
01441     }
01442 
01443     newTupleId = tupleId;
01444     slotPage = reinterpret_cast&lt;SlotPageHeader *&gt;(page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>());
01445     pageFreeSpace = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o1">freeSpace</a>;
01446     pageConsecFreeSpace = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o2">consecFreeSpace</a>;
01447     pageConsecFreeSpaceOffset = slotPage-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot_page_header.html#o3">consecFreeSpaceOffset</a>;
01448 
01449     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &gt;= recordLength) {
01450         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01451         <span class="keywordflow">goto</span> cleanup;
01452     }
01453     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_tuple_id.html">TupleId</a>)) {
01454         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01455         <span class="keywordflow">goto</span> cleanup;
01456     }
01457 
01458     <span class="keywordflow">if</span> (recordLength &lt;= pageConsecFreeSpace) {
01459         <span class="comment">// es ist noch genuegend freier, zusammenhaengender Platz auf der</span>
01460         <span class="comment">// Seite, so dass der Record einfach umkopiert werden kann</span>
01461         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = pageConsecFreeSpaceOffset + pageConsecFreeSpace -
01462             recordLength;
01463     }
01464     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> == pageConsecFreeSpaceOffset &amp;&amp;
01465             recordLength &lt;= slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> + pageConsecFreeSpace) {
01466         <span class="comment">// zu ersetzende Record ist direkt vor dem freien, zusammenhaengenden</span>
01467         <span class="comment">// Bereich und insgesamt ist dort genug Platz -&gt; nichts zu tun</span>
01468     }
01469     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pageConsecFreeSpaceOffset + pageConsecFreeSpace == slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> &amp;&amp;
01470             recordLength &lt;= slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> + pageConsecFreeSpace) {
01471         <span class="comment">// zu ersetzende Record ist direkt hinter dem freien,</span>
01472         <span class="comment">// zusammenhaengenden Bereich und insgesamt ist dort genug Platz</span>
01473         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = pageConsecFreeSpaceOffset +
01474             pageConsecFreeSpace + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> - recordLength;
01475     }
01476     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (recordLength &lt;= pageFreeSpace + slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a>) {
01477         <span class="comment">// es ist insgesamt genuegend freier Platz in der Seite, jedoch nicht</span>
01478         <span class="comment">// zusammenhaengend --&gt; also reorganisieren wir die Seite on-the-fly</span>
01479         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> = 0;
01480         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = 0;
01481         rc = <a class="code" href="class_dbj_record_manager.html#d9">reorganizePage</a>(page, pageConsecFreeSpace,
01482                 pageConsecFreeSpaceOffset);
01483         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01484             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01485             <span class="keywordflow">goto</span> cleanup;
01486         }
01487         pageFreeSpace = pageConsecFreeSpace;
01488         <span class="keywordflow">if</span> (pageConsecFreeSpace &lt; recordLength || slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> != 0 ||
01489                 slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o1">recordLength</a> != 0) {
01490             <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a2">DBJ_INTERNAL_FAIL</a>);
01491             <span class="keywordflow">goto</span> cleanup;
01492         }
01493         slot-&gt;<a class="code" href="struct_dbj_record_manager_1_1_slot.html#o0">offset</a> = pageConsecFreeSpaceOffset + pageConsecFreeSpace -
01494             recordLength;
01495     }
01496     <span class="keywordflow">else</span> {
01497         <span class="comment">// nun ist wirklich nicht genuegend Platz, und der Record muss auf</span>
01498         <span class="comment">// eine andere Seite ausgelagert werden; auf der aktuellen Seite wird</span>
01499         <span class="comment">// nun eine Stellvertreter-TID anstatt des Records hinterlegt (den</span>
01500         <span class="comment">// letzten Teil erledigt der Aufrufer)</span>
01501         rc = <a class="code" href="class_dbj_record_manager.html#a2">insert</a>(record, tableId, <a class="code" href="class_dbj_record_manager.html#y3y1">SecondaryRecord</a>, newTupleId);
01502         <span class="keywordflow">if</span> (rc != <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>) {
01503             <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
01504             <span class="keywordflow">goto</span> cleanup;
01505         }
01506     }
01507 
01508  cleanup:
01509     <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
01510 }
01511 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:30 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
