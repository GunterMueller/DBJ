<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjFileManager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjFileManager.cpp</h1><a href="_dbj_file_manager_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************\</span>
00002 <span class="comment"> *                                                                       *</span>
00003 <span class="comment"> * (C) 2004-2005                                                         *</span>
00004 <span class="comment"> * Lehrstuhl fuer Datenbanken und Informationssysteme                    *</span>
00005 <span class="comment"> * Friedrich-Schiller-Universitaet Jena                                  *</span>
00006 <span class="comment"> * Ernst-Abbe-Platz 1-2                                                  *</span>
00007 <span class="comment"> * 07745 Jena                                                            *</span>
00008 <span class="comment"> *                                                                       *</span>
00009 <span class="comment">\*************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include &lt;fstream&gt;</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="_dbj_file_manager_8hpp.html">DbjFileManager.hpp</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="_dbj_config_8hpp.html">DbjConfig.hpp</a>"</span>
00015 
00016 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00017 
<a name="l00018"></a><a class="code" href="_dbj_file_manager_8cpp.html#a0">00018</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="_dbj_file_manager_8cpp.html#a0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a10">FileManager</a>;
00019 
00020 <span class="comment">// Instanzvariable des File Managers</span>
<a name="l00021"></a><a class="code" href="class_dbj_file_manager.html#v0">00021</a> <a class="code" href="class_dbj_file_manager.html">DbjFileManager</a> *<a class="code" href="class_dbj_file_manager.html#v0">DbjFileManager::instance</a> = NULL;
00022 
00023 
00024 <span class="comment">// Destruktor</span>
<a name="l00025"></a><a class="code" href="class_dbj_file_manager.html#d1">00025</a> <a class="code" href="class_dbj_file_manager.html#d1">DbjFileManager::~DbjFileManager</a>()
00026 {
00027     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00028 
00029     <span class="comment">// schliesse alle noch geoeffneten Dateien</span>
00030     <span class="keywordflow">for</span> (<a class="code" href="class_dbj_file_manager.html#y1">FileListIterator</a> iter = <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.begin(); iter != <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.end();
00031              iter++) {
00032         <span class="keywordflow">if</span> (iter-&gt;segmentId != 0) {
00033             fstream *f = static_cast&lt;fstream *&gt;(iter-&gt;handle);
00034             f-&gt;close();
00035             <span class="keyword">delete</span> f;
00036         }
00037     }
00038     <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.clear();
00039 
00040     <a class="code" href="class_dbj_file_manager.html#v0">instance</a> = NULL;
00041 }
00042 
00043 
00044 <span class="comment">// Erzeuge eine neue Datei</span>
<a name="l00045"></a><a class="code" href="class_dbj_file_manager.html#a0">00045</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_file_manager.html#a0">DbjFileManager::create</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segment)
00046 {
00047     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00048     <span class="keyword">const</span> <span class="keywordtype">char</span> *file = NULL;
00049 
00050     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00051     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"SegmentId"</span>, segment);
00052 
00053     <span class="comment">// Datei ist bereits geoeffnet</span>
00054     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_file_manager.html#d4">findFileInList</a>(segment) != <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.end()) {
00055         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a81">DBJ_FM_FILE_ALREADY_EXISTS</a>, segment);
00056         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00057         <span class="keywordflow">goto</span> cleanup;
00058     }
00059 
00060     file = <a class="code" href="class_dbj_file_manager.html#d3">getFileName</a>(segment);
00061     <span class="keywordflow">if</span> (!file) {
00062         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00063         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00064         <span class="keywordflow">goto</span> cleanup;
00065     }
00066 
00067     <span class="comment">// Datei existiert noch nicht -&gt; anlegen</span>
00068     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_file_manager.html#d2">exists</a>(file)) {
00069         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a81">DBJ_FM_FILE_ALREADY_EXISTS</a>, segment);
00070         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00071         <span class="keywordflow">goto</span> cleanup;
00072     }
00073 
00074     {
00075         fstream f;
00076         f.open(file, fstream::out);
00077         <span class="keywordflow">if</span> (!f.good()) {
00078             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a85">DBJ_FM_FILE_CREATE_FAIL</a>, segment);
00079             rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00080         }
00081         f.close();
00082     }
00083 
00084  cleanup:
00085     <span class="keywordflow">return</span> rc;
00086 }
00087 
00088 
00089 <span class="comment">// Loeschen einer bereits existierenden Datei und entfernen aus der lokalen</span>
00090 <span class="comment">// Verwaltungsliste</span>
<a name="l00091"></a><a class="code" href="class_dbj_file_manager.html#a1">00091</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_file_manager.html#a1">DbjFileManager::drop</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segment)
00092 {
00093     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00094     <span class="keyword">const</span> <span class="keywordtype">char</span> *file = NULL;
00095 
00096     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00097     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"SegmentId"</span>, segment);
00098 
00099     <span class="comment">// Datei ist noch geoeffnet</span>
00100     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_file_manager.html#d4">findFileInList</a>(segment) != <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.end()) {
00101         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a83">DBJ_FM_FILE_STILL_OPEN</a>, segment);
00102         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00103         <span class="keywordflow">goto</span> cleanup;
00104     }
00105 
00106     file = <a class="code" href="class_dbj_file_manager.html#d3">getFileName</a>(segment);
00107     <span class="keywordflow">if</span> (!file) {
00108         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00109         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00110         <span class="keywordflow">goto</span> cleanup;
00111     }
00112 
00113     <span class="comment">// Datei existiert noch nicht</span>
00114     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_file_manager.html#d2">exists</a>(file)) {
00115         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a80">DBJ_FM_FILE_NOT_FOUND</a>, segment);
00116         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00117         <span class="keywordflow">goto</span> cleanup;
00118     }
00119 
00120     <span class="comment">// Datei loeschen</span>
00121     <span class="keywordflow">if</span> (remove(file) != 0) {
00122         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a86">DBJ_FM_FILE_DROP_FAIL</a>, segment);
00123         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00124         <span class="keywordflow">goto</span> cleanup;
00125     }
00126 
00127  cleanup:
00128     <span class="keywordflow">return</span> rc;
00129 }
00130 
00131 
00132 <span class="comment">// Oeffnen einer bereits existierenden Datei</span>
<a name="l00133"></a><a class="code" href="class_dbj_file_manager.html#a2">00133</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_file_manager.html#a2">DbjFileManager::open</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segment)
00134 {
00135     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00136     <span class="keyword">const</span> <span class="keywordtype">char</span> *file = NULL;
00137     fstream *f = NULL;
00138 
00139     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00140     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"SegmentId"</span>, segment);   
00141 
00142     file = <a class="code" href="class_dbj_file_manager.html#d3">getFileName</a>(segment);
00143     <span class="keywordflow">if</span> (!file) {
00144         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00145         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00146         <span class="keywordflow">goto</span> cleanup;
00147     }
00148 
00149     <span class="comment">// Datei muss existieren</span>
00150     <span class="keywordflow">if</span> (!<a class="code" href="class_dbj_file_manager.html#d2">exists</a>(file)) {
00151         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a80">DBJ_FM_FILE_NOT_FOUND</a>, segment);
00152         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00153         <span class="keywordflow">goto</span> cleanup;
00154     }
00155 
00156     <span class="comment">// Datei bereits geoeffnet ?</span>
00157     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_file_manager.html#d4">findFileInList</a>(segment) != <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.end()) {
00158         <span class="keywordflow">goto</span> cleanup;
00159     }
00160 
00161     <span class="comment">// Datei oeffnen</span>
00162     f = <span class="keyword">new</span> fstream;
00163     <span class="keywordflow">if</span> (!f) {
00164         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00165         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00166         <span class="keywordflow">goto</span> cleanup;
00167     }
00168     f-&gt;open(file, fstream::in | fstream::out | fstream::binary);
00169     <span class="keywordflow">if</span> (!f-&gt;good()) {
00170         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a87">DBJ_FM_FILE_OPEN_FAIL</a>, segment);
00171         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00172         <span class="keywordflow">goto</span> cleanup;
00173     }
00174 
00175     <span class="comment">// Trage Datei in Liste der geoeffneten Dateien ein</span>
00176     {
00177         <a class="code" href="struct_dbj_file_manager_1_1_file_segment.html">FileSegment</a> entry;
00178         entry.<a class="code" href="struct_dbj_file_manager_1_1_file_segment.html#o0">segmentId</a> = segment;
00179         entry.<a class="code" href="struct_dbj_file_manager_1_1_file_segment.html#o1">handle</a> = f;
00180         f = NULL;
00181 
00182         <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.insert(entry);
00183     }
00184 
00185  cleanup:
00186     <span class="keyword">delete</span> f;
00187     <span class="keywordflow">return</span> rc;
00188 }
00189 
00190 
00191 <span class="comment">// Schliessen einer bereits geoeffneten Datei</span>
<a name="l00192"></a><a class="code" href="class_dbj_file_manager.html#a3">00192</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_file_manager.html#a3">DbjFileManager::close</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segment)
00193 {
00194     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00195     <a class="code" href="class_dbj_file_manager.html#y1">FileListIterator</a> iter;
00196 
00197     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00198     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Segment ID"</span>, segment);
00199 
00200     iter = <a class="code" href="class_dbj_file_manager.html#d4">findFileInList</a>(segment);
00201     <span class="keywordflow">if</span> (iter == <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.end()) {
00202         <span class="keywordflow">goto</span> cleanup;
00203     }
00204 
00205     {
00206         fstream *f = static_cast&lt;fstream *&gt;(iter-&gt;handle);
00207         f-&gt;close();
00208         <span class="keywordflow">if</span> (!f-&gt;good()) {
00209             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a88">DBJ_FM_FILE_CLOSE_FAIL</a>, segment);
00210             rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00211         }
00212         <span class="keyword">delete</span> f;
00213     }
00214 
00215     <a class="code" href="class_dbj_file_manager.html#r0">openFiles</a>.erase(iter);
00216 
00217  cleanup:
00218     <span class="keywordflow">return</span> rc;
00219 }
00220 
00221 <span class="comment">// Lies Seite direkt aus Datei aus</span>
<a name="l00222"></a><a class="code" href="class_dbj_file_manager.html#a4">00222</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_file_manager.html#a4">DbjFileManager::read</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segment,
00223         <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buffer)
00224 {
00225     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00226     fstream *f = NULL;
00227 
00228     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00229     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Segment"</span>, segment);
00230     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page"</span>, pageId);
00231 
00232     <span class="keywordflow">if</span> (!buffer) {
00233         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00234         <span class="keywordflow">goto</span> cleanup;
00235     }
00236 
00237     <span class="comment">// Hole "fstream" der Datei (gibt NULL wenn Datei noch nicht offen)</span>
00238     f = static_cast&lt;fstream *&gt;(<a class="code" href="class_dbj_file_manager.html#d5">getFileHandle</a>(segment));
00239     <span class="keywordflow">if</span> (f == NULL) {
00240         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a82">DBJ_FM_FILE_NOT_OPEN</a>, segment);
00241         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00242         <span class="keywordflow">goto</span> cleanup;
00243     }
00244 
00245     <span class="comment">// Ermittle, ob Seite ueberhaupt in der Datei existiert</span>
00246     {
00247         fstream::pos_type length = 0;
00248         f-&gt;seekg(0, fstream::end);
00249         length = f-&gt;tellg();
00250         <span class="keywordflow">if</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length) % DBJ_PAGE_SIZE != 0) {
00251             <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a92">DBJ_FM_FILE_INVALID_SIZE</a>, segment,
00252                     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length), DBJ_PAGE_SIZE);
00253             rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00254             <span class="keywordflow">goto</span> cleanup;
00255         }
00256 
00257         <span class="keywordflow">if</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length) &lt; (pageId+1) * DBJ_PAGE_SIZE) {
00258             <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a84">DBJ_FM_PAGE_NOT_EXISTS</a>, pageId, segment,
00259                     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length) / DBJ_PAGE_SIZE);
00260             rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00261             <span class="keywordflow">goto</span> cleanup;
00262         }
00263     }
00264 
00265     <span class="comment">// Lies Seite in Puffer, der vom Aufrufer kommt</span>
00266     f-&gt;seekg(pageId * DBJ_PAGE_SIZE, fstream::beg);
00267     f-&gt;read(reinterpret_cast&lt;char *&gt;(buffer), DBJ_PAGE_SIZE);
00268     <span class="keywordflow">if</span> (!f-&gt;good()) {
00269         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a89">DBJ_FM_FILE_READ_FAIL</a>, segment);
00270         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00271         <span class="keywordflow">goto</span> cleanup;
00272     }
00273 
00274  cleanup:
00275     <span class="keywordflow">return</span> rc;
00276 }
00277 
00278 
00279 <span class="comment">// Schreibe Seite direkt in die Datei</span>
<a name="l00280"></a><a class="code" href="class_dbj_file_manager.html#a5">00280</a> <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> <a class="code" href="class_dbj_file_manager.html#a5">DbjFileManager::write</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segment,
00281         <span class="keyword">const</span> <a class="code" href="group__id__datatypes.html#ga0">PageId</a> pageId, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buffer)
00282 {
00283     <a class="code" href="_dbj_error_codes_8hpp.html#a107">DbjErrorCode</a> rc = <a class="code" href="_dbj_error_codes_8hpp.html#a107a1">DBJ_SUCCESS</a>;
00284     fstream *f = NULL;
00285 
00286     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00287     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Segment"</span>, segment);
00288     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(2, <span class="stringliteral">"Page"</span>, pageId);
00289 
00290     <span class="keywordflow">if</span> (!buffer) {
00291         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00292         <span class="keywordflow">goto</span> cleanup;
00293     }
00294 
00295     <span class="comment">// Hole "fstream" der Datei (gibt NULL wenn Datei noch nicht offen)</span>
00296     f = static_cast&lt;fstream *&gt;(<a class="code" href="class_dbj_file_manager.html#d5">getFileHandle</a>(segment));
00297     <span class="keywordflow">if</span> (f == NULL) {
00298         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a82">DBJ_FM_FILE_NOT_OPEN</a>, segment);
00299         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00300         <span class="keywordflow">goto</span> cleanup;
00301     }
00302 
00303     <span class="comment">// Ermittle, ob Datei lang genug ist und verlaengere bei Bedarf</span>
00304     {
00305         <span class="keywordtype">char</span> emptyPage[DBJ_PAGE_SIZE] = { 0x00 };
00306         fstream::pos_type length = 0;
00307         f-&gt;seekp(0, fstream::end);
00308         length = f-&gt;tellp();
00309         <span class="keywordflow">if</span> (<a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length) % DBJ_PAGE_SIZE != 0) {
00310             <a class="code" href="_dbj_error_8hpp.html#a4">DBJ_SET_ERROR_TOKEN3</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a92">DBJ_FM_FILE_INVALID_SIZE</a>, segment,
00311                     <a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length), DBJ_PAGE_SIZE);
00312             rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00313             <span class="keywordflow">goto</span> cleanup;
00314         }
00315 
00316         <span class="keywordflow">for</span> (<a class="code" href="group__id__datatypes.html#ga0">PageId</a> i = <a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(length) / DBJ_PAGE_SIZE; i &lt; pageId; i++) {
00317             f-&gt;write(emptyPage, DBJ_PAGE_SIZE);
00318         }
00319         <span class="keywordflow">if</span> (!f-&gt;good()) {
00320             <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a90">DBJ_FM_FILE_WRITE_FAIL</a>, segment);
00321             rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00322             <span class="keywordflow">goto</span> cleanup;
00323         }
00324     }
00325 
00326     <span class="comment">// Schreibe gegebene Seite</span>
00327     f-&gt;seekp(pageId * DBJ_PAGE_SIZE, fstream::beg);
00328     f-&gt;write(reinterpret_cast&lt;const char *&gt;(buffer), DBJ_PAGE_SIZE);
00329     <span class="keywordflow">if</span> (!f-&gt;good()) {
00330         <a class="code" href="_dbj_error_8hpp.html#a2">DBJ_SET_ERROR_TOKEN1</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a90">DBJ_FM_FILE_WRITE_FAIL</a>, segment);
00331         rc = <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00332         <span class="keywordflow">goto</span> cleanup;
00333     }
00334 
00335  cleanup:
00336     <span class="keywordflow">return</span> rc;
00337 }
00338 
00339 
00340 <span class="comment">// existiert diese Datei ueberhaupt schon?</span>
<a name="l00341"></a><a class="code" href="class_dbj_file_manager.html#d2">00341</a> <span class="keywordtype">bool</span> <a class="code" href="class_dbj_file_manager.html#d2">DbjFileManager::exists</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file)<span class="keyword"> const</span>
00342 <span class="keyword"></span>{
00343     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00344 
00345     <span class="keywordflow">if</span> (!file) {
00346         <a class="code" href="_dbj_error_8hpp.html#a1">DBJ_SET_ERROR</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a3">DBJ_PARAMETER_FAIL</a>);
00347         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00348     }
00349     <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(0, file);
00350 
00351     fstream fs;
00352     fs.open(file, fstream::in);
00353     <span class="keywordflow">if</span> (!fs) {
00354         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00355     }
00356     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00357 }
00358 
00359 
00360 <span class="comment">// generiere Dateinamen fuer Segment</span>
<a name="l00361"></a><a class="code" href="class_dbj_file_manager.html#d3">00361</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="class_dbj_file_manager.html#d3">DbjFileManager::getFileName</a>(<span class="keyword">const</span> <a class="code" href="group__tableid.html#ga0">SegmentId</a> segmentId)
00362 {
00363     <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00364     <a class="code" href="group__trace__def.html#ga6">DBJ_TRACE_NUMBER</a>(1, <span class="stringliteral">"Segment ID"</span>, segmentId);
00365 
00366     <span class="keywordflow">if</span> (<a class="code" href="class_dbj_file_manager.html#r2">segmentOffset</a> == 0) {
00367         <a class="code" href="group__int__datatypes.html#ga15">Uint32</a> maxLength = 0;
00368         <span class="keyword">const</span> <span class="keywordtype">char</span> *dbPath = getenv(<span class="stringliteral">"DBJ_DATABASE_PATH"</span>);
00369         <span class="keywordflow">if</span> (dbPath == NULL) {
00370             dbPath = DBJ_DEFAULT_DATABASE_PATH;
00371         }
00372         <a class="code" href="group__memory__functions.html#ga6">DbjMemSet</a>(<a class="code" href="class_dbj_file_manager.html#r1">fileName</a>, <span class="charliteral">'\0'</span>, <span class="keyword">sizeof</span> <a class="code" href="class_dbj_file_manager.html#r1">fileName</a>);
00373         maxLength = <span class="keyword">sizeof</span>(fileName) - 10 - <a class="code" href="group__system__macros.html#ga2">DBJ_DIGITS_OF_TYPE</a>(<a class="code" href="group__int__datatypes.html#ga15">Uint32</a>);
00374         <span class="keywordflow">if</span> (strlen(dbPath) &gt; maxLength) {
00375             <a class="code" href="_dbj_error_8hpp.html#a3">DBJ_SET_ERROR_TOKEN2</a>(<a class="code" href="_dbj_error_codes_8hpp.html#a107a91">DBJ_FM_PATH_TOO_LONG</a>, dbPath, maxLength);
00376             <span class="keywordflow">return</span> NULL;
00377         }
00378         <a class="code" href="class_dbj_file_manager.html#r2">segmentOffset</a> = sprintf(fileName, <span class="stringliteral">"%s/Seg"</span>, dbPath ? dbPath : <span class="stringliteral">"."</span>);
00379 
00380         <span class="keywordflow">if</span> (fileName[<a class="code" href="class_dbj_file_manager.html#r2">segmentOffset</a>-5] == <span class="charliteral">'/'</span>) {
00381             sprintf(fileName + <a class="code" href="class_dbj_file_manager.html#r2">segmentOffset</a> - 5, <span class="stringliteral">"/Seg"</span>);
00382             segmentOffset--;
00383         }
00384     }
00385 
00386     sprintf(<a class="code" href="class_dbj_file_manager.html#r1">fileName</a> + <a class="code" href="class_dbj_file_manager.html#r2">segmentOffset</a>, <a class="code" href="group__string__def.html#ga12">DBJ_FORMAT_UINT32</a> <span class="stringliteral">".dbj"</span>,
00387             <a class="code" href="group__int__datatypes.html#ga15">Uint32</a>(segmentId));
00388     <a class="code" href="group__trace__def.html#ga7">DBJ_TRACE_STRING</a>(10, <a class="code" href="class_dbj_file_manager.html#r1">fileName</a>);
00389     <span class="keywordflow">return</span> <a class="code" href="class_dbj_file_manager.html#r1">fileName</a>;
00390 }
00391 
00392 
00393 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 4 15:40:29 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
