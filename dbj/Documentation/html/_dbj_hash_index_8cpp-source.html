<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Jenas Datenbanksystem &apos;System J&apos;: DbjHashIndex.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>DbjHashIndex.cpp</h1><a href="_dbj_hash_index_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="_dbj_8hpp.html">Dbj.hpp</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="_dbj_page_8hpp.html">DbjPage.hpp</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="_dbj_buffer_manager_8hpp.html">DbjBufferManager.hpp</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="_dbj_index_manager_8hpp.html">DbjIndexManager.hpp</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="_dbj_index_wrapper_8hpp.html">DbjIndexWrapper.hpp</a>"</span>
00006 
<a name="l00007"></a><a class="code" href="_dbj_hash_index_8cpp.html#a0">00007</a> <span class="preprocessor">#define BUCKET_SIZE 10</span>
00008 <span class="preprocessor"></span>
00009 
00010 
00011 
<a name="l00015"></a><a class="code" href="class_dbj_hash_index.html">00015</a> <span class="keyword">class </span><a class="code" href="class_dbj_hash_index.html">DbjHashIndex</a> : <span class="keyword">public</span> <a class="code" href="class_dbj_index_wrapper.html">DbjIndexWrapper</a> {
00016     <span class="keyword">public</span>:
<a name="l00022"></a><a class="code" href="class_dbj_hash_index.html#a0">00022</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#a0">find</a>(<a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> *key, <a class="code" href="struct_tuple_id.html">TupleId</a> &amp;tid) {
00023                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00024                 
00025                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00026                 <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header = NULL;
00027                 <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets = NULL;
00028                 <a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a> *bucket = NULL;
00029                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> pageId = 0;
00030                 
00031                 <span class="comment">// Wurzelseite ermitteln</span>
00032                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a4">getRootPageId</a>(&amp;pageId);
00033                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00034                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00035                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00036                 }
00037 
00038                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> hash = <a class="code" href="class_dbj_hash_index.html#d8">computeHash</a>(key);
00039                 <span class="keywordflow">do</span> {
00040                         <span class="comment">// lade Hash</span>
00041                         error = <a class="code" href="class_dbj_hash_index.html#d3">getBuckets</a>(pageId, header, buckets);
00042                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00043                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00044                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00045                         }
00046                         
00047                         <span class="comment">// Schluessel suchen</span>
00048                         bucket = &amp;buckets-&gt;<a class="code" href="struct_dbj_hash_index_1_1_buckets.html#o0">bucket</a>[hash];
00049                         
00050                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a>; i++) {
00051                                 <span class="keywordflow">if</span>(bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o1">key</a>[i] == (*key)) {
00052                                         tid = bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o2">tupleId</a>[i];
00053                                         
00054                                         <span class="keywordflow">break</span>;
00055                                 }
00056                         }
00057                         
00058                         <span class="comment">// naechstes Hash laden, falls noetig</span>
00059                         <span class="keywordflow">if</span>((&amp;tid) == NULL &amp;&amp; bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a> == <a class="code" href="_dbj_hash_index_8cpp.html#a0">BUCKET_SIZE</a>) {
00060                                 pageId = header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o1">nextHashSegment</a>;
00061                         } <span class="keywordflow">else</span> {
00062                                 pageId = 0;
00063                         }
00064                         
00065                         <span class="comment">// Hash freigeben</span>
00066                         error = <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(header);
00067                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00068                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00069                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00070                         }
00071                 } <span class="keywordflow">while</span>(pageId != 0);
00072                 
00073                 
00074                 <span class="keywordflow">if</span>((&amp;tid) != NULL) {
00075                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00076                 } <span class="keywordflow">else</span> {
00077                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a60">DBJ_IM_KEY_NOT_FOUND</a>;
00078                 }
00079         }
00080 
<a name="l00084"></a><a class="code" href="class_dbj_hash_index.html#a1">00084</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#a1">findRange</a>(<a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> *startKey, <a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> *stopKey, <a class="code" href="class_dbj_index_iterator.html">DbjIndexIterator</a> *&amp;iter) {
00085                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a61">DBJ_IM_ITERATOR_NOT_SUPPORTED</a>;
00086         }
00087 
<a name="l00093"></a><a class="code" href="class_dbj_hash_index.html#a2">00093</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#a2">insert</a>(<a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> * <span class="keyword">const</span> key, <a class="code" href="struct_tuple_id.html">TupleId</a> <span class="keyword">const</span> &amp;tid) {
00094                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00095                 
00096                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00097                 <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header = NULL;
00098                 <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets = NULL;
00099                 <a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a> *bucket = NULL;
00100                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> pageId = 0;
00101                 <a class="code" href="struct_tuple_id.html">TupleId</a> *<a class="code" href="1_8cpp.html#a0">exists</a> = NULL;                 <span class="comment">// nur zum Testen, ob Schluessel schon vorhanden ist</span>
00102                 
00103                 <span class="comment">// Wurzelseite ermitteln</span>
00104                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a4">getRootPageId</a>(&amp;pageId);
00105                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00106                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00107                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00108                 }
00109                 
00110                 <span class="comment">// Nachgucken, ob Schlueseel bei eindeutigem Index schon vorhanden</span>
00111                 <span class="keywordflow">if</span>(<a class="code" href="class_dbj_hash_index.html#a4">isUnique</a>() &amp;&amp; ((error = <a class="code" href="class_dbj_hash_index.html#a0">find</a>(key, *<a class="code" href="1_8cpp.html#a0">exists</a>)) == <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>)) {
00112                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a62">DBJ_IM_KEY_EXISTS</a>;
00113                 }
00114                                 
00115                 <span class="comment">// Schluessel einfuegen</span>
00116                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> hash = <a class="code" href="class_dbj_hash_index.html#d8">computeHash</a>(key);
00117                 <span class="keywordflow">do</span> {
00118                         <span class="keywordtype">bool</span> changedBuckets = <span class="keyword">false</span>;
00119                         
00120                         <span class="comment">// Hash laden</span>
00121                         error = <a class="code" href="class_dbj_hash_index.html#d3">getBuckets</a>(pageId, header, buckets);
00122                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00123                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00124                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00125                         }
00126                         
00127                         <span class="comment">// pruefen, ob schluessel passt und ggfs. einfuegen</span>
00128                         bucket = &amp;buckets-&gt;<a class="code" href="struct_dbj_hash_index_1_1_buckets.html#o0">bucket</a>[hash];
00129 
00130                         <span class="keywordflow">if</span>(bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a> &lt; <a class="code" href="_dbj_hash_index_8cpp.html#a0">BUCKET_SIZE</a>) {
00131                                 bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o1">key</a>[bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a>] = *key;
00132                                 bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o2">tupleId</a>[bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a>] = tid;
00133                                 bucket-&gt;<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a>++;
00134                                 
00135                                 changedBuckets = <span class="keyword">true</span>;
00136                                 pageId = 0;
00137                         } <span class="keywordflow">else</span> {
00138                                 <span class="keywordflow">if</span>(header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o1">nextHashSegment</a> != 0) {
00139                                         pageId = header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o1">nextHashSegment</a>;
00140                                 } <span class="keywordflow">else</span> {
00141                                         <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *newHeader = NULL;
00142                                         <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *newBuckets = NULL;
00143                                         
00144                                         <span class="comment">// neue Buckets erzeugen</span>
00145                                         error = <a class="code" href="class_dbj_hash_index.html#d4">createBuckets</a>(header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o2">unique</a>, newHeader, newBuckets);
00146                                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00147                                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00148                                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00149                                         }
00150                                         
00151                                         changedBuckets = <span class="keyword">true</span>;
00152                                         pageId = newHeader-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a>;
00153                                 }
00154                         }
00155                         
00156                         <span class="comment">// Hash speichern?</span>
00157                         <span class="keywordflow">if</span>(changedBuckets) {
00158                                 error = <a class="code" href="class_dbj_hash_index.html#d7">saveBuckets</a>(header);
00159                                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00160                                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00161                                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00162                                 }
00163                         }
00164                         
00165                         <span class="comment">// Hash freigeben</span>
00166                         error = <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(header);
00167                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00168                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00169                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00170                         }
00171                 } <span class="keywordflow">while</span>(pageId != 0);
00172                 
00173                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00174         }
00175 
<a name="l00180"></a><a class="code" href="class_dbj_hash_index.html#a3">00180</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#a3">remove</a>(<a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> * <span class="keyword">const</span> key, <a class="code" href="struct_tuple_id.html">TupleId</a> <span class="keyword">const</span> * <span class="keyword">const</span> tid = NULL) {
00181                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00182                 
00183                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00184                 <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header = NULL;
00185                 <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets = NULL;
00186                 <a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a> *bucket = NULL;
00187                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> pageId = 0;
00188                 
00189                 <span class="comment">// Wurzelseite ermitteln</span>
00190                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a4">getRootPageId</a>(&amp;pageId);
00191                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00192                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00193                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00194                 }
00195                 
00196                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> hash = <a class="code" href="class_dbj_hash_index.html#d8">computeHash</a>(key);
00197                 <span class="keywordflow">do</span> {
00198                         <span class="comment">// lade Hash</span>
00199                         error = <a class="code" href="class_dbj_hash_index.html#d3">getBuckets</a>(pageId, header, buckets);
00200                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00201                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00202                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00203                         }
00204                         
00205                         <span class="comment">// Schluessel loeschen</span>
00206                         <span class="comment">// naechstes Hash durchsuchen           </span>
00207                         
00208                         <span class="comment">// Hash freigeben</span>
00209                         error = <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(header);
00210                         <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00211                                 <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00212                                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00213                         }
00214                 } <span class="keywordflow">while</span>(pageId != 0);
00215                 
00216                 
00217                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00218         }
00219         
<a name="l00223"></a><a class="code" href="class_dbj_hash_index.html#a4">00223</a>         <span class="keywordtype">bool</span> <a class="code" href="class_dbj_hash_index.html#a4">isUnique</a>() {
00224                 <span class="keywordflow">return</span> <a class="code" href="class_dbj_hash_index.html#r0">unique</a>;
00225         }
00226 
<a name="l00230"></a><a class="code" href="class_dbj_hash_index.html#a5">00230</a>         <a class="code" href="group__datatypes.html#ga1">DbjIndexType</a> <a class="code" href="class_dbj_hash_index.html#a5">getIndexType</a>() {
00231                 <span class="keywordflow">return</span> <a class="code" href="group__datatypes.html#gga1a36">Hash</a>;
00232         }
00233         
<a name="l00237"></a><a class="code" href="class_dbj_hash_index.html#a6">00237</a>         <span class="keywordtype">void</span> <a class="code" href="class_dbj_hash_index.html#a6">notifyCommit</a>() {}
00238 
<a name="l00242"></a><a class="code" href="class_dbj_hash_index.html#a7">00242</a>         <span class="keywordtype">void</span> <a class="code" href="class_dbj_hash_index.html#a7">notifyRollback</a>() {}
00243 
00244     <span class="keyword">private</span>:
<a name="l00248"></a><a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">00248</a>         <span class="keyword">struct </span><a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> {
<a name="l00249"></a><a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">00249</a>                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a>;
<a name="l00250"></a><a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o1">00250</a>                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o1">nextHashSegment</a>;
<a name="l00251"></a><a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o2">00251</a>                 <span class="keywordtype">bool</span> <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o2">unique</a>;
00252         };
00253         
<a name="l00257"></a><a class="code" href="struct_dbj_hash_index_1_1_bucket.html">00257</a>         <span class="keyword">struct </span><a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a> {
<a name="l00258"></a><a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">00258</a>                 <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> <a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a>;
<a name="l00259"></a><a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o1">00259</a>                 <a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o1">key</a>[<a class="code" href="_dbj_hash_index_8cpp.html#a0">BUCKET_SIZE</a>];
<a name="l00260"></a><a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o2">00260</a>                 <a class="code" href="struct_tuple_id.html">TupleId</a> <a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o2">tupleId</a>[<a class="code" href="_dbj_hash_index_8cpp.html#a0">BUCKET_SIZE</a>];
00261         };
00262         
<a name="l00263"></a><a class="code" href="struct_dbj_hash_index_1_1_buckets.html">00263</a>         <span class="keyword">struct </span><a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> {
<a name="l00264"></a><a class="code" href="struct_dbj_hash_index_1_1_buckets.html#o0">00264</a>                 <a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a> <a class="code" href="struct_dbj_hash_index_1_1_buckets.html#o0">bucket</a>[((DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a>)) / <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a>))];
00265         };
00266         
<a name="l00267"></a><a class="code" href="class_dbj_hash_index.html#r0">00267</a>         <span class="keywordtype">bool</span> <a class="code" href="class_dbj_hash_index.html#r0">unique</a>;
<a name="l00268"></a><a class="code" href="class_dbj_hash_index.html#v0">00268</a>         <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="_dbj_components_8hpp.html#a12">DbjComponent</a> <a class="code" href="class_dbj_hash_index.html#v0">componentId</a> = <a class="code" href="_dbj_components_8hpp.html#a12a7">IndexManager</a>;
00269 
<a name="l00273"></a><a class="code" href="class_dbj_hash_index.html#d0">00273</a>         <a class="code" href="class_dbj_hash_index.html#d0">DbjHashIndex</a>(<a class="code" href="group__tableid.html#ga5">IndexId</a> idxId, <span class="keywordtype">bool</span> uniq) : <a class="code" href="class_dbj_hash_index.html#r0">unique</a>(uniq) {
00274                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00275                 
00276                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00277                 <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header = NULL;
00278                 <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets = NULL;
00279                 
00280                 <span class="comment">// Werte setzen</span>
00281                 <a class="code" href="class_dbj_index_wrapper.html#b0">setIndexId</a>(idxId, <span class="keyword">true</span>);
00282                 
00283                 <span class="comment">// Ersten Bucket erzeugen</span>
00284                 error = <a class="code" href="class_dbj_hash_index.html#d4">createBuckets</a>(<a class="code" href="class_dbj_hash_index.html#r0">unique</a>, header, buckets);
00285                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00286                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00287                         <span class="comment">// return DbjGetErrorCode();</span>
00288                 }
00289                 
00290                 <span class="comment">// verwendete Seite als Wurzelseite setzen</span>
00291                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a5">setRootPageId</a>(header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a>);
00292                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00293                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00294                         <span class="comment">// return DbjGetErrorCode();</span>
00295                 }
00296                 
00297                 <span class="comment">// Freigeben</span>
00298                 error = <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(header);
00299                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00300                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00301                         <span class="comment">// return DbjGetErrorCode();</span>
00302                 }
00303         }
00304         
<a name="l00308"></a><a class="code" href="class_dbj_hash_index.html#d1">00308</a>         <a class="code" href="class_dbj_hash_index.html#d0">DbjHashIndex</a>(<a class="code" href="group__tableid.html#ga5">IndexId</a> idxId) {
00309                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00310                 
00311                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00312                 <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header = NULL;
00313                 <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets = NULL;
00314                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> rootPage;
00315                 
00316                 <span class="comment">// Werte setzen</span>
00317                 <a class="code" href="class_dbj_index_wrapper.html#b0">setIndexId</a>(idxId);
00318                 
00319                 <span class="comment">// Wurzelseite ermitteln</span>
00320                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a4">getRootPageId</a>(&amp;rootPage);
00321                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00322                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00323                         <span class="comment">// return DbjGetErrorCode();</span>
00324                 }
00325                 
00326                 <span class="comment">// Werte auslesen</span>
00327                 error = <a class="code" href="class_dbj_hash_index.html#d3">getBuckets</a>(rootPage, header, buckets);
00328                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00329                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00330                         <span class="comment">// return DbjGetErrorCode();</span>
00331                 }
00332                 this-&gt;<a class="code" href="class_dbj_hash_index.html#r0">unique</a> = header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o2">unique</a>;
00333                 
00334                 <span class="comment">// Freigeben</span>
00335                 error = <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(header);
00336                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00337                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00338                         <span class="comment">// return DbjGetErrorCode();</span>
00339                 }
00340         }
00341         
<a name="l00345"></a><a class="code" href="class_dbj_hash_index.html#d2">00345</a>         <span class="keyword">virtual</span> <a class="code" href="class_dbj_hash_index.html#d2">~DbjHashIndex</a>() {
00346         
00347         }
00348 
<a name="l00352"></a><a class="code" href="class_dbj_hash_index.html#d3">00352</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#d3">getBuckets</a>(<a class="code" href="group__id__datatypes.html#ga1">PageId</a> pageId, <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header, <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets) {
00353                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00354                 
00355                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00356                 <a class="code" href="class_dbj_buffer_manager.html">DbjBufferManager</a> *buffer = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00357                 <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00358                 
00359                 <span class="comment">// Seite laden</span>
00360                 error = buffer-&gt;<a class="code" href="class_dbj_buffer_manager.html#a4">getPage</a>(<a class="code" href="class_dbj_index_wrapper.html#a1">getSegmentId</a>(), pageId, DbjBufferManager::HashIndexPage, page);
00361                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00362                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00363                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00364                 }
00365                 
00366                 <span class="comment">// Daten lesen</span>
00367                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pageData = page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>();
00368                 header = reinterpret_cast&lt;HashHeader *&gt;(pageData);
00369                 buckets = reinterpret_cast&lt;Buckets *&gt;(header + 1);
00370                 
00371                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00372         }
00373         
<a name="l00377"></a><a class="code" href="class_dbj_hash_index.html#d4">00377</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#d4">createBuckets</a>(<span class="keywordtype">bool</span> uniq, <a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header, <a class="code" href="struct_dbj_hash_index_1_1_buckets.html">Buckets</a> *buckets) {
00378                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00379                 
00380                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00381                 <a class="code" href="class_dbj_buffer_manager.html">DbjBufferManager</a> *buffer = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00382                 <a class="code" href="class_dbj_page.html">DbjPage</a> *page = NULL;
00383                 <a class="code" href="group__id__datatypes.html#ga1">PageId</a> newPage = 0;
00384                 
00385                 <span class="comment">// neue SeitenID ermitteln</span>
00386                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a0">next</a>(&amp;newPage, DbjBufferManager::HashIndexPage);
00387                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00388                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00389                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00390                 }
00391                 
00392                 <span class="comment">// neue Seite generieren</span>
00393                 error = buffer-&gt;<a class="code" href="class_dbj_buffer_manager.html#a5">getNewPage</a>(<a class="code" href="class_dbj_index_wrapper.html#a1">getSegmentId</a>(), newPage, DbjBufferManager::HashIndexPage, page);
00394                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00395                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00396                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00397                 }
00398                 
00399                 <span class="comment">// Buckets generieren</span>
00400                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pageData = page-&gt;<a class="code" href="class_dbj_page.html#a3">getPageData</a>();
00401                 header = reinterpret_cast&lt;HashHeader *&gt;(pageData);
00402                 buckets = reinterpret_cast&lt;Buckets *&gt;(header + 1);
00403                 
00404                 <span class="comment">// Header setzen</span>
00405                 header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a> = page-&gt;<a class="code" href="class_dbj_page.html#a1">getPageId</a>();
00406                 header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o1">nextHashSegment</a> = 0;
00407                 header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o2">unique</a> = uniq;
00408                 
00409                 <span class="comment">// Buckets initialisieren</span>
00410                 <span class="keywordflow">for</span>(<a class="code" href="group__int__datatypes.html#ga15">Uint32</a> i=0; i&lt;((DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a>)) / <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a>)); i++) {
00411                         buckets-&gt;<a class="code" href="struct_dbj_hash_index_1_1_buckets.html#o0">bucket</a>[i].<a class="code" href="struct_dbj_hash_index_1_1_bucket.html#o0">elements</a> = 0;
00412                 }
00413                 
00414                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00415         }
00416         
<a name="l00420"></a><a class="code" href="class_dbj_hash_index.html#d5">00420</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header) {
00421                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00422                 
00423                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00424                 <a class="code" href="class_dbj_buffer_manager.html">DbjBufferManager</a> *buffer = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00425                 
00426                 <span class="comment">// Seite freigeben</span>
00427                 error = buffer-&gt;<a class="code" href="class_dbj_buffer_manager.html#a6">releasePage</a>(<a class="code" href="class_dbj_index_wrapper.html#a1">getSegmentId</a>(), header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a>);
00428                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00429                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00430                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00431                 }
00432                 
00433                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00434         }
00435         
<a name="l00439"></a><a class="code" href="class_dbj_hash_index.html#d6">00439</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#d6">dropBuckets</a>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header) {
00440                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00441                 
00442                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00443                 <a class="code" href="class_dbj_buffer_manager.html">DbjBufferManager</a> *buffer = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00444                 
00445                 <span class="comment">// Seite freigeben</span>
00446                 error = <a class="code" href="class_dbj_hash_index.html#d5">freeBuckets</a>(header);
00447                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00448                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00449                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00450                 }
00451                 
00452                 <span class="comment">// Seite als ungenutzt markieren</span>
00453                 error = <a class="code" href="class_dbj_index_wrapper.html#a2">getFreeSpaceMap</a>()-&gt;<a class="code" href="class_dbj_i_m_free_space_map.html#a1">freePage</a>(header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a>);
00454                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00455                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00456                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00457                 }
00458                 
00459                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00460         }
00461 
<a name="l00465"></a><a class="code" href="class_dbj_hash_index.html#d7">00465</a>         <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> <a class="code" href="class_dbj_hash_index.html#d7">saveBuckets</a>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a> *header) {
00466                 <a class="code" href="group__trace__def.html#ga0">DBJ_TRACE_ENTRY</a>();
00467                 
00468                 <a class="code" href="_dbj_error_codes_8hpp.html#a99">DbjErrorCode</a> error;
00469                 <a class="code" href="class_dbj_buffer_manager.html">DbjBufferManager</a> *buffer = <a class="code" href="class_dbj_buffer_manager.html#e0">DbjBufferManager::getInstance</a>();
00470                 
00471                 <span class="comment">// Seite freigeben</span>
00472                 error = buffer-&gt;<a class="code" href="class_dbj_buffer_manager.html#a7">markAsModified</a>(<a class="code" href="class_dbj_index_wrapper.html#a1">getSegmentId</a>(), header-&gt;<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html#o0">pageId</a>);
00473                 <span class="keywordflow">if</span>(error != <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>) {
00474                         <a class="code" href="_dbj_error_8hpp.html#a8">DBJ_TRACE_ERROR</a>();
00475                         <span class="keywordflow">return</span> <a class="code" href="_dbj_error_8hpp.html#a11">DbjGetErrorCode</a>();
00476                 }
00477                 
00478                 <span class="keywordflow">return</span> <a class="code" href="_dbj_error_codes_8hpp.html#a99a1">DBJ_SUCCESS</a>;
00479         }
00480         
<a name="l00484"></a><a class="code" href="class_dbj_hash_index.html#d8">00484</a>         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> <a class="code" href="class_dbj_hash_index.html#d8">computeHash</a>(<a class="code" href="struct_dbj_index_key.html">DbjIndexKey</a> <span class="keyword">const</span> *key) {
00485                 <span class="keywordflow">if</span>(key-&gt;<a class="code" href="struct_dbj_index_key.html#o0">dataType</a> == <a class="code" href="group__datatypes.html#gga0a33">INTEGER</a>) {
00486                         <span class="keywordflow">return</span> (key-&gt;<a class="code" href="struct_dbj_index_key.html#o1">intKey</a> % ((DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a>)) / <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a>)));
00487                 } <span class="keywordflow">else</span> {
00488                         <a class="code" href="group__int__datatypes.html#ga9">Uint16</a> tmp = 0;
00489                 
00490                         <span class="keywordflow">return</span> (tmp % ((DBJ_PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_hash_header.html">HashHeader</a>)) / <span class="keyword">sizeof</span>(<a class="code" href="struct_dbj_hash_index_1_1_bucket.html">Bucket</a>)));
00491                 }
00492         }       
00493         
00494         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="class_dbj_index_manager.html">DbjIndexManager</a>;
00495 };
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jan 3 10:00:50 2005 for Jenas Datenbanksystem 'System J' by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
